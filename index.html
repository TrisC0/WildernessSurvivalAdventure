<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wilderness Survival</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Press Start 2P', cursive;
            background-color: #2c2c2c;
            color: #e0e0e0;
            overflow: hidden; /* Prevent scrolling */
        }
        canvas {
            background-color: #3a5941;
            cursor: crosshair;
            image-rendering: pixelated; /* Sharp pixels for pixel art */
            width: 100%;
            height: 100%;
        }
        .ui-panel {
            background-color: rgba(0, 0, 0, 0.7);
            border: 2px solid #5a5a5a;
            border-radius: 8px;
            padding: 10px;
        }
        .stat-bar-bg {
            background-color: #4a4a4a;
            border-radius: 9999px;
            overflow: hidden;
            border: 1px solid #6a6a6a;
        }
        .stat-bar {
            height: 100%;
            border-radius: 9999px;
            transition: width 0.3s ease-in-out;
        }
        .craft-button, .tab-button {
            border: 2px solid #5a5a5a;
            background-color: #3c3c3c;
            transition: all 0.2s;
        }
        .craft-button:hover:not(:disabled), .tab-button:hover {
            background-color: #4c4c4c;
            border-color: #7a7a7a;
        }
        .craft-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .tab-button.active {
            background-color: #6c6c6c;
            border-color: #9a9a9a;
        }
        .message-log {
            min-height: 80px;
            overflow-y: auto;
            font-size: 10px;
            line-height: 1.4;
            flex: 1;
        }
        .game-over-screen, .intro-screen, .victory-screen {
            background-color: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(5px);
        }
        .hidden-tab {
            display: none;
        }
        
        /* Gameplay message overlay styling */
        #gameplayMessages div {
            background-color: rgba(0, 0, 0, 0.7);
            padding: 4px 8px;
            border-radius: 4px;
            margin-bottom: 2px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(2px);
            transition: opacity 0.3s ease-out, background-color 0.3s ease-out;
        }
    </style>
</head>
<body class="bg-black text-white flex flex-col h-screen p-2 md:p-4 gap-2 md:gap-4">


    <!-- Main Content -->
    <main class="flex-grow flex flex-col md:flex-row gap-2 md:gap-4 overflow-hidden">
        
        <!-- Left Panel: Other UI -->
        <aside class="w-full md:w-64 lg:w-80 ui-panel flex flex-col overflow-y-auto order-1 md:order-1 flex-shrink-0">
            <h1 class="text-xl text-yellow-400 text-center mb-4">Survival</h1>
            
            <!-- Quest Log -->
            <div class="mb-4">
                <h2 class="text-lg text-yellow-400 mb-2 text-center">OBJECTIVE</h2>
                <div id="questLog" class="text-xs bg-gray-900 p-2 rounded text-cyan-300">Survive the crash. Find a way to signal for help.</div>
            </div>

            <!-- Actions Panel -->
            <div class="mb-4">
                <h2 class="text-lg text-yellow-400 mb-2 text-center">ACTIONS</h2>
                <div class="flex mb-2">
                    <button id="tabCraft" class="tab-button active w-1/2 p-2 rounded-l-md text-xs">Craft</button>
                    <button id="tabBasic" class="tab-button w-1/2 p-2 rounded-r-md text-xs">Food</button>
                </div>
                <!-- Crafting Tab -->
                <div id="craftingContent">
                    <div class="grid grid-cols-2 gap-2 text-xs">
                        <button id="craftAxe" class="craft-button p-2 rounded">Wood Axe (15W)</button>
                        <button id="craftPickaxe" class="craft-button p-2 rounded">Wood Pick (20W)</button>
                        <button id="craftSword" class="craft-button p-2 rounded">Sword (25W)</button>
                        <button id="craftCarvedStone" class="craft-button p-2 rounded">Carved Stone (50S)</button>
                        <button id="craftCampfire" class="craft-button p-2 rounded">Fire (15W, 5S)</button>
                        <button id="craftTent" class="craft-button p-2 rounded">Tent (20W, 10S)</button>
                    </div>
                    <div class="text-center text-xs mt-2">Tools: <span id="toolStatus">None</span></div>
                </div>
                 <!-- Food Actions Tab -->
                <div id="basicActionsContent" class="hidden-tab">
                     <div class="grid grid-cols-2 gap-2 text-xs">
                         <button id="eatBerry" class="w-full craft-button p-2 rounded">Eat Berry</button>
                         <button id="eatCookedMeat" class="w-full craft-button p-2 rounded">Eat Meat</button>
                         <button id="cookMeat" class="w-full craft-button p-2 rounded col-span-2 mt-2">Cook Meat (at fire)</button>
                    </div>
                </div>
            </div>

            <!-- Backpack Section -->
            <div class="mb-4">
                <h2 class="text-lg text-yellow-400 mb-2 text-center">INVENTORY</h2>
                <button id="backpackButton" class="w-full craft-button p-3 rounded text-sm font-mono">
                    üéí Open Backpack
                </button>
            </div>
        </aside>

        <!-- Right Panel: Game Canvas -->
        <div class="flex-grow flex items-center justify-center order-2 md:order-2 overflow-hidden relative">
            <div class="w-full h-full border-4 border-gray-800 rounded-lg shadow-2xl">
                <canvas id="gameCanvas" tabindex="0"></canvas>
            </div>
            
            <!-- Mini Map Overlay -->
            <div id="miniMapOverlay" class="absolute top-4 -right-96 bg-gray-900 bg-opacity-90 p-2 rounded-l border border-gray-600 border-r-0 transition-all duration-300">
                <div class="relative">
                    <canvas id="miniMap" class="block"></canvas>
                    <div id="miniMapIndicator" class="absolute top-1 left-1 text-red-500 font-bold text-xs bg-black bg-opacity-50 px-1 rounded">(M)</div>
                </div>
                <div id="miniMapLegend" class="text-xs text-center mt-2 text-gray-400">
                    <span class="inline-block w-3 h-3 bg-purple-500 mr-2"></span>You
                    <span class="inline-block w-3 h-3 bg-blue-500 mx-2"></span>Wizard
                    <span class="inline-block w-3 h-3 bg-red-500 mx-2"></span>Animals
                    <span class="inline-block w-3 h-3 bg-yellow-500 mx-2"></span>Monoliths
                </div>
                <div id="miniMapInstructions" class="text-xs text-center mt-1 text-gray-500">
                    Press M for fullscreen
                </div>
            </div>
            
            <!-- Gameplay Message Overlay -->
            <div id="gameplayMessages" class="absolute bottom-4 left-4 right-4 pointer-events-none">
                <div id="message1" class="text-white text-sm mb-1 opacity-0 transition-opacity duration-500 font-mono"></div>
                <div id="message2" class="text-white text-sm mb-1 opacity-0 transition-opacity duration-500 font-mono"></div>
                <div id="message3" class="text-white text-sm mb-1 opacity-0 transition-opacity duration-500 font-mono"></div>
                <div id="message4" class="text-white text-sm mb-1 opacity-0 transition-opacity duration-500 font-mono"></div>
            </div>
            
            <!-- Chat History Button -->
            <div class="absolute bottom-4 left-4 pointer-events-auto">
                <button id="chatHistoryButton" class="bg-gray-800 hover:bg-gray-700 text-white text-xs px-3 py-1 rounded border border-gray-600 transition-colors duration-200 font-mono">
                    [Chat History]
                </button>
            </div>
            
            <!-- Level Up Cards Overlay -->
            <div id="levelUpOverlay" class="absolute inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
                <div class="bg-gray-900 p-6 rounded-lg border border-gray-600 max-w-4xl w-full mx-4">
                    <h2 class="text-2xl font-bold text-center text-yellow-400 mb-6">üéâ LEVEL UP! Choose Your Enhancement üéâ</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div id="card1" class="level-up-card bg-gray-800 p-4 rounded-lg border border-gray-600 cursor-pointer hover:border-yellow-400 transition-all duration-200">
                            <div class="text-center">
                                <div id="card1-icon" class="text-4xl mb-2">üí™</div>
                                <h3 id="card1-title" class="text-lg font-bold text-white mb-2">Strength</h3>
                                <p id="card1-description" class="text-gray-300 text-sm">+2 Damage</p>
                            </div>
                        </div>
                        <div id="card2" class="level-up-card bg-gray-800 p-4 rounded-lg border border-gray-600 cursor-pointer hover:border-yellow-400 transition-all duration-200">
                            <div class="text-center">
                                <div id="card2-icon" class="text-4xl mb-2">‚ù§Ô∏è</div>
                                <h3 id="card2-title" class="text-lg font-bold text-white mb-2">Vitality</h3>
                                <p id="card2-description" class="text-gray-300 text-sm">+20 Max Health</p>
                            </div>
                        </div>
                        <div id="card3" class="level-up-card bg-gray-800 p-4 rounded-lg border border-gray-600 cursor-pointer hover:border-yellow-400 transition-all duration-200">
                            <div class="text-center">
                                <div id="card3-icon" class="text-4xl mb-2">‚ö°</div>
                                <h3 id="card3-title" class="text-lg font-bold text-white mb-2">Endurance</h3>
                                <p id="card3-description" class="text-gray-300 text-sm">+20 Max Energy</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Bottom Bar: Stats & Time -->
    <footer class="ui-panel flex-shrink-0">
         <div class="flex flex-col md:flex-row justify-between items-center gap-4">
            <!-- Stats -->
            <div class="w-full md:w-3/4 grid grid-cols-1 md:grid-cols-4 gap-3">
                <div>
                    <span class="text-sm">‚ù§Ô∏è HEALTH</span>
                    <div class="stat-bar-bg h-4"><div id="healthBar" class="stat-bar bg-red-500" style="width: 100%;"></div></div>
                </div>
                <div>
                    <span class="text-sm">üçñ HUNGER</span>
                    <div class="stat-bar-bg h-4"><div id="hungerBar" class="stat-bar bg-yellow-500" style="width: 100%;"></div></div>
                </div>
                <div>
                    <span class="text-sm">‚ö° ENERGY</span>
                    <div class="stat-bar-bg h-4"><div id="energyBar" class="stat-bar bg-blue-500" style="width: 100%;"></div></div>
                </div>
                <div>
                    <span class="text-sm">‚≠ê LEVEL <span id="levelDisplay">1</span></span>
                    <div class="text-xs text-green-400 mb-1">XP: <span id="xpDisplay">0</span></div>
                    <div class="stat-bar-bg h-2"><div id="xpBar" class="stat-bar bg-green-500" style="width: 0%;"></div></div>
                </div>
            </div>
            <!-- Time -->
            <div class="w-full md:w-auto text-center p-2 bg-gray-900 rounded-md flex-shrink-0">
                <div id="timeDisplay" class="text-lg text-cyan-300">Day 1 - 07:00</div>
                <div id="seasonDisplay" class="text-xs text-green-400">Spring</div>
            </div>
        </div>
    </footer>
    
    <!-- Intro Screen -->
    <div id="introScreen" class="absolute inset-0 flex flex-col items-center justify-center intro-screen text-center p-8">
        <h1 class="text-4xl text-yellow-400 mb-4">The Lost Expedition</h1>
        <div class="max-w-2xl">
            <p class="text-lg text-white mb-8">Your research plane has crashed in an uncharted wilderness. The radio is broken. Looking at your notes, you remember this region is known for strange monoliths that emit a powerful energy. If you can find and reactivate them, the energy surge might be enough to signal for rescue.</p>
        </div>
        <button id="startButton" class="craft-button text-2xl py-4 px-8 rounded">Begin Survival</button>
    </div>

    <!-- Game Over Screen -->
    <div id="gameOverScreen" class="hidden absolute inset-0 flex-col items-center justify-center game-over-screen">
        <h1 class="text-6xl text-red-600 mb-4">GAME OVER</h1>
        <p id="gameOverReason" class="text-xl text-white mb-8">You have perished.</p>
        <button onclick="window.location.reload()" class="craft-button text-2xl py-4 px-8 rounded">Retry</button>
    </div>

    <!-- Victory Screen -->
    <div id="victoryScreen" class="hidden absolute inset-0 flex-col items-center justify-center victory-screen text-center">
        <h1 class="text-6xl text-green-500 mb-4">RESCUED!</h1>
        <p class="text-xl text-white mb-8">The monoliths flare to life, sending a beam of pure energy into the sky. You've done it! A rescue team will find you soon.</p>
        <button onclick="window.location.reload()" class="craft-button text-2xl py-4 px-8 rounded">Play Again</button>
    </div>

    <!-- Chat History Modal -->
    <div id="chatHistoryModal" class="hidden absolute inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-gray-900 p-6 rounded-lg border border-gray-600 max-w-4xl w-full mx-4 max-h-96 flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-yellow-400">Chat History</h2>
                <button id="closeChatHistory" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div id="chatHistoryContent" class="flex-grow overflow-y-auto bg-gray-800 p-4 rounded border border-gray-600 font-mono text-sm text-gray-300">
                <!-- Chat messages will be populated here -->
            </div>
        </div>
    </div>

    <!-- Backpack Modal -->
    <div id="backpackModal" class="hidden absolute inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-gray-900 p-6 rounded-lg border border-gray-600 max-w-4xl w-full mx-4 max-h-96 flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-yellow-400">üéí Backpack</h2>
                <button id="closeBackpack" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div id="backpackContent" class="flex-grow overflow-y-auto bg-gray-800 p-4 rounded border border-gray-600">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                    <!-- Inventory items will be populated here -->
                </div>
            </div>
        </div>
    </div>


<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const miniMap = document.getElementById('miniMap');
const miniMapCtx = miniMap.getContext('2d');

// Polyfill for roundRect if not available
if (!ctx.roundRect) {
    ctx.roundRect = function(x, y, width, height, radius) {
        this.beginPath();
        this.moveTo(x + radius, y);
        this.lineTo(x + width - radius, y);
        this.quadraticCurveTo(x + width, y, x + width, y + radius);
        this.lineTo(x + width, y + height - radius);
        this.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
        this.lineTo(x + radius, y + height);
        this.quadraticCurveTo(x, y + height, x, y + height - radius);
        this.lineTo(x, y + radius);
        this.quadraticCurveTo(x, y, x + radius, y);
        this.closePath();
    };
}

// UI Elements
const healthBar = document.getElementById('healthBar');
const hungerBar = document.getElementById('hungerBar');
const energyBar = document.getElementById('energyBar');
const xpBar = document.getElementById('xpBar');
const xpDisplay = document.getElementById('xpDisplay');
const levelDisplay = document.getElementById('levelDisplay');
const timeDisplay = document.getElementById('timeDisplay');
const toolStatusUI = document.getElementById('toolStatus');
const questLog = document.getElementById('questLog');
const introScreen = document.getElementById('introScreen');
const startButton = document.getElementById('startButton');
const gameOverScreen = document.getElementById('gameOverScreen');
const gameOverReason = document.getElementById('gameOverReason');
const victoryScreen = document.getElementById('victoryScreen');

// Gameplay message overlay elements
const gameplayMessage1 = document.getElementById('message1');
const gameplayMessage2 = document.getElementById('message2');
const gameplayMessage3 = document.getElementById('message3');
const gameplayMessage4 = document.getElementById('message4');

// --- Game Configuration ---
const TILE_SIZE = 64;
const MAP_SIZE = 110; // Increased map size for a larger world
let viewportTileCountX = 11;
let viewportTileCountY = 11;

const TILES = {
    GRASS: 0,
    TREE: 1,
    ROCK: 2,
    BERRY_BUSH: 3,
    WATER: 4,
    CAMPFIRE: 5,
    TENT: 6,
    STUMP: 7,
    MINED_ROCK: 8,
    EMPTY_BUSH: 9,
    MOONPETAL_FLOWER: 10,
    MONOLITH: 11,
    MONOLITH_ACTIVATED: 12,
    MOUNTAIN: 13,
    WIZARD: 14,
    RABBIT: 15,
    DEER: 16,
    SQUIRREL: 17,
};

const TILE_COLORS = {
    [TILES.GRASS]: '#5a8b41',
    [TILES.WATER]: '#4a90e2',
    [TILES.TREE]: '#3a5941',
    [TILES.ROCK]: '#8d8d8d',
    [TILES.BERRY_BUSH]: '#c56183',
    [TILES.CAMPFIRE]: '#ff8c00',
    [TILES.TENT]: '#a0522d',
    [TILES.STUMP]: '#6b4f3a',
    [TILES.MINED_ROCK]: '#6a6a6a',
    [TILES.EMPTY_BUSH]: '#71845a',
    [TILES.MOONPETAL_FLOWER]: '#a188d9',
    [TILES.MONOLITH]: '#4a5568',
    [TILES.MONOLITH_ACTIVATED]: '#f6e05e',
    [TILES.MOUNTAIN]: '#6b7280',
    [TILES.WIZARD]: '#808080',
    [TILES.RABBIT]: '#d4a574',
    [TILES.DEER]: '#8b4513',
    [TILES.SQUIRREL]: '#a0522d',
};


// --- Game State ---
let gameState = {
    paused: true,
    player: {
        x: Math.floor(MAP_SIZE / 2),
        y: Math.floor(MAP_SIZE / 2),
        health: 100,
        hunger: 100,
        energy: 100,
        direction: 'down',
        isMoving: false,
        moveCooldown: 0,
    },
    camera: {
        x: 0,
        y: 0,
    },
    inventory: {
        wood: 0,
        stone: 0,
        berries: 0,
        rawMeat: 0,
        cookedMeat: 0,
        gems: 0,
        petals: 0,
        carvedStone: 0,
        // Loot items
        fur: 0,
        bone: 0,
        herbs: 0,
        claw: 0,
        fang: 0,
        leather: 0,
        ore: 0,
        potion: 0,
        hide: 0,
        elixir: 0,
        crystal: 0,
    },
    xp: 0,
    level: 1,
    tools: {
        axe: false,
        pickaxe: false,
        sword: false,
    },
    quest: {
        monolithsActivated: 0,
        totalMonoliths: 3,
    },
    world: [],
    animals: [],
    wizard: {
        x: 0,
        y: 0,
        direction: 'down',
        isMoving: false,
        walkCycle: 0,
        lastInteraction: 0,
        speechBubble: {
            visible: false,
            message: '',
            timer: 0,
            maxTimer: 180, // 3 seconds at 60fps
        },
        calloutMessages: [
            "Come here, young one!",
            "I have wisdom to share!",
            "The ancient secrets await!",
            "Seek my counsel, traveler!",
            "The monoliths call to you!"
        ],
    },
    newAnimals: {
        rabbits: [],
        deer: [],
        squirrels: [],
    },
    time: {
        day: 1,
        hour: 7,
        minute: 0,
        animalSpawnTimer: 200,
    },
    playerAnimation: {
        walkCycle: 0,
        toolSwing: 0, 
    },
    isNight: false,
    isGameOver: false,
    placedObjects: {}, 
    worldObjects: {}, 
    activeAnimations: [],
    gameplayMessages: [],
    miniMapFullscreen: false,
    levelUpCards: {
        visible: false,
        cards: [],
    },
    playerModifiers: {
        healthBonus: 0,
        energyBonus: 0,
        strengthBonus: 0,
    },
    // Loot system
    lootItems: {
        // Common items (squirrels, rabbits)
        common: [
            { name: 'Small Fur', type: 'fur', amount: 1, description: 'Soft animal fur' },
            { name: 'Bone Fragment', type: 'bone', amount: 1, description: 'Small bone piece' },
            { name: 'Wild Herbs', type: 'herbs', amount: 2, description: 'Medicinal herbs' },
            { name: 'Sharp Claw', type: 'claw', amount: 1, description: 'Sharp animal claw' }
        ],
        // Uncommon items (wolves)
        uncommon: [
            { name: 'Wolf Fur', type: 'fur', amount: 2, description: 'Thick wolf fur' },
            { name: 'Wolf Fang', type: 'fang', amount: 1, description: 'Sharp wolf fang' },
            { name: 'Leather Strip', type: 'leather', amount: 1, description: 'Tough leather' },
            { name: 'Iron Ore', type: 'ore', amount: 1, description: 'Raw iron ore' },
            { name: 'Healing Potion', type: 'potion', amount: 1, description: 'Restores health' }
        ],
        // Rare items (bears)
        rare: [
            { name: 'Bear Hide', type: 'hide', amount: 1, description: 'Thick bear hide' },
            { name: 'Bear Claw', type: 'claw', amount: 2, description: 'Massive bear claw' },
            { name: 'Ancient Gem', type: 'gem', amount: 1, description: 'Mystical gem' },
            { name: 'Iron Sword', type: 'weapon', amount: 1, description: 'Sharp iron blade' },
            { name: 'Health Elixir', type: 'elixir', amount: 1, description: 'Powerful healing' },
            { name: 'Magic Crystal', type: 'crystal', amount: 1, description: 'Glowing crystal' }
        ]
    },
};

// --- Game Logic ---

function logMessage(message, color = '#e0e0e0') {
    // Add to gameplay messages
    const timestamp = Date.now();
    gameState.gameplayMessages.push({ message, color, timestamp });
    
    // Keep only the last 50 messages for chat history
    if (gameState.gameplayMessages.length > 50) {
        gameState.gameplayMessages.shift();
    }
    
    updateGameplayMessages();
}

function checkLevelUp() {
    const xpNeeded = gameState.level * 25; // 25 XP per level
    if (gameState.xp >= xpNeeded) {
        gameState.level++;
        gameState.xp -= xpNeeded;
        showLevelUpCards();
        updateUI();
    }
}

function showLevelUpCards() {
    gameState.levelUpCards.visible = true;
    gameState.paused = true; // Pause the game during card selection
    
    // Generate three random cards
    const cardTypes = [
        { type: 'strength', icon: 'üí™', title: 'Strength', description: '+2 Damage', bonus: 2 },
        { type: 'vitality', icon: '‚ù§Ô∏è', title: 'Vitality', description: '+20 Max Health', bonus: 20 },
        { type: 'endurance', icon: '‚ö°', title: 'Endurance', description: '+20 Max Energy', bonus: 20 },
    ];
    
    // Shuffle and pick 3 cards
    const shuffled = cardTypes.sort(() => Math.random() - 0.5);
    gameState.levelUpCards.cards = shuffled.slice(0, 3);
    
    // Update card display
    for (let i = 0; i < 3; i++) {
        const card = gameState.levelUpCards.cards[i];
        document.getElementById(`card${i+1}-icon`).textContent = card.icon;
        document.getElementById(`card${i+1}-title`).textContent = card.title;
        document.getElementById(`card${i+1}-description`).textContent = card.description;
    }
    
    // Show overlay
    document.getElementById('levelUpOverlay').classList.remove('hidden');
}

function selectLevelUpCard(cardIndex) {
    const selectedCard = gameState.levelUpCards.cards[cardIndex];
    
    // Apply the bonus
    switch (selectedCard.type) {
        case 'strength':
            gameState.playerModifiers.strengthBonus += selectedCard.bonus;
            logMessage(`You chose Strength! +${selectedCard.bonus} damage bonus.`, '#fbbf24');
            break;
        case 'vitality':
            gameState.playerModifiers.healthBonus += selectedCard.bonus;
            gameState.player.health += selectedCard.bonus; // Also heal the player
            logMessage(`You chose Vitality! +${selectedCard.bonus} max health.`, '#fbbf24');
            break;
        case 'endurance':
            gameState.playerModifiers.energyBonus += selectedCard.bonus;
            gameState.player.energy += selectedCard.bonus; // Also restore energy
            logMessage(`You chose Endurance! +${selectedCard.bonus} max energy.`, '#fbbf24');
            break;
    }
    
    // Hide overlay and resume game
    document.getElementById('levelUpOverlay').classList.add('hidden');
    gameState.levelUpCards.visible = false;
    gameState.paused = false;
    
    logMessage(`üéâ You are now level ${gameState.level}!`, '#fbbf24');
    updateUI();
}

function checkWizardCallout() {
    if (gameState.wizard.x <= 0 || gameState.wizard.y <= 0) return;
    
    const distToPlayer = Math.sqrt(
        Math.pow(gameState.player.x - gameState.wizard.x, 2) + 
        Math.pow(gameState.player.y - gameState.wizard.y, 2)
    );
    
    // If player is within 6 tiles and speech bubble isn't visible
    if (distToPlayer <= 6 && !gameState.wizard.speechBubble.visible) {
        // Random chance to call out (about 1 in 300 frames = every 5 seconds)
        if (Math.random() < 0.003) {
            gameState.wizard.speechBubble.visible = true;
            gameState.wizard.speechBubble.message = gameState.wizard.calloutMessages[
                Math.floor(Math.random() * gameState.wizard.calloutMessages.length)
            ];
            gameState.wizard.speechBubble.timer = gameState.wizard.speechBubble.maxTimer;
        }
    }
    
    // Update speech bubble timer
    if (gameState.wizard.speechBubble.visible) {
        gameState.wizard.speechBubble.timer--;
        if (gameState.wizard.speechBubble.timer <= 0) {
            gameState.wizard.speechBubble.visible = false;
        }
    }
}

function updateGameplayMessages() {
    const messages = gameState.gameplayMessages;
    const now = Date.now();
    
    // Get the 4 most recent messages
    const recentMessages = messages.slice(-4);
    
    // Update message elements (oldest at top, newest at bottom)
    const messageElements = [gameplayMessage1, gameplayMessage2, gameplayMessage3, gameplayMessage4];
    
    messageElements.forEach((element, index) => {
        if (index < recentMessages.length) {
            // Reverse the order so newest messages appear at bottom
            const msg = recentMessages[recentMessages.length - 1 - index];
            const age = now - msg.timestamp;
            
            // Set message content and color
            element.textContent = msg.message;
            element.style.color = msg.color;
            
            // Calculate opacity based on age and position
            let opacity = 1.0;
            if (index === 0) { // 1st message (oldest visible - at top)
                opacity = Math.max(0.1, 1.0 - (age / 3000)); // Fade out over 3 seconds, minimum 10%
            } else if (index === 1) { // 2nd message
                opacity = Math.max(0.3, 1.0 - (age / 5000)); // Fade out over 5 seconds, minimum 30%
            } else if (index === 2) { // 3rd message
                opacity = Math.max(0.6, 1.0 - (age / 7000)); // Fade out over 7 seconds, minimum 60%
            } else { // 4th message (newest - at bottom)
                opacity = 1.0; // Always fully visible
            }
            
            element.style.opacity = opacity;
            
            // Also fade the background for older messages
            if (index === 0) { // Oldest message (at top)
                element.style.backgroundColor = `rgba(0, 0, 0, ${0.7 * opacity})`;
            } else if (index === 1) { // 2nd message
                element.style.backgroundColor = `rgba(0, 0, 0, ${0.7 * opacity})`;
            } else {
                element.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
            }
        } else {
            element.style.opacity = 0;
            element.style.backgroundColor = 'rgba(0, 0, 0, 0)';
        }
    });
}

function updateBackpack() {
    const backpackContent = document.getElementById('backpackContent');
    if (!backpackContent) return;
    
    // Clear existing content
    backpackContent.innerHTML = '';
    
    // Define all inventory items with their properties
    const inventoryItems = [
        { key: 'wood', name: 'Wood', icon: 'üå≤', count: gameState.inventory.wood },
        { key: 'stone', name: 'Stone', icon: '‚õèÔ∏è', count: gameState.inventory.stone },
        { key: 'berries', name: 'Berries', icon: 'üçì', count: gameState.inventory.berries },
        { key: 'rawMeat', name: 'Raw Meat', icon: 'ü•©', count: gameState.inventory.rawMeat },
        { key: 'gem', name: 'Gem', icon: 'üíé', count: gameState.inventory.gem },
        { key: 'petal', name: 'Petal', icon: 'üå∏', count: gameState.inventory.petal },
        { key: 'cookedMeat', name: 'Cooked Meat', icon: 'üî•', count: gameState.inventory.cookedMeat },
        { key: 'carvedStone', name: 'Carved Stone', icon: 'üóø', count: gameState.inventory.carvedStone },
        { key: 'fur', name: 'Fur', icon: 'ü¶å', count: gameState.inventory.fur },
        { key: 'bone', name: 'Bone', icon: 'ü¶¥', count: gameState.inventory.bone },
        { key: 'herbs', name: 'Herbs', icon: 'üåø', count: gameState.inventory.herbs },
        { key: 'claw', name: 'Claw', icon: 'üêæ', count: gameState.inventory.claw },
        { key: 'fang', name: 'Fang', icon: 'ü¶∑', count: gameState.inventory.fang },
        { key: 'leather', name: 'Leather', icon: 'üßµ', count: gameState.inventory.leather },
        { key: 'ore', name: 'Ore', icon: '‚ö°', count: gameState.inventory.ore },
        { key: 'potion', name: 'Potion', icon: 'üß™', count: gameState.inventory.potion },
        { key: 'hide', name: 'Hide', icon: 'üêª', count: gameState.inventory.hide },
        { key: 'elixir', name: 'Elixir', icon: 'üíä', count: gameState.inventory.elixir },
        { key: 'crystal', name: 'Crystal', icon: 'üíé', count: gameState.inventory.crystal }
    ];
    
    // Filter items that have count > 0
    const availableItems = inventoryItems.filter(item => item.count > 0);
    
    if (availableItems.length === 0) {
        backpackContent.innerHTML = '<div class="col-span-full text-center text-gray-400 py-8">Your backpack is empty</div>';
        return;
    }
    
    // Create grid container
    const grid = document.createElement('div');
    grid.className = 'grid grid-cols-2 md:grid-cols-4 gap-3 text-sm';
    
    // Add each item to the grid
    availableItems.forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'bg-gray-700 p-3 rounded border border-gray-600 text-center';
        itemDiv.innerHTML = `
            <div class="text-lg mb-1">${item.icon}</div>
            <div class="text-xs text-gray-300">${item.name}</div>
            <div class="text-xs text-yellow-400 font-bold">${item.count}</div>
        `;
        grid.appendChild(itemDiv);
    });
    
    backpackContent.appendChild(grid);
}

function updateQuestLog() {
    const activated = gameState.quest.monolithsActivated;
    const total = gameState.quest.totalMonoliths;
    if (activated < total) {
        questLog.textContent = `Activate the Monoliths (${activated}/${total}).`;
    } else {
        questLog.textContent = "Signal sent! You have been rescued!";
    }
}

function generateWorld() {
    // Start with a solid mountain map
    gameState.world = Array(MAP_SIZE).fill(null).map(() => Array(MAP_SIZE).fill(TILES.MOUNTAIN));
    gameState.worldObjects = {};

    let walker = { x: Math.floor(MAP_SIZE / 2), y: Math.floor(MAP_SIZE / 2) };
    const landTilesToGenerate = Math.floor(MAP_SIZE * MAP_SIZE * 0.75); // 75% of map is land
    let landGenerated = 0;

    // Random walk to carve out land
    while(landGenerated < landTilesToGenerate) {
        if (gameState.world[walker.y][walker.x] === TILES.MOUNTAIN) {
            gameState.world[walker.y][walker.x] = TILES.GRASS;
            landGenerated++;
        }

        const dir = Math.floor(Math.random() * 4);
        switch(dir) {
            case 0: walker.y--; break; // Up
            case 1: walker.y++; break; // Down
            case 2: walker.x--; break; // Left
            case 3: walker.x++; break; // Right
        }

        // Clamp walker to stay inside the mountain border
        walker.x = Math.max(1, Math.min(MAP_SIZE - 2, walker.x));
        walker.y = Math.max(1, Math.min(MAP_SIZE - 2, walker.y));
    }
    
    // Now, place resources only on grass tiles
    let grassTiles = [];
    for (let y = 0; y < MAP_SIZE; y++) {
        for (let x = 0; x < MAP_SIZE; x++) {
            if (gameState.world[y][x] === TILES.GRASS) {
                grassTiles.push({x, y});
            }
        }
    }

    // Shuffle grass tiles for random placement
    grassTiles.sort(() => 0.5 - Math.random());

    const numTrees = Math.floor(grassTiles.length * 0.2);
    const numRocks = Math.floor(grassTiles.length * 0.08);
    const numBushes = Math.floor(grassTiles.length * 0.04);

    for(let i = 0; i < grassTiles.length; i++) {
        const tile = grassTiles[i];
        const key = `${tile.x},${tile.y}`;
        const distToPlayer = Math.sqrt(Math.pow(tile.x - gameState.player.x, 2) + Math.pow(tile.y - gameState.player.y, 2));
        
        if (distToPlayer <= 2) continue; // Keep spawn area clear

        if (i < numTrees) {
             gameState.world[tile.y][tile.x] = TILES.TREE;
             gameState.worldObjects[key] = { type: TILES.TREE, health: 10 };
        } else if (i < numTrees + numRocks) {
            gameState.world[tile.y][tile.x] = TILES.ROCK;
            gameState.worldObjects[key] = { type: TILES.ROCK, health: 15 };
        } else if (i < numTrees + numRocks + numBushes) {
             gameState.world[tile.y][tile.x] = TILES.BERRY_BUSH;
        }
    }
    
    // Place Monoliths on distant grass tiles
    let monolithsPlaced = 0;
    for(let i = 0; i < grassTiles.length && monolithsPlaced < gameState.quest.totalMonoliths; i++) {
        const tile = grassTiles[i];
         const distToPlayer = Math.sqrt(Math.pow(tile.x - gameState.player.x, 2) + Math.pow(tile.y - gameState.player.y, 2));

        if(distToPlayer > 12) { // Place monoliths far away
            gameState.world[tile.y][tile.x] = TILES.MONOLITH;
            const requirements = ['gems', 'petals', 'carvedStone'];
            gameState.worldObjects[`${tile.x},${tile.y}`] = { 
                type: TILES.MONOLITH,
                requires: requirements[monolithsPlaced],
                amount: requirements[monolithsPlaced] === 'carvedStone' ? 1 : 5
            };
            monolithsPlaced++;
        }
    }
    
    // Place Wizard NPC
    let wizardPlaced = false;
    for(let i = 0; i < grassTiles.length && !wizardPlaced; i++) {
        const tile = grassTiles[i];
        const distToPlayer = Math.sqrt(Math.pow(tile.x - gameState.player.x, 2) + Math.pow(tile.y - gameState.player.y, 2));
        
        if(distToPlayer > 8 && distToPlayer < 15) { // Place wizard at medium distance
            gameState.world[tile.y][tile.x] = TILES.WIZARD;
            gameState.wizard.x = tile.x;
            gameState.wizard.y = tile.y;
            wizardPlaced = true;
            logMessage("You sense ancient magic nearby...", "#a188d9");
        }
    }
}

function getTileInFront() {
    let { x, y, direction } = gameState.player;
    switch (direction) {
        case 'up': y--; break;
        case 'down': y++; break;
        case 'left': x--; break;
        case 'right': x++; break;
    }
    return { x, y };
}

function interact() {
    const target = getTileInFront();
    if (target.x < 0 || target.x >= MAP_SIZE || target.y < 0 || target.y >= MAP_SIZE) return;

    // Combat
    const animal = gameState.animals.find(a => a.x === target.x && a.y === target.y);
    if (animal) {
        const baseDamage = gameState.tools.sword ? 5 : 2;
        const damage = baseDamage + gameState.playerModifiers.strengthBonus;
        animal.hp -= damage;
        animal.lastHitTimer = 30;
        logMessage(`You hit the ${animal.type} for ${damage} damage!`, '#e06c75');
        
        if (animal.hp <= 0) {
            let meatReward, xpReward;
            if (animal.type === 'squirrel') {
                meatReward = 1;
                xpReward = 3;
                logMessage(`You defeated the squirrel! You find ${meatReward} Raw Meat and gain ${xpReward} XP.`, '#98c379');
            } else if (animal.type === 'rabbit') {
                meatReward = 1;
                xpReward = 2;
                logMessage(`You defeated the rabbit! You find ${meatReward} Raw Meat and gain ${xpReward} XP.`, '#98c379');
            } else if (animal.type === 'bear') {
                meatReward = 5;
                xpReward = 10;
                logMessage(`You defeated the bear! You find ${meatReward} Raw Meat and gain ${xpReward} XP.`, '#98c379');
            } else {
                meatReward = 2;
                xpReward = 5;
                logMessage(`You defeated the wolf! You find ${meatReward} Raw Meat and gain ${xpReward} XP.`, '#98c379');
            }
            gameState.inventory.rawMeat += meatReward;
            gameState.xp += xpReward;
            
            // Drop loot based on animal type
            dropLoot(animal.type);
            
            gameState.animals = gameState.animals.filter(a => a !== animal);
            checkLevelUp();
        }
        gameState.playerAnimation.toolSwing = 15;
        return;
    }

    const tile = gameState.world[target.y][target.x];
    const targetKey = `${target.x},${target.y}`;
    let interactionDidDamage = false;
    
    switch (tile) {
        case TILES.TREE: {
            let tree = gameState.worldObjects[targetKey];
            if (!tree) {
                tree = { type: TILES.TREE, health: 10 };
                gameState.worldObjects[targetKey] = tree;
            }
            const damage = gameState.tools.axe ? 5 : 1;
            tree.health -= damage;
            depleteEnergy(gameState.tools.axe ? (1.5 / 12) : (1 / 12));
            gameState.activeAnimations.push({ x: target.x, y: target.y, type: 'chop', progress: 0, maxProgress: 20 });
            interactionDidDamage = true;
            if (tree.health <= 0) {
                gameState.inventory.wood += 5;
                gameState.world[target.y][target.x] = TILES.STUMP;
                delete gameState.worldObjects[targetKey];
                gameState.xp += 1; // XP for chopping down a tree
                logMessage(`You felled the tree and got 5 wood. (+1 XP)`, '#98c379');
                checkLevelUp();
            } else {
                logMessage(`You chop at the tree. (${tree.health}/10)`, '#e5c07b');
            }
            break;
        }
        case TILES.ROCK: {
            if (gameState.tools.pickaxe) {
                let rock = gameState.worldObjects[targetKey];
                if (!rock) {
                    rock = { type: TILES.ROCK, health: 15 };
                    gameState.worldObjects[targetKey] = rock;
                }
                const damage = 5;
                rock.health -= damage;
                depleteEnergy(8 / 36);
                gameState.activeAnimations.push({ x: target.x, y: target.y, type: 'mine', progress: 0, maxProgress: 20 });
                interactionDidDamage = true;
                
                if (rock.health <= 0) {
                    gameState.inventory.stone += 5;
                    gameState.world[target.y][target.x] = TILES.MINED_ROCK;
                    delete gameState.worldObjects[targetKey];
                    gameState.xp += 2; // XP for successful mining
                    logMessage(`You broke the rock and got 5 stone. (+2 XP)`, '#98c379');
                    if (Math.random() < 0.1) { // 10% chance for a gem
                        gameState.inventory.gems++;
                        gameState.xp += 5; // Bonus XP for finding a gem
                        logMessage(`You found a rare gem! (+5 XP)`, '#61afef');
                    }
                    checkLevelUp();
                } else {
                    logMessage(`You strike the rock. (${rock.health}/15)`, '#c7c07b');
                }
            } else {
                logMessage("You need a pickaxe to mine this.", '#e06c75');
            }
            break;
        }
        case TILES.BERRY_BUSH: {
            gameState.inventory.berries += 3;
            gameState.world[target.y][target.x] = TILES.EMPTY_BUSH;
            logMessage(`You found 3 berries.`, '#c56183');
            break;
        }
        case TILES.MOONPETAL_FLOWER: {
            gameState.inventory.petals++;
            gameState.world[target.y][target.x] = TILES.GRASS;
            logMessage(`You carefully picked a glowing Moonpetal.`, '#a188d9');
            break;
        }
        case TILES.MONOLITH: {
            const monolith = gameState.worldObjects[targetKey];
            if (monolith) {
                if (gameState.inventory[monolith.requires] >= monolith.amount) {
                    gameState.inventory[monolith.requires] -= monolith.amount;
                    gameState.world[target.y][target.x] = TILES.MONOLITH_ACTIVATED;
                    delete gameState.worldObjects[targetKey];
                    gameState.quest.monolithsActivated++;
                    logMessage("The monolith hums with power! It's active!", '#f6e05e');
                    updateQuestLog();
                    if (gameState.quest.monolithsActivated >= gameState.quest.totalMonoliths) {
                        victoryScreen.classList.remove('hidden');
                        victoryScreen.classList.add('flex');
                        gameState.paused = true;
                    }
                } else {
                    logMessage(`The monolith seems to require ${monolith.amount} ${monolith.requires}.`, '#e06c75');
                }
            }
            break;
        }
        case TILES.TENT: {
             if (gameState.isNight) {
                logMessage("You sleep until morning.", '#61afef');
                sleep();
             } else {
                logMessage("You can only sleep at night.", '#e06c75');
             }
             break;
        }
        case TILES.WIZARD: {
            const now = Date.now();
            if (now - gameState.wizard.lastInteraction > 5000) { // 5 second cooldown
                gameState.wizard.lastInteraction = now;
                const messages = [
                    "The ancient wizard studies you with wise eyes...",
                    "'The monoliths hold the key to your salvation, young one.'",
                    "'Seek the glowing petals that bloom only in moonlight.'",
                    "'The gems in the earth speak of ancient power.'",
                    "'Carve stone with purpose, for the monoliths demand tribute.'"
                ];
                const randomMessage = messages[Math.floor(Math.random() * messages.length)];
                logMessage(randomMessage, '#a188d9');
                
                // Give XP for seeking wisdom
                gameState.xp += 1;
                logMessage("You gain wisdom from the ancient wizard. (+1 XP)", '#a188d9');
                
                // Give a small reward
                if (Math.random() < 0.3) {
                    gameState.inventory.gems++;
                    gameState.xp += 3; // Bonus XP for receiving a gift
                    logMessage("The wizard gifts you a precious gem! (+3 XP)", '#61afef');
                }
                checkLevelUp();
            }
            break;
        }
    }
    
    if (interactionDidDamage) {
        gameState.playerAnimation.toolSwing = 15;
    }
}

let keysPressed = {};
function handleInput() {
    if (gameState.isGameOver || gameState.paused || gameState.player.moveCooldown > 0) return;
    
    // Clean up keysPressed object periodically to prevent memory leaks
    if (Object.keys(keysPressed).length > 10) {
        keysPressed = {};
    }
    const { player } = gameState;
    let newX = player.x;
    let newY = player.y;
    
    player.isMoving = false;

    // Handle 8-directional movement
    let moveX = 0;
    let moveY = 0;
    
    if (keysPressed['w'] || keysPressed['ArrowUp']) moveY--;
    if (keysPressed['s'] || keysPressed['ArrowDown']) moveY++;
    if (keysPressed['a'] || keysPressed['ArrowLeft']) moveX--;
    if (keysPressed['d'] || keysPressed['ArrowRight']) moveX++;
    
    if (moveX !== 0 || moveY !== 0) {
        player.isMoving = true;
        
        // Determine direction based on movement
        if (moveY < 0 && moveX === 0) player.direction = 'up';
        else if (moveY > 0 && moveX === 0) player.direction = 'down';
        else if (moveX < 0 && moveY === 0) player.direction = 'left';
        else if (moveX > 0 && moveY === 0) player.direction = 'right';
        else if (moveY < 0 && moveX < 0) player.direction = 'up_left';
        else if (moveY < 0 && moveX > 0) player.direction = 'up_right';
        else if (moveY > 0 && moveX < 0) player.direction = 'down_left';
        else if (moveY > 0 && moveX > 0) player.direction = 'down_right';
        
        newX += moveX;
        newY += moveY;
    } else {
        player.isMoving = false;
    }
    
    if (player.isMoving) {
        if (newX >= 0 && newX < MAP_SIZE && newY >= 0 && newY < MAP_SIZE) {
            const targetTile = gameState.world[newY][newX];
            // Check if there's an animal at the target position
            const animalAtTarget = gameState.animals.find(a => a.x === newX && a.y === newY);
            
            if (targetTile !== TILES.TREE && targetTile !== TILES.ROCK && targetTile !== TILES.WATER && targetTile !== TILES.MONOLITH && targetTile !== TILES.MOUNTAIN && !animalAtTarget) {
                player.x = newX;
                player.y = newY;
                player.moveCooldown = 5; // Add a short delay between steps
                depleteEnergy(0.2 / 12);
            }
        }
    }
}


function updateAnimations() {
    gameState.activeAnimations = gameState.activeAnimations.filter(anim => {
        anim.progress++;
        return anim.progress < anim.maxProgress;
    });

    const { playerAnimation, player } = gameState;
    if (player.isMoving) {
        playerAnimation.walkCycle = (playerAnimation.walkCycle + 0.25) % (Math.PI * 2);
    }
    
    if (playerAnimation.toolSwing > 0) {
        playerAnimation.toolSwing--;
    }
}

function gameOver(reason) {
    if (gameState.isGameOver) return;
    gameState.isGameOver = true;
    gameOverReason.textContent = reason;
    gameOverScreen.classList.remove('hidden');
    gameOverScreen.classList.add('flex');
}

function getRandomAnimalType() {
    // Weighted random selection: squirrels and rabbits common, wolves uncommon, bears rare
    const random = Math.random();
    if (random < 0.4) return 'squirrel';      // 40% chance - common
    if (random < 0.7) return 'rabbit';        // 30% chance - common  
    if (random < 0.9) return 'wolf';          // 20% chance - uncommon
    return 'bear';                            // 10% chance - rare
}

function spawnAnimals(count) {
    try {
        const maxAnimals = 12; // Further reduced to prevent crashes
        const currentAnimalCount = gameState.animals.length;
        if (currentAnimalCount >= maxAnimals) return;

        const numToSpawn = Math.min(count, maxAnimals - currentAnimalCount);

        for (let i = 0; i < numToSpawn; i++) {
            let x, y;
            let attempts = 0;
            do {
                x = Math.floor(Math.random() * MAP_SIZE);
                y = Math.floor(Math.random() * MAP_SIZE);
                attempts++;
                if (attempts > 50) break; // Prevent infinite loop
            } while (gameState.world[y][x] !== TILES.GRASS || (Math.abs(x-gameState.player.x) < 10 && Math.abs(y-gameState.player.y) < 10)); 
            
            if (attempts > 50) continue; // Skip this spawn if we can't find a valid location
            
            // Use weighted random selection for animal type
            const type = getRandomAnimalType();
            
            // Set different stats based on animal type
            let hp, maxHp;
            if (type === 'squirrel') {
                hp = 3;
                maxHp = 3;
            } else if (type === 'rabbit') {
                hp = 2;
                maxHp = 2;
            } else if (type === 'bear') {
                hp = 20;
                maxHp = 20;
            } else {
                hp = 10;
                maxHp = 10;
            }
            
            // Create animal object with pack properties for wolves
            const animalData = {
                x, 
                y, 
                type: type,
                state: 'wander',
                wanderTarget: { x: null, y: null },
                direction: 'down',
                isMoving: false,
                walkCycle: 0,
                hp: hp,
                maxHp: maxHp,
                lastHitTimer: 0,
            };
            
            // Add pack properties for wolves
            if (type === 'wolf') {
                animalData.packId = null; // Will be assigned when pack is formed
                animalData.isPackLeader = false;
                animalData.packTarget = { x: null, y: null };
                animalData.smellRange = 12; // Strong sense of smell
                animalData.lastSmellCheck = 0;
            }
            
            gameState.animals.push(animalData);
        }
    } catch (error) {
        console.error("Error in spawnAnimals:", error);
    }
}

function spawnInitialAnimals() {
    try {
        // Spawn 6-10 random animals at the beginning of the game for more wildlife
        const initialCount = 6 + Math.floor(Math.random() * 5); // 6-10 animals
        spawnAnimals(initialCount);
        logMessage(`The wilderness stirs with ${initialCount} creatures...`, '#e5c07b');
    } catch (error) {
        console.error("Error in spawnInitialAnimals:", error);
        logMessage("The wilderness remains quiet...", '#e5c07b');
    }
}


// Wolf Pack Management System
function formWolfPacks() {
    try {
        const wolves = gameState.animals.filter(animal => animal.type === 'wolf');
        const unassignedWolves = wolves.filter(wolf => !wolf.packId);
        
        // Group nearby wolves into packs
        unassignedWolves.forEach(wolf => {
            if (wolf.packId) return; // Already in a pack
            
            // Find nearby wolves within 8 tiles
            const nearbyWolves = wolves.filter(otherWolf => 
                otherWolf !== wolf && 
                !otherWolf.packId &&
                Math.abs(wolf.x - otherWolf.x) <= 8 && 
                Math.abs(wolf.y - otherWolf.y) <= 8
            );
            
            if (nearbyWolves.length > 0) {
                // Create a new pack
                const packId = `pack_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                
                // Make the first wolf the pack leader
                wolf.packId = packId;
                wolf.isPackLeader = true;
                
                // Add nearby wolves to the pack
                nearbyWolves.forEach(otherWolf => {
                    otherWolf.packId = packId;
                    otherWolf.isPackLeader = false;
                });
                
                logMessage(`A wolf pack forms in the wilderness...`, '#e5c07b');
            }
        });
    } catch (error) {
        console.error("Error in formWolfPacks:", error);
    }
}

function getPackMembers(packId) {
    return gameState.animals.filter(animal => animal.packId === packId);
}

function getPackLeader(packId) {
    return gameState.animals.find(animal => animal.packId === packId && animal.isPackLeader);
}

function coordinatePackHunting(wolf) {
    try {
        if (!wolf.packId) return;
        
        const packMembers = getPackMembers(wolf.packId);
        const packLeader = getPackLeader(wolf.packId);
        const player = gameState.player;
        
        if (!packLeader || packMembers.length < 2) return;
        
        // If this wolf is the pack leader, set the pack target
        if (wolf.isPackLeader) {
            const distToPlayer = Math.abs(wolf.x - player.x) + Math.abs(wolf.y - player.y);
            
            if (distToPlayer <= wolf.smellRange) {
                // Pack leader detected player, set target
                wolf.packTarget.x = player.x;
                wolf.packTarget.y = player.y;
                wolf.state = 'hunt';
                
                // Alert other pack members
                packMembers.forEach(member => {
                    if (member !== wolf) {
                        member.state = 'hunt';
                        member.packTarget.x = player.x;
                        member.packTarget.y = player.y;
                    }
                });
            }
        } else {
            // Follow pack leader's target
            if (packLeader.packTarget.x !== null && packLeader.packTarget.y !== null) {
                wolf.packTarget.x = packLeader.packTarget.x;
                wolf.packTarget.y = packLeader.packTarget.y;
                wolf.state = 'hunt';
            }
        }
    } catch (error) {
        console.error("Error in coordinatePackHunting:", error);
    }
}

function getPackAttackPosition(wolf, player) {
    try {
        if (!wolf.packId) return { x: player.x, y: player.y };
        
        const packMembers = getPackMembers(wolf.packId);
        const packLeader = getPackLeader(wolf.packId);
        
        if (!packLeader || packMembers.length < 2) {
            return { x: player.x, y: player.y };
        }
        
        // Get pack members that are in view (within screen bounds)
        const viewportLeft = Math.floor(gameState.camera.x / TILE_SIZE);
        const viewportRight = viewportLeft + viewportTileCountX;
        const viewportTop = Math.floor(gameState.camera.y / TILE_SIZE);
        const viewportBottom = viewportTop + viewportTileCountY;
        
        const visiblePackMembers = packMembers.filter(member => 
            member.x >= viewportLeft && member.x < viewportRight &&
            member.y >= viewportTop && member.y < viewportBottom
        );
        
        if (visiblePackMembers.length < 2) {
            return { x: player.x, y: player.y };
        }
        
        // Calculate attack positions around the player
        const attackPositions = [
            { x: player.x - 1, y: player.y },     // Left
            { x: player.x + 1, y: player.y },     // Right
            { x: player.x, y: player.y - 1 },     // Up
            { x: player.x, y: player.y + 1 },     // Down
            { x: player.x - 1, y: player.y - 1 }, // Up-left
            { x: player.x + 1, y: player.y - 1 }, // Up-right
            { x: player.x - 1, y: player.y + 1 }, // Down-left
            { x: player.x + 1, y: player.y + 1 }  // Down-right
        ];
        
        // Find the wolf's index in the visible pack
        const wolfIndex = visiblePackMembers.findIndex(member => member === wolf);
        
        // Assign different attack positions to different wolves
        if (wolfIndex < attackPositions.length) {
            return attackPositions[wolfIndex];
        }
        
        // If more wolves than positions, spread them out
        const angle = (wolfIndex * 2 * Math.PI) / visiblePackMembers.length;
        const radius = 2;
        return {
            x: player.x + Math.round(Math.cos(angle) * radius),
            y: player.y + Math.round(Math.sin(angle) * radius)
        };
    } catch (error) {
        console.error("Error in getPackAttackPosition:", error);
        return { x: player.x, y: player.y };
    }
}

function dropLoot(animalType) {
    try {
        // Safety checks
        if (!animalType || !gameState.lootItems) {
            return;
        }
        
        let lootTier, dropChance;
        
        // Determine loot tier and drop chance based on animal type
        switch (animalType) {
            case 'squirrel':
            case 'rabbit':
                lootTier = 'common';
                dropChance = 0.3; // 30% chance
                break;
            case 'wolf':
                lootTier = 'uncommon';
                dropChance = 0.4; // 40% chance
                break;
            case 'bear':
                lootTier = 'rare';
                dropChance = 0.6; // 60% chance
                break;
            default:
                return; // No loot for unknown types
        }
        
        // Check if loot pool exists
        if (!gameState.lootItems[lootTier] || !Array.isArray(gameState.lootItems[lootTier])) {
            console.warn(`Loot pool '${lootTier}' not found or invalid`);
            return;
        }
        
        // Check if loot drops
        if (Math.random() < dropChance) {
            const lootPool = gameState.lootItems[lootTier];
            const randomItem = lootPool[Math.floor(Math.random() * lootPool.length)];
            
            // Safety check for random item
            if (!randomItem || !randomItem.type) {
                console.warn("Invalid loot item generated");
                return;
            }
            
            // Add item to inventory
            if (gameState.inventory && gameState.inventory.hasOwnProperty(randomItem.type)) {
                gameState.inventory[randomItem.type] += randomItem.amount || 1;
                logMessage(`You found ${randomItem.name}! (${randomItem.description})`, '#61afef');
                
                // Special effects for certain items
                if (randomItem.type === 'potion') {
                    const maxHealth = 100 + (gameState.playerModifiers?.healthBonus || 0);
                    gameState.player.health = Math.min(maxHealth, gameState.player.health + 20);
                    logMessage("The healing potion restores your health!", '#98c379');
                } else if (randomItem.type === 'elixir') {
                    const maxHealth = 100 + (gameState.playerModifiers?.healthBonus || 0);
                    gameState.player.health = Math.min(maxHealth, gameState.player.health + 50);
                    logMessage("The health elixir greatly restores your health!", '#98c379');
                } else if (randomItem.type === 'weapon') {
                    if (gameState.tools) {
                        gameState.tools.sword = true;
                        logMessage("You found an iron sword! Your combat prowess increases!", '#fbbf24');
                    }
                }
            }
        }
    } catch (error) {
        console.error("Error in dropLoot:", error);
    }
}

function isNearCampfire(x, y) {
    const radius = 4;
    for (let key in gameState.placedObjects) {
        const obj = gameState.placedObjects[key];
        if (obj.type === TILES.CAMPFIRE) {
            const dist = Math.sqrt(Math.pow(x - obj.x, 2) + Math.pow(y - obj.y, 2));
            if (dist <= radius) return true;
        }
    }
    return false;
}

function updateAnimals() {
    try {
        const { player } = gameState;
        const playerSafe = isNearCampfire(player.x, player.y);

        gameState.animals.forEach(animal => {
        const oldX = animal.x;
        const oldY = animal.y;
        
        if (animal.lastHitTimer > 0) animal.lastHitTimer--;
        
        const distToPlayer = Math.sqrt(Math.pow(player.x - animal.x, 2) + Math.pow(player.y - animal.y, 2));
        const nearFire = isNearCampfire(animal.x, animal.y);

        // State logic
        if (nearFire) {
            animal.state = 'flee';
        } else if (animal.type === 'squirrel' || animal.type === 'rabbit') {
            // Squirrels and rabbits flee from player
            if (distToPlayer <= 6) {
                animal.state = 'flee';
            } else {
                animal.state = 'wander';
            }
        } else if (animal.type === 'bear') {
            // Bears are aggressive and hunt from further away
            if (distToPlayer <= 8 || animal.hp < animal.maxHp) {
                animal.state = 'hunt';
            } else {
                animal.state = 'wander';
            }
        } else if (animal.type === 'wolf') {
            // Wolf pack behavior
            coordinatePackHunting(animal);
            
            // Check smell range for wolves
            if (animal.smellRange && distToPlayer <= animal.smellRange) {
                animal.state = 'hunt';
                if (animal.isPackLeader) {
                    animal.packTarget.x = player.x;
                    animal.packTarget.y = player.y;
                }
            } else if (distToPlayer > animal.smellRange + 2) {
                animal.state = 'wander';
                if (animal.isPackLeader) {
                    animal.packTarget.x = null;
                    animal.packTarget.y = null;
                }
            }
        } else if (distToPlayer <= 4 || animal.hp < animal.maxHp) {
            animal.state = 'hunt';
        } else if (distToPlayer > 5) { 
            animal.state = 'wander';
        }
        
        // Movement Logic
        let moveX = 0;
        let moveY = 0;
        switch (animal.state) {
            case 'hunt':
                if (animal.type === 'wolf' && animal.packId) {
                    // Wolf pack coordinated hunting
                    const attackPos = getPackAttackPosition(animal, player);
                    if (animal.x < attackPos.x) moveX = 1; else if (animal.x > attackPos.x) moveX = -1;
                    if (animal.y < attackPos.y) moveY = 1; else if (animal.y > attackPos.y) moveY = -1;
                } else {
                    // Standard hunting behavior for other animals
                    if (animal.x < player.x) moveX = 1; else if (animal.x > player.x) moveX = -1;
                    if (animal.y < player.y) moveY = 1; else if (animal.y > player.y) moveY = -1;
                }
                break;
            case 'flee':
                if (animal.type === 'squirrel' || animal.type === 'rabbit') {
                    // Squirrels and rabbits flee from player
                    if (animal.x < player.x) moveX = -1; else if (animal.x > player.x) moveX = 1;
                    if (animal.y < player.y) moveY = -1; else if (animal.y > player.y) moveY = 1;
                } else {
                    // Wolves and bears flee from campfire
                    const fire = Object.values(gameState.placedObjects).find(o => o.type === TILES.CAMPFIRE);
                    if (fire) {
                         if (animal.x < fire.x) moveX = -1; if (animal.x > fire.x) moveX = 1;
                         if (animal.y < fire.y) moveY = -1; if (animal.y > fire.y) moveY = 1;
                    }
                }
                break;
            case 'wander':
                if (animal.wanderTarget.x === null || (animal.x === animal.wanderTarget.x && animal.y === animal.wanderTarget.y)) {
                    animal.wanderTarget.x = animal.x + Math.floor(Math.random() * 11) - 5;
                    animal.wanderTarget.y = animal.y + Math.floor(Math.random() * 11) - 5;
                } else {
                    if (animal.x < animal.wanderTarget.x) moveX = 1; else if (animal.x > animal.wanderTarget.x) moveX = -1;
                    if (animal.y < animal.wanderTarget.y) moveY = 1; else if (animal.y > animal.wanderTarget.y) moveY = -1;
                }
                break;
        }

        const newAnimalX = animal.x + moveX;
        const newAnimalY = animal.y + moveY;
        const targetTile = gameState.world[newAnimalY] ? gameState.world[newAnimalY][newAnimalX] : TILES.MOUNTAIN;
        
        // Check if there's another animal or the player at the target position
        const animalAtTarget = gameState.animals.find(a => a !== animal && a.x === newAnimalX && a.y === newAnimalY);
        const playerAtTarget = (player.x === newAnimalX && player.y === newAnimalY);

        if (targetTile !== undefined && targetTile !== TILES.TREE && targetTile !== TILES.ROCK && targetTile !== TILES.WATER && targetTile !== TILES.MONOLITH && targetTile !== TILES.MOUNTAIN && !animalAtTarget && !playerAtTarget) {
            animal.x = newAnimalX;
            animal.y = newAnimalY;
        }

        animal.x = Math.max(0, Math.min(MAP_SIZE - 1, animal.x));
        animal.y = Math.max(0, Math.min(MAP_SIZE - 1, animal.y));
        
        const dx = animal.x - oldX;
        const dy = animal.y - oldY;

        if (dx === 0 && dy === 0) {
            animal.isMoving = false;
        } else {
            animal.isMoving = true;
            animal.walkCycle = (animal.walkCycle + 0.2) % (Math.PI * 2);
            if (Math.abs(dx) > Math.abs(dy)) {
                animal.direction = dx > 0 ? 'right' : 'left';
            } else {
                animal.direction = dy > 0 ? 'down' : 'up';
            }
        }

        if (animal.state === 'hunt' && animal.x === player.x && animal.y === player.y) {
            if (!playerSafe) {
                gameState.player.health = Math.max(0, gameState.player.health - 1);
                logMessage("A wolf attacks you!", '#e06c75');
            } else {
                logMessage("The campfire keeps the wolf at bay.", '#61afef');
            }
        }
    });
    } catch (error) {
        console.error("Error in updateAnimals:", error);
    }
}

function sleep() {
    const hoursToSleep = (24 - gameState.time.hour) + 7;
    gameState.time.hour = 7;
    gameState.time.minute = 0;
    gameState.time.day++;
    
    // Check if player is sleeping in a tent at night
    const playerTile = gameState.world[gameState.player.y][gameState.player.x];
    const isInTent = playerTile === TILES.TENT;
    
    if (isInTent) {
        // Complete energy restoration when sleeping in tent at night
        gameState.player.energy = 100;
        gameState.player.health = Math.min(100, gameState.player.health + hoursToSleep * 2);
        gameState.player.hunger = Math.max(0, gameState.player.hunger - hoursToSleep * 1.5);
        logMessage(`You sleep soundly in your tent and wake up fully rested!`, '#61afef');
    } else {
        // Regular sleep restoration
        gameState.player.energy = Math.min(100, gameState.player.energy + hoursToSleep * 8);
        gameState.player.health = Math.min(100, gameState.player.health + hoursToSleep * 2);
        gameState.player.hunger = Math.max(0, gameState.player.hunger - hoursToSleep * 1.5);
        logMessage(`You restored health and energy.`);
    }
    
    regrowResources();
}

let timeTickCounter = 0;
const timeSpeed = 3; 

function manageSpawning() {
    try {
        gameState.time.animalSpawnTimer--;
        if (gameState.time.animalSpawnTimer <= 0) {
            if (gameState.isNight) {
                logMessage("You hear a howl in the distance...", "#c7c7c7");
                spawnAnimals(2 + Math.floor(Math.random() * 2)); // 2-3 animals at night
                gameState.time.animalSpawnTimer = 100 + Math.random() * 50; // 100-150 ticks (faster at night)
            } else {
                spawnAnimals(1 + Math.floor(Math.random() * 2)); // 1-2 animals during day
                gameState.time.animalSpawnTimer = 200 + Math.random() * 100; // 200-300 ticks (50-90 seconds)
            }
        }
    } catch (error) {
        console.error("Error in manageSpawning:", error);
        gameState.time.animalSpawnTimer = 200; // Reset timer on error
    }
}


function updateTime() {
    timeTickCounter++;
    if (timeTickCounter < timeSpeed) {
        return;
    }
    timeTickCounter = 0;

    gameState.time.minute += 1;
    if (gameState.time.minute >= 60) {
        gameState.time.minute = 0;
        gameState.time.hour++;
    }
    if (gameState.time.hour >= 24) {
        gameState.time.hour = 0;
        gameState.time.day++;
        regrowResources();
    }
    
    const wasNight = gameState.isNight;
    gameState.isNight = gameState.time.hour >= 20 || gameState.time.hour < 6;

    if (gameState.isNight && !wasNight) {
        logMessage("Night is falling. The wilderness grows restless...", '#e06c75');
        spawnAnimals(4); // Reduced to prevent crashes
        // Spawn Moonpetals
        for(let i = 0; i < 5; i++) {
            let x, y;
            do {
                x = Math.floor(Math.random() * MAP_SIZE);
                y = Math.floor(Math.random() * MAP_SIZE);
            } while (gameState.world[y][x] !== TILES.GRASS);
            gameState.world[y][x] = TILES.MOONPETAL_FLOWER;
        }
    }
    if (!gameState.isNight && wasNight) {
        logMessage("The sun is rising.", '#61afef');
        // Despawn moonpetals
         for (let y = 0; y < MAP_SIZE; y++) {
            for (let x = 0; x < MAP_SIZE; x++) {
                if (gameState.world[y][x] === TILES.MOONPETAL_FLOWER) {
                    gameState.world[y][x] = TILES.GRASS;
                }
            }
        }
    }
}

function regrowResources(){
    logMessage("The forest feels a little fuller.", "#98c379");
    for (let y = 0; y < MAP_SIZE; y++) {
        for (let x = 0; x < MAP_SIZE; x++) {
            const tile = gameState.world[y][x];
            const key = `${x},${y}`;
            if([TILES.STUMP, TILES.MINED_ROCK, TILES.EMPTY_BUSH].includes(tile)){
                if(Math.random() < 0.25){
                    if(tile === TILES.STUMP) {
                        gameState.world[y][x] = TILES.TREE;
                        gameState.worldObjects[key] = { type: TILES.TREE, health: 10 };
                    }
                    if(tile === TILES.MINED_ROCK) {
                        gameState.world[y][x] = TILES.ROCK;
                        gameState.worldObjects[key] = { type: TILES.ROCK, health: 15 };
                    }
                    if(tile === TILES.EMPTY_BUSH) gameState.world[y][x] = TILES.BERRY_BUSH;
                }
            }
        }
    }
}


function depleteEnergy(amount) {
    gameState.player.energy = Math.max(0, gameState.player.energy - amount);
    if(gameState.player.energy === 0){
        gameState.player.health = Math.max(0, gameState.player.health - amount * 2);
    }
}

function updateStats() {
    gameState.player.hunger = Math.max(0, gameState.player.hunger - 0.01);
    if (gameState.player.hunger === 0) {
        gameState.player.health = Math.max(0, gameState.player.health - 0.05);
    }
    if (gameState.player.health <= 0) gameOver("You ran out of health!");
    if (gameState.player.hunger <= 0 && gameState.player.health <= 0) gameOver("You starved!");
    if (gameState.player.energy <= 0 && gameState.player.health <= 0) gameOver("You collapsed from exhaustion!");
}

function updateCamera() {
    const { camera, player } = gameState;
    const targetX = player.x * TILE_SIZE - canvas.width / 2 + TILE_SIZE / 2;
    const targetY = player.y * TILE_SIZE - canvas.height / 2 + TILE_SIZE / 2;
    
    camera.x += (targetX - camera.x) * 0.1;
    camera.y += (targetY - camera.y) * 0.1;

    const maxX = MAP_SIZE * TILE_SIZE - canvas.width;
    const maxY = MAP_SIZE * TILE_SIZE - canvas.height;
    camera.x = Math.max(0, Math.min(camera.x, maxX));
    camera.y = Math.max(0, Math.min(camera.y, maxY));
}

// --- Drawing ---

function drawPlayerSprite(x, y, frame) {
    const PIXEL_SIZE = 4; 
    const SPRITE_WIDTH = 16;
    const SPRITE_HEIGHT = 16;
    const SPRITE_OFFSET_X = TILE_SIZE / 2 - (SPRITE_WIDTH * PIXEL_SIZE) / 2;
    const SPRITE_OFFSET_Y = 10;

    const colors = {
        hatGreen: '#556b2f', darkHatGreen: '#455a25',
        vestBrown: '#8b4513', shirtGrey: '#4a4a4a',
        pantsGrey: '#696969', darkPantsGrey: '#505050',
        backpackBrown: '#654321', darkBackpackBrown: '#50341a',
        skin: '#fbd7a3', darkSkin: '#e4a768',
        black: '#212121', white: '#ffffff',
        toolHandle: '#966F33', toolHead: '#a9a9a9',
        swordHilt: '#4a2b13', swordBlade: '#dadada',
    };

    ctx.save();
    ctx.translate(x + SPRITE_OFFSET_X, y + SPRITE_OFFSET_Y);

    const p = (px, py, color) => {
        ctx.fillStyle = color;
        ctx.fillRect(px * PIXEL_SIZE, py * PIXEL_SIZE, PIXEL_SIZE, PIXEL_SIZE);
    };
    
    const spriteData = {
        'standing_down': [
            // Hat
            [5,0,colors.hatGreen],[6,0,colors.hatGreen],[7,0,colors.hatGreen],[8,0,colors.hatGreen],[9,0,colors.hatGreen],[10,0,colors.hatGreen],
            [4,1,colors.hatGreen],[5,1,colors.darkHatGreen],[6,1,colors.darkHatGreen],[7,1,colors.darkHatGreen],[8,1,colors.darkHatGreen],[9,1,colors.darkHatGreen],[10,1,colors.darkHatGreen],[11,1,colors.hatGreen],
            [3,2,colors.hatGreen],[4,2,colors.hatGreen],[5,2,colors.hatGreen],[6,2,colors.hatGreen],[7,2,colors.hatGreen],[8,2,colors.hatGreen],[9,2,colors.hatGreen],[10,2,colors.hatGreen],[11,2,colors.hatGreen],[12,2,colors.hatGreen],
            [3,3,colors.black],[4,3,colors.skin],[5,3,colors.skin],[6,3,colors.skin],[7,3,colors.skin],[8,3,colors.skin],[9,3,colors.skin],[10,3,colors.skin],[11,3,colors.skin],[12,3,colors.black],
            [3,4,colors.black],[4,4,colors.skin],[5,4,colors.black],[6,4,colors.skin],[7,4,colors.skin],[8,4,colors.skin],[9,4,colors.black],[10,4,colors.skin],[11,4,colors.skin],[12,4,colors.black],
            [4,5,colors.darkSkin],[5,5,colors.skin],[6,5,colors.darkSkin],[7,5,colors.darkSkin],[8,5,colors.darkSkin],[9,5,colors.darkSkin],[10,5,colors.skin],[11,5,colors.darkSkin],
            // Body
            [3,6,colors.black],[4,6,colors.black],[5,6,colors.black],[6,6,colors.black],[7,6,colors.black],[8,6,colors.black],[9,6,colors.black],[10,6,colors.black],[11,6,colors.black],[12,6,colors.black],
            [3,7,colors.black],[4,7,colors.skin],[5,7,colors.skin],[6,7,colors.vestBrown],[7,7,colors.vestBrown],[8,7,colors.vestBrown],[9,7,colors.vestBrown],[10,7,colors.skin],[11,7,colors.skin],[12,7,colors.black],
            [2,8,colors.black],[3,8,colors.skin],[4,8,colors.skin],[5,8,colors.shirtGrey],[6,8,colors.shirtGrey],[7,8,colors.shirtGrey],[8,8,colors.shirtGrey],[9,8,colors.shirtGrey],[10,8,colors.skin],[11,8,colors.skin],[12,8,colors.skin],[13,8,colors.black],
            [2,9,colors.black],[3,9,colors.black],[4,9,colors.black],[5,9,colors.pantsGrey],[6,9,colors.pantsGrey],[7,9,colors.black],[8,9,colors.black],[9,9,colors.pantsGrey],[10,9,colors.pantsGrey],[11,9,colors.black],[12,9,colors.black],[13,9,colors.black],
            [4,10,colors.pantsGrey],[5,10,colors.pantsGrey],[6,10,colors.pantsGrey],[9,10,colors.pantsGrey],[10,10,colors.pantsGrey],[11,10,colors.pantsGrey],
            [4,11,colors.darkPantsGrey],[5,11,colors.darkPantsGrey],[6,11,colors.darkPantsGrey],[9,11,colors.darkPantsGrey],[10,11,colors.darkPantsGrey],[11,11,colors.darkPantsGrey],
        ],
        'walking_down_1': [ // Right leg forward
            [5,0,colors.hatGreen],[6,0,colors.hatGreen],[7,0,colors.hatGreen],[8,0,colors.hatGreen],[9,0,colors.hatGreen],[10,0,colors.hatGreen],
            [4,1,colors.hatGreen],[5,1,colors.darkHatGreen],[6,1,colors.darkHatGreen],[7,1,colors.darkHatGreen],[8,1,colors.darkHatGreen],[9,1,colors.darkHatGreen],[10,1,colors.darkHatGreen],[11,1,colors.hatGreen],
            [3,2,colors.hatGreen],[4,2,colors.hatGreen],[5,2,colors.hatGreen],[6,2,colors.hatGreen],[7,2,colors.hatGreen],[8,2,colors.hatGreen],[9,2,colors.hatGreen],[10,2,colors.hatGreen],[11,2,colors.hatGreen],[12,2,colors.hatGreen],
            [3,3,colors.black],[4,3,colors.skin],[5,3,colors.skin],[6,3,colors.skin],[7,3,colors.skin],[8,3,colors.skin],[9,3,colors.skin],[10,3,colors.skin],[11,3,colors.skin],[12,3,colors.black],
            [3,4,colors.black],[4,4,colors.skin],[5,4,colors.black],[6,4,colors.skin],[7,4,colors.skin],[8,4,colors.skin],[9,4,colors.black],[10,4,colors.skin],[11,4,colors.skin],[12,4,colors.black],
            [4,5,colors.darkSkin],[5,5,colors.skin],[6,5,colors.darkSkin],[7,5,colors.darkSkin],[8,5,colors.darkSkin],[9,5,colors.darkSkin],[10,5,colors.skin],[11,5,colors.darkSkin],
             [2,6,colors.black],[3,6,colors.black],[4,6,colors.black],[5,6,colors.black],[6,6,colors.black],[7,6,colors.black],[8,6,colors.black],[9,6,colors.black],[10,6,colors.black],[11,6,colors.black],[12,6,colors.black],
            [2,7,colors.black],[3,7,colors.skin],[4,7,colors.vestBrown],[5,7,colors.vestBrown],[6,7,colors.vestBrown],[7,7,colors.vestBrown],[8,7,colors.skin],[9,7,colors.skin],[10,7,colors.black],
            [2,8,colors.black],[3,8,colors.skin],[4,8,colors.shirtGrey],[5,8,colors.shirtGrey],[6,8,colors.shirtGrey],[7,8,colors.shirtGrey],[8,8,colors.skin],[9,8,colors.black],
            [3,9,colors.black],[4,9,colors.pantsGrey],[5,9,colors.pantsGrey],[6,9,colors.black],[8,9,colors.pantsGrey],[9,9,colors.pantsGrey],[10,9,colors.black],
            [4,10,colors.pantsGrey],[5,10,colors.pantsGrey],[8,10,colors.pantsGrey],[9,10,colors.pantsGrey],[10,10,colors.pantsGrey],
            [4,11,colors.darkPantsGrey],[5,11,colors.darkPantsGrey],[8,11,colors.darkPantsGrey],[9,11,colors.darkPantsGrey],[10,11,colors.darkPantsGrey]
        ],
        'walking_down_2': [ // Left leg forward (mirrored of 1)
            [5,0,colors.hatGreen],[6,0,colors.hatGreen],[7,0,colors.hatGreen],[8,0,colors.hatGreen],[9,0,colors.hatGreen],[10,0,colors.hatGreen],
            [4,1,colors.hatGreen],[5,1,colors.darkHatGreen],[6,1,colors.darkHatGreen],[7,1,colors.darkHatGreen],[8,1,colors.darkHatGreen],[9,1,colors.darkHatGreen],[10,1,colors.darkHatGreen],[11,1,colors.hatGreen],
            [3,2,colors.hatGreen],[4,2,colors.hatGreen],[5,2,colors.hatGreen],[6,2,colors.hatGreen],[7,2,colors.hatGreen],[8,2,colors.hatGreen],[9,2,colors.hatGreen],[10,2,colors.hatGreen],[11,2,colors.hatGreen],[12,2,colors.hatGreen],
            [3,3,colors.black],[4,3,colors.skin],[5,3,colors.skin],[6,3,colors.skin],[7,3,colors.skin],[8,3,colors.skin],[9,3,colors.skin],[10,3,colors.skin],[11,3,colors.skin],[12,3,colors.black],
            [3,4,colors.black],[4,4,colors.skin],[5,4,colors.black],[6,4,colors.skin],[7,4,colors.skin],[8,4,colors.skin],[9,4,colors.black],[10,4,colors.skin],[11,4,colors.skin],[12,4,colors.black],
            [4,5,colors.darkSkin],[5,5,colors.skin],[6,5,colors.darkSkin],[7,5,colors.darkSkin],[8,5,colors.darkSkin],[9,5,colors.darkSkin],[10,5,colors.skin],[11,5,colors.darkSkin],
             [3,6,colors.black],[4,6,colors.black],[5,6,colors.black],[6,6,colors.black],[7,6,colors.black],[8,6,colors.black],[9,6,colors.black],[10,6,colors.black],[11,6,colors.black],[12,6,colors.black],[13,6,colors.black],
            [5,7,colors.black],[6,7,colors.skin],[7,7,colors.skin],[8,7,colors.vestBrown],[9,7,colors.vestBrown],[10,7,colors.vestBrown],[11,7,colors.vestBrown],[12,7,colors.skin],[13,7,colors.black],
            [6,8,colors.black],[7,8,colors.skin],[8,8,colors.shirtGrey],[9,8,colors.shirtGrey],[10,8,colors.shirtGrey],[11,8,colors.shirtGrey],[12,8,colors.skin],[13,8,colors.black],
            [5,9,colors.black],[6,9,colors.pantsGrey],[7,9,colors.pantsGrey],[9,9,colors.black],[10,9,colors.pantsGrey],[11,9,colors.pantsGrey],[12,9,colors.black],
            [5,10,colors.pantsGrey],[6,10,colors.pantsGrey],[7,10,colors.pantsGrey],[10,10,colors.pantsGrey],[11,10,colors.pantsGrey],
            [5,11,colors.darkPantsGrey],[6,11,colors.darkPantsGrey],[7,11,colors.darkPantsGrey],[10,11,colors.darkPantsGrey],[11,11,colors.darkPantsGrey],
        ],
        'standing_up': [
             [5,0,colors.hatGreen],[6,0,colors.hatGreen],[7,0,colors.hatGreen],[8,0,colors.hatGreen],[9,0,colors.hatGreen],[10,0,colors.hatGreen],
             [4,1,colors.hatGreen],[5,1,colors.darkHatGreen],[6,1,colors.darkHatGreen],[7,1,colors.darkHatGreen],[8,1,colors.darkHatGreen],[9,1,colors.darkHatGreen],[10,1,colors.darkHatGreen],[11,1,colors.hatGreen],
             [3,2,colors.hatGreen],[4,2,colors.hatGreen],[5,2,colors.hatGreen],[6,2,colors.hatGreen],[7,2,colors.hatGreen],[8,2,colors.hatGreen],[9,2,colors.hatGreen],[10,2,colors.hatGreen],[11,2,colors.hatGreen],[12,2,colors.hatGreen],
             [3,3,colors.black],[4,3,colors.black],[5,3,colors.black],[6,3,colors.black],[7,3,colors.black],[8,3,colors.black],[9,3,colors.black],[10,3,colors.black],[11,3,colors.black],[12,3,colors.black],
             [3,4,colors.black],[4,4,colors.skin],[5,4,colors.skin],[6,4,colors.skin],[7,4,colors.skin],[8,4,colors.skin],[9,4,colors.skin],[10,4,colors.skin],[11,4,colors.skin],[12,4,colors.black],
             [2,5,colors.black],[3,5,colors.black],[4,5,colors.black],[5,5,colors.black],[6,5,colors.black],[7,5,colors.black],[8,5,colors.black],[9,5,colors.black],[10,5,colors.black],[11,5,colors.black],[12,5,colors.black],[13,5,colors.black],
             [2,6,colors.black],[3,6,colors.backpackBrown],[4,6,colors.backpackBrown],[5,6,colors.backpackBrown],[6,6,colors.backpackBrown],[7,6,colors.backpackBrown],[8,6,colors.backpackBrown],[9,6,colors.backpackBrown],[10,6,colors.backpackBrown],[11,6,colors.backpackBrown],[12,6,colors.backpackBrown],[13,6,colors.black],
             [2,7,colors.black],[3,7,colors.backpackBrown],[4,7,colors.darkBackpackBrown],[5,7,colors.darkBackpackBrown],[6,7,colors.darkBackpackBrown],[7,7,colors.darkBackpackBrown],[8,7,colors.darkBackpackBrown],[9,7,colors.darkBackpackBrown],[10,7,colors.darkBackpackBrown],[11,7,colors.darkBackpackBrown],[12,7,colors.darkBackpackBrown],[13,7,colors.black],
             [2,8,colors.black],[3,8,colors.backpackBrown],[4,8,colors.darkBackpackBrown],[5,8,colors.backpackBrown],[6,8,colors.backpackBrown],[7,8,colors.backpackBrown],[8,8,colors.backpackBrown],[9,8,colors.backpackBrown],[10,8,colors.backpackBrown],[11,8,colors.backpackBrown],[12,8,colors.darkBackpackBrown],[13,8,colors.black],
             [3,9,colors.black],[4,9,colors.black],[5,9,colors.pantsGrey],[6,9,colors.pantsGrey],[7,9,colors.black],[8,9,colors.black],[9,9,colors.pantsGrey],[10,9,colors.pantsGrey],[11,9,colors.black],[12,9,colors.black],
             [4,10,colors.pantsGrey],[5,10,colors.pantsGrey],[6,10,colors.pantsGrey],[9,10,colors.pantsGrey],[10,10,colors.pantsGrey],[11,10,colors.pantsGrey],
             [4,11,colors.darkPantsGrey],[5,11,colors.darkPantsGrey],[6,11,colors.darkPantsGrey],[9,11,colors.darkPantsGrey],[10,11,colors.darkPantsGrey],[11,11,colors.darkPantsGrey],
        ],
        'walking_up_1': [
            [5,0,colors.hatGreen],[6,0,colors.hatGreen],[7,0,colors.hatGreen],[8,0,colors.hatGreen],[9,0,colors.hatGreen],[10,0,colors.hatGreen],
             [4,1,colors.hatGreen],[5,1,colors.darkHatGreen],[6,1,colors.darkHatGreen],[7,1,colors.darkHatGreen],[8,1,colors.darkHatGreen],[9,1,colors.darkHatGreen],[10,1,colors.darkHatGreen],[11,1,colors.hatGreen],
             [3,2,colors.hatGreen],[4,2,colors.hatGreen],[5,2,colors.hatGreen],[6,2,colors.hatGreen],[7,2,colors.hatGreen],[8,2,colors.hatGreen],[9,2,colors.hatGreen],[10,2,colors.hatGreen],[11,2,colors.hatGreen],[12,2,colors.hatGreen],
             [3,3,colors.black],[4,3,colors.black],[5,3,colors.black],[6,3,colors.black],[7,3,colors.black],[8,3,colors.black],[9,3,colors.black],[10,3,colors.black],[11,3,colors.black],[12,3,colors.black],
             [3,4,colors.black],[4,4,colors.skin],[5,4,colors.skin],[6,4,colors.skin],[7,4,colors.skin],[8,4,colors.skin],[9,4,colors.skin],[10,4,colors.skin],[11,4,colors.skin],[12,4,colors.black],
             [2,5,colors.black],[3,5,colors.black],[4,5,colors.black],[5,5,colors.black],[6,5,colors.black],[7,5,colors.black],[8,5,colors.black],[9,5,colors.black],[10,5,colors.black],[11,5,colors.black],[12,5,colors.black],[13,5,colors.black],
             [2,6,colors.black],[3,6,colors.backpackBrown],[4,6,colors.backpackBrown],[5,6,colors.backpackBrown],[6,6,colors.backpackBrown],[7,6,colors.backpackBrown],[8,6,colors.backpackBrown],[9,6,colors.backpackBrown],[10,6,colors.backpackBrown],[11,6,colors.backpackBrown],[12,6,colors.backpackBrown],[13,6,colors.black],
             [2,7,colors.black],[3,7,colors.backpackBrown],[4,7,colors.darkBackpackBrown],[5,7,colors.darkBackpackBrown],[6,7,colors.darkBackpackBrown],[7,7,colors.darkBackpackBrown],[8,7,colors.darkBackpackBrown],[9,7,colors.darkBackpackBrown],[10,7,colors.darkBackpackBrown],[11,7,colors.darkBackpackBrown],[12,7,colors.darkBackpackBrown],[13,7,colors.black],
             [2,8,colors.black],[3,8,colors.backpackBrown],[4,8,colors.darkBackpackBrown],[5,8,colors.backpackBrown],[6,8,colors.backpackBrown],[7,8,colors.backpackBrown],[8,8,colors.backpackBrown],[9,8,colors.backpackBrown],[10,8,colors.backpackBrown],[11,8,colors.backpackBrown],[12,8,colors.darkBackpackBrown],[13,8,colors.black],
             [3,9,colors.black],[4,9,colors.black],[5,9,colors.pantsGrey],[6,9,colors.pantsGrey],[7,9,colors.black],[8,9,colors.black],[9,9,colors.pantsGrey],[10,9,colors.pantsGrey],[11,9,colors.black],[12,9,colors.black],
             [4,10,colors.pantsGrey],[5,10,colors.pantsGrey],[6,10,colors.pantsGrey],[10,10,colors.pantsGrey],[11,10,colors.pantsGrey],
             [4,11,colors.darkPantsGrey],[5,11,colors.darkPantsGrey],[6,11,colors.darkPantsGrey],[10,11,colors.darkPantsGrey],[11,11,colors.darkPantsGrey]
        ],
        'walking_up_2': [
            [5,0,colors.hatGreen],[6,0,colors.hatGreen],[7,0,colors.hatGreen],[8,0,colors.hatGreen],[9,0,colors.hatGreen],[10,0,colors.hatGreen],
             [4,1,colors.hatGreen],[5,1,colors.darkHatGreen],[6,1,colors.darkHatGreen],[7,1,colors.darkHatGreen],[8,1,colors.darkHatGreen],[9,1,colors.darkHatGreen],[10,1,colors.darkHatGreen],[11,1,colors.hatGreen],
             [3,2,colors.hatGreen],[4,2,colors.hatGreen],[5,2,colors.hatGreen],[6,2,colors.hatGreen],[7,2,colors.hatGreen],[8,2,colors.hatGreen],[9,2,colors.hatGreen],[10,2,colors.hatGreen],[11,2,colors.hatGreen],[12,2,colors.hatGreen],
             [3,3,colors.black],[4,3,colors.black],[5,3,colors.black],[6,3,colors.black],[7,3,colors.black],[8,3,colors.black],[9,3,colors.black],[10,3,colors.black],[11,3,colors.black],[12,3,colors.black],
             [3,4,colors.black],[4,4,colors.skin],[5,4,colors.skin],[6,4,colors.skin],[7,4,colors.skin],[8,4,colors.skin],[9,4,colors.skin],[10,4,colors.skin],[11,4,colors.skin],[12,4,colors.black],
             [2,5,colors.black],[3,5,colors.black],[4,5,colors.black],[5,5,colors.black],[6,5,colors.black],[7,5,colors.black],[8,5,colors.black],[9,5,colors.black],[10,5,colors.black],[11,5,colors.black],[12,5,colors.black],[13,5,colors.black],
             [2,6,colors.black],[3,6,colors.backpackBrown],[4,6,colors.backpackBrown],[5,6,colors.backpackBrown],[6,6,colors.backpackBrown],[7,6,colors.backpackBrown],[8,6,colors.backpackBrown],[9,6,colors.backpackBrown],[10,6,colors.backpackBrown],[11,6,colors.backpackBrown],[12,6,colors.backpackBrown],[13,6,colors.black],
             [2,7,colors.black],[3,7,colors.backpackBrown],[4,7,colors.darkBackpackBrown],[5,7,colors.darkBackpackBrown],[6,7,colors.darkBackpackBrown],[7,7,colors.darkBackpackBrown],[8,7,colors.darkBackpackBrown],[9,7,colors.darkBackpackBrown],[10,7,colors.darkBackpackBrown],[11,7,colors.darkBackpackBrown],[12,7,colors.darkBackpackBrown],[13,7,colors.black],
             [2,8,colors.black],[3,8,colors.backpackBrown],[4,8,colors.darkBackpackBrown],[5,8,colors.backpackBrown],[6,8,colors.backpackBrown],[7,8,colors.backpackBrown],[8,8,colors.backpackBrown],[9,8,colors.backpackBrown],[10,8,colors.backpackBrown],[11,8,colors.backpackBrown],[12,8,colors.darkBackpackBrown],[13,8,colors.black],
             [3,9,colors.black],[4,9,colors.pantsGrey],[5,9,colors.pantsGrey],[6,9,colors.pantsGrey],[8,9,colors.black],[9,9,colors.pantsGrey],[10,9,colors.pantsGrey],[11,9,colors.black],[12,9,colors.black],
             [4,10,colors.pantsGrey],[5,10,colors.pantsGrey],[6,10,colors.pantsGrey],[10,10,colors.pantsGrey],[11,10,colors.pantsGrey],
             [4,11,colors.darkPantsGrey],[5,11,colors.darkPantsGrey],[6,11,colors.darkPantsGrey],[10,11,colors.darkPantsGrey],[11,11,colors.darkPantsGrey]
        ],
        'standing_left': [
            [4,0,colors.hatGreen],[5,0,colors.hatGreen],[6,0,colors.hatGreen],[7,0,colors.hatGreen],[8,0,colors.hatGreen],
            [3,1,colors.hatGreen],[4,1,colors.darkHatGreen],[5,1,colors.darkHatGreen],[6,1,colors.darkHatGreen],[7,1,colors.darkHatGreen],[8,1,colors.darkHatGreen],[9,1,colors.hatGreen],
            [2,2,colors.hatGreen],[3,2,colors.hatGreen],[4,2,colors.hatGreen],[5,2,colors.hatGreen],[6,2,colors.hatGreen],[7,2,colors.hatGreen],[8,2,colors.hatGreen],[9,2,colors.hatGreen],
            [2,3,colors.black],[3,3,colors.skin],[4,3,colors.skin],[5,3,colors.skin],[6,3,colors.skin],[7,3,colors.skin],[8,3,colors.black],
            [2,4,colors.black],[3,4,colors.skin],[4,4,colors.black],[5,4,colors.skin],[6,4,colors.skin],[7,4,colors.skin],[8,4,colors.black],[9,4,colors.black],
            [2,5,colors.black],[3,5,colors.darkSkin],[4,5,colors.skin],[5,5,colors.darkSkin],[6,5,colors.darkSkin],[7,5,colors.darkSkin],[8,5,colors.black],
            [3,6,colors.black],[4,6,colors.black],[5,6,colors.black],[6,6,colors.black],[7,6,colors.black],[8,6,colors.black],
            [3,7,colors.black],[4,7,colors.shirtGrey],[5,7,colors.vestBrown],[6,7,colors.vestBrown],[7,7,colors.shirtGrey],[8,7,colors.black],
            [2,8,colors.black],[3,8,colors.skin],[4,8,colors.shirtGrey],[5,8,colors.shirtGrey],[6,8,colors.shirtGrey],[7,8,colors.shirtGrey],[8,8,colors.shirtGrey],[9,8,colors.skin],[10,8,colors.black],
            [2,9,colors.black],[3,9,colors.black],[4,9,colors.pantsGrey],[5,9,colors.pantsGrey],[6,9,colors.pantsGrey],[7,9,colors.pantsGrey],[8,9,colors.black],[9,9,colors.black],
            [3,10,colors.pantsGrey],[4,10,colors.pantsGrey],[5,10,colors.pantsGrey],[6,10,colors.pantsGrey],[7,10,colors.pantsGrey],[8,10,colors.pantsGrey],
            [3,11,colors.darkPantsGrey],[4,11,colors.darkPantsGrey],[5,11,colors.darkPantsGrey],[6,11,colors.darkPantsGrey],[7,11,colors.darkPantsGrey],[8,11,colors.darkPantsGrey],
        ],
        'walking_left_1': [
            [4,0,colors.hatGreen],[5,0,colors.hatGreen],[6,0,colors.hatGreen],[7,0,colors.hatGreen],[8,0,colors.hatGreen],
            [3,1,colors.hatGreen],[4,1,colors.darkHatGreen],[5,1,colors.darkHatGreen],[6,1,colors.darkHatGreen],[7,1,colors.darkHatGreen],[8,1,colors.darkHatGreen],[9,1,colors.hatGreen],
            [2,2,colors.hatGreen],[3,2,colors.hatGreen],[4,2,colors.hatGreen],[5,2,colors.hatGreen],[6,2,colors.hatGreen],[7,2,colors.hatGreen],[8,2,colors.hatGreen],[9,2,colors.hatGreen],
            [2,3,colors.black],[3,3,colors.skin],[4,3,colors.skin],[5,3,colors.skin],[6,3,colors.skin],[7,3,colors.skin],[8,3,colors.black],
            [2,4,colors.black],[3,4,colors.skin],[4,4,colors.black],[5,4,colors.skin],[6,4,colors.skin],[7,4,colors.skin],[8,4,colors.black],[9,4,colors.black],
            [2,5,colors.black],[3,5,colors.darkSkin],[4,5,colors.skin],[5,5,colors.darkSkin],[6,5,colors.darkSkin],[7,5,colors.darkSkin],[8,5,colors.black],
            [3,6,colors.black],[4,6,colors.black],[5,6,colors.black],[6,6,colors.black],[7,6,colors.black],[8,6,colors.black],[9,6,colors.black],
            [2,7,colors.black],[3,7,colors.shirtGrey],[4,7,colors.vestBrown],[5,7,colors.vestBrown],[6,7,colors.vestBrown],[7,7,colors.shirtGrey],[8,7,colors.skin],[9,7,colors.black],
            [2,8,colors.black],[3,8,colors.skin],[4,8,colors.shirtGrey],[5,8,colors.shirtGrey],[6,8,colors.shirtGrey],[7,8,colors.shirtGrey],[8,8,colors.skin],[9,8,colors.black],
            [3,9,colors.black],[4,9,colors.pantsGrey],[5,9,colors.pantsGrey],[6,9,colors.pantsGrey],[7,9,colors.black],[8,9,colors.black],
            [4,10,colors.pantsGrey],[5,10,colors.pantsGrey],[6,10,colors.pantsGrey],[7,10,colors.pantsGrey],
            [4,11,colors.darkPantsGrey],[5,11,colors.darkPantsGrey],[6,11,colors.darkPantsGrey],[7,11,colors.darkPantsGrey],
        ],
        'walking_left_2': [
            [4,0,colors.hatGreen],[5,0,colors.hatGreen],[6,0,colors.hatGreen],[7,0,colors.hatGreen],[8,0,colors.hatGreen],
            [3,1,colors.hatGreen],[4,1,colors.darkHatGreen],[5,1,colors.darkHatGreen],[6,1,colors.darkHatGreen],[7,1,colors.darkHatGreen],[8,1,colors.darkHatGreen],[9,1,colors.hatGreen],
            [2,2,colors.hatGreen],[3,2,colors.hatGreen],[4,2,colors.hatGreen],[5,2,colors.hatGreen],[6,2,colors.hatGreen],[7,2,colors.hatGreen],[8,2,colors.hatGreen],[9,2,colors.hatGreen],
            [2,3,colors.black],[3,3,colors.skin],[4,3,colors.skin],[5,3,colors.skin],[6,3,colors.skin],[7,3,colors.skin],[8,3,colors.black],
            [2,4,colors.black],[3,4,colors.skin],[4,4,colors.black],[5,4,colors.skin],[6,4,colors.skin],[7,4,colors.skin],[8,4,colors.black],[9,4,colors.black],
            [2,5,colors.black],[3,5,colors.darkSkin],[4,5,colors.skin],[5,5,colors.darkSkin],[6,5,colors.darkSkin],[7,5,colors.darkSkin],[8,5,colors.black],
            [3,6,colors.black],[4,6,colors.black],[5,6,colors.black],[6,6,colors.black],[7,6,colors.black],[8,6,colors.black],[9,6,colors.black],
            [3,7,colors.black],[4,7,colors.shirtGrey],[5,7,colors.vestBrown],[6,7,colors.vestBrown],[7,7,colors.vestBrown],[8,7,colors.shirtGrey],[9,7,colors.skin],[10,7,colors.black],
            [3,8,colors.black],[4,8,colors.skin],[5,8,colors.shirtGrey],[6,8,colors.shirtGrey],[7,8,colors.shirtGrey],[8,8,colors.shirtGrey],[9,8,colors.skin],[10,8,colors.black],
            [3,9,colors.black],[4,9,colors.pantsGrey],[5,9,colors.pantsGrey],[6,9,colors.pantsGrey],[7,9,colors.black],[8,9,colors.black],
            [4,10,colors.pantsGrey],[5,10,colors.pantsGrey],[6,10,colors.pantsGrey],[7,10,colors.pantsGrey],
            [4,11,colors.darkPantsGrey],[5,11,colors.darkPantsGrey],[6,11,colors.darkPantsGrey],[7,11,colors.darkPantsGrey],
        ],
        // Diagonal movement frames - player facing diagonally
        'standing_up_left': [
            // Hat (angled up-left - showing left side of hat)
            [2,0,colors.hatGreen],[3,0,colors.hatGreen],[4,0,colors.hatGreen],[5,0,colors.hatGreen],[6,0,colors.hatGreen],
            [1,1,colors.hatGreen],[2,1,colors.darkHatGreen],[3,1,colors.darkHatGreen],[4,1,colors.darkHatGreen],[5,1,colors.darkHatGreen],[6,1,colors.darkHatGreen],[7,1,colors.hatGreen],
            [1,2,colors.hatGreen],[2,2,colors.hatGreen],[3,2,colors.hatGreen],[4,2,colors.hatGreen],[5,2,colors.hatGreen],[6,2,colors.hatGreen],[7,2,colors.hatGreen],
            [1,3,colors.black],[2,3,colors.skin],[3,3,colors.skin],[4,3,colors.skin],[5,3,colors.skin],[6,3,colors.skin],[7,3,colors.black],
            [1,4,colors.black],[2,4,colors.skin],[3,4,colors.black],[4,4,colors.skin],[5,4,colors.skin],[6,4,colors.skin],[7,4,colors.black],
            [2,5,colors.black],[3,5,colors.darkSkin],[4,5,colors.skin],[5,5,colors.darkSkin],[6,5,colors.darkSkin],[7,5,colors.black],
            // Body (showing left side prominently)
            [2,6,colors.black],[3,6,colors.black],[4,6,colors.black],[5,6,colors.black],[6,6,colors.black],
            [1,7,colors.black],[2,7,colors.shirtGrey],[3,7,colors.vestBrown],[4,7,colors.vestBrown],[5,7,colors.shirtGrey],[6,7,colors.black],
            [1,8,colors.black],[2,8,colors.skin],[3,8,colors.shirtGrey],[4,8,colors.shirtGrey],[5,8,colors.shirtGrey],[6,8,colors.skin],[7,8,colors.black],
            [1,9,colors.black],[2,9,colors.black],[3,9,colors.pantsGrey],[4,9,colors.pantsGrey],[5,9,colors.pantsGrey],[6,9,colors.black],[7,9,colors.black],
            [2,10,colors.pantsGrey],[3,10,colors.pantsGrey],[4,10,colors.pantsGrey],[5,10,colors.pantsGrey],[6,10,colors.pantsGrey],
            [2,11,colors.darkPantsGrey],[3,11,colors.darkPantsGrey],[4,11,colors.darkPantsGrey],[5,11,colors.darkPantsGrey],[6,11,colors.darkPantsGrey],
        ],
        'standing_up_right': [
            // Hat (angled up-right - showing right side of hat)
            [6,0,colors.hatGreen],[7,0,colors.hatGreen],[8,0,colors.hatGreen],[9,0,colors.hatGreen],[10,0,colors.hatGreen],
            [5,1,colors.hatGreen],[6,1,colors.darkHatGreen],[7,1,colors.darkHatGreen],[8,1,colors.darkHatGreen],[9,1,colors.darkHatGreen],[10,1,colors.darkHatGreen],[11,1,colors.hatGreen],
            [6,2,colors.hatGreen],[7,2,colors.hatGreen],[8,2,colors.hatGreen],[9,2,colors.hatGreen],[10,2,colors.hatGreen],[11,2,colors.hatGreen],[12,2,colors.hatGreen],
            [6,3,colors.black],[7,3,colors.skin],[8,3,colors.skin],[9,3,colors.skin],[10,3,colors.skin],[11,3,colors.skin],[12,3,colors.black],
            [6,4,colors.black],[7,4,colors.skin],[8,4,colors.black],[9,4,colors.skin],[10,4,colors.skin],[11,4,colors.skin],[12,4,colors.black],
            [6,5,colors.black],[7,5,colors.darkSkin],[8,5,colors.skin],[9,5,colors.darkSkin],[10,5,colors.darkSkin],[11,5,colors.black],
            // Body (showing right side prominently)
            [6,6,colors.black],[7,6,colors.black],[8,6,colors.black],[9,6,colors.black],[10,6,colors.black],
            [7,7,colors.black],[8,7,colors.shirtGrey],[9,7,colors.vestBrown],[10,7,colors.vestBrown],[11,7,colors.shirtGrey],[12,7,colors.black],
            [7,8,colors.black],[8,8,colors.skin],[9,8,colors.shirtGrey],[10,8,colors.shirtGrey],[11,8,colors.shirtGrey],[12,8,colors.skin],[13,8,colors.black],
            [7,9,colors.black],[8,9,colors.black],[9,9,colors.pantsGrey],[10,9,colors.pantsGrey],[11,9,colors.pantsGrey],[12,9,colors.black],[13,9,colors.black],
            [8,10,colors.pantsGrey],[9,10,colors.pantsGrey],[10,10,colors.pantsGrey],[11,10,colors.pantsGrey],[12,10,colors.pantsGrey],
            [8,11,colors.darkPantsGrey],[9,11,colors.darkPantsGrey],[10,11,colors.darkPantsGrey],[11,11,colors.darkPantsGrey],[12,11,colors.darkPantsGrey],
        ],
        'standing_down_left': [
            // Hat (angled down-left - showing left side of hat)
            [2,0,colors.hatGreen],[3,0,colors.hatGreen],[4,0,colors.hatGreen],[5,0,colors.hatGreen],[6,0,colors.hatGreen],
            [1,1,colors.hatGreen],[2,1,colors.darkHatGreen],[3,1,colors.darkHatGreen],[4,1,colors.darkHatGreen],[5,1,colors.darkHatGreen],[6,1,colors.darkHatGreen],[7,1,colors.hatGreen],
            [1,2,colors.hatGreen],[2,2,colors.hatGreen],[3,2,colors.hatGreen],[4,2,colors.hatGreen],[5,2,colors.hatGreen],[6,2,colors.hatGreen],[7,2,colors.hatGreen],
            [1,3,colors.black],[2,3,colors.black],[3,3,colors.black],[4,3,colors.black],[5,3,colors.black],[6,3,colors.black],[7,3,colors.black],
            [1,4,colors.black],[2,4,colors.skin],[3,4,colors.skin],[4,4,colors.skin],[5,4,colors.skin],[6,4,colors.skin],[7,4,colors.skin],[8,4,colors.black],
            [1,5,colors.black],[2,5,colors.black],[3,5,colors.black],[4,5,colors.black],[5,5,colors.black],[6,5,colors.black],[7,5,colors.black],[8,5,colors.black],[9,5,colors.black],
            // Backpack (showing left side prominently)
            [1,6,colors.black],[2,6,colors.backpackBrown],[3,6,colors.backpackBrown],[4,6,colors.backpackBrown],[5,6,colors.backpackBrown],[6,6,colors.backpackBrown],[7,6,colors.backpackBrown],[8,6,colors.backpackBrown],
            [1,7,colors.black],[2,7,colors.backpackBrown],[3,7,colors.darkBackpackBrown],[4,7,colors.darkBackpackBrown],[5,7,colors.darkBackpackBrown],[6,7,colors.darkBackpackBrown],[7,7,colors.darkBackpackBrown],[8,7,colors.darkBackpackBrown],
            [2,8,colors.black],[3,8,colors.backpackBrown],[4,8,colors.darkBackpackBrown],[5,8,colors.backpackBrown],[6,8,colors.backpackBrown],[7,8,colors.backpackBrown],[8,8,colors.darkBackpackBrown],
            [2,9,colors.black],[3,9,colors.black],[4,9,colors.pantsGrey],[5,9,colors.pantsGrey],[6,9,colors.black],[7,9,colors.black],[8,9,colors.pantsGrey],[9,9,colors.pantsGrey],
            [3,10,colors.pantsGrey],[4,10,colors.pantsGrey],[5,10,colors.pantsGrey],[8,10,colors.pantsGrey],[9,10,colors.pantsGrey],
            [3,11,colors.darkPantsGrey],[4,11,colors.darkPantsGrey],[5,11,colors.darkPantsGrey],[8,11,colors.darkPantsGrey],[9,11,colors.darkPantsGrey],
        ],
        'standing_down_right': [
            // Hat (angled down-right - showing right side of hat)
            [6,0,colors.hatGreen],[7,0,colors.hatGreen],[8,0,colors.hatGreen],[9,0,colors.hatGreen],[10,0,colors.hatGreen],
            [5,1,colors.hatGreen],[6,1,colors.darkHatGreen],[7,1,colors.darkHatGreen],[8,1,colors.darkHatGreen],[9,1,colors.darkHatGreen],[10,1,colors.darkHatGreen],[11,1,colors.hatGreen],
            [6,2,colors.hatGreen],[7,2,colors.hatGreen],[8,2,colors.hatGreen],[9,2,colors.hatGreen],[10,2,colors.hatGreen],[11,2,colors.hatGreen],[12,2,colors.hatGreen],
            [6,3,colors.black],[7,3,colors.black],[8,3,colors.black],[9,3,colors.black],[10,3,colors.black],[11,3,colors.black],[12,3,colors.black],
            [5,4,colors.black],[6,4,colors.skin],[7,4,colors.skin],[8,4,colors.skin],[9,4,colors.skin],[10,4,colors.skin],[11,4,colors.skin],[12,4,colors.black],
            [4,5,colors.black],[5,5,colors.black],[6,5,colors.black],[7,5,colors.black],[8,5,colors.black],[9,5,colors.black],[10,5,colors.black],[11,5,colors.black],[12,5,colors.black],
            // Backpack (showing right side prominently)
            [4,6,colors.black],[5,6,colors.backpackBrown],[6,6,colors.backpackBrown],[7,6,colors.backpackBrown],[8,6,colors.backpackBrown],[9,6,colors.backpackBrown],[10,6,colors.backpackBrown],[11,6,colors.backpackBrown],[12,6,colors.black],
            [4,7,colors.black],[5,7,colors.backpackBrown],[6,7,colors.darkBackpackBrown],[7,7,colors.darkBackpackBrown],[8,7,colors.darkBackpackBrown],[9,7,colors.darkBackpackBrown],[10,7,colors.darkBackpackBrown],[11,7,colors.darkBackpackBrown],[12,7,colors.black],
            [5,8,colors.black],[6,8,colors.backpackBrown],[7,8,colors.darkBackpackBrown],[8,8,colors.backpackBrown],[9,8,colors.backpackBrown],[10,8,colors.backpackBrown],[11,8,colors.darkBackpackBrown],[12,8,colors.black],
            [5,9,colors.black],[6,9,colors.black],[7,9,colors.pantsGrey],[8,9,colors.pantsGrey],[10,9,colors.black],[11,9,colors.pantsGrey],[12,9,colors.pantsGrey],[13,9,colors.black],
            [6,10,colors.pantsGrey],[7,10,colors.pantsGrey],[8,10,colors.pantsGrey],[11,10,colors.pantsGrey],[12,10,colors.pantsGrey],
            [6,11,colors.darkPantsGrey],[7,11,colors.darkPantsGrey],[8,11,colors.darkPantsGrey],[11,11,colors.darkPantsGrey],[12,11,colors.darkPantsGrey],
            [4,5,colors.black],[5,5,colors.black],[6,5,colors.black],[7,5,colors.black],[8,5,colors.black],[9,5,colors.black],[10,5,colors.black],[11,5,colors.black],[12,5,colors.black],
            // Backpack (showing right side prominently)
            [4,6,colors.black],[5,6,colors.backpackBrown],[6,6,colors.backpackBrown],[7,6,colors.backpackBrown],[8,6,colors.backpackBrown],[9,6,colors.backpackBrown],[10,6,colors.backpackBrown],[11,6,colors.backpackBrown],[12,6,colors.black],
            [4,7,colors.black],[5,7,colors.backpackBrown],[6,7,colors.darkBackpackBrown],[7,7,colors.darkBackpackBrown],[8,7,colors.darkBackpackBrown],[9,7,colors.darkBackpackBrown],[10,7,colors.darkBackpackBrown],[11,7,colors.darkBackpackBrown],[12,7,colors.black],
            [5,8,colors.black],[6,8,colors.backpackBrown],[7,8,colors.darkBackpackBrown],[8,8,colors.backpackBrown],[9,8,colors.backpackBrown],[10,8,colors.backpackBrown],[11,8,colors.darkBackpackBrown],[12,8,colors.black],
            [5,9,colors.black],[6,9,colors.black],[7,9,colors.pantsGrey],[8,9,colors.pantsGrey],[10,9,colors.black],[11,9,colors.pantsGrey],[12,9,colors.pantsGrey],[13,9,colors.black],
            [6,10,colors.pantsGrey],[7,10,colors.pantsGrey],[8,10,colors.pantsGrey],[11,10,colors.pantsGrey],[12,10,colors.pantsGrey],
            [6,11,colors.darkPantsGrey],[7,11,colors.darkPantsGrey],[8,11,colors.darkPantsGrey],[11,11,colors.darkPantsGrey],[12,11,colors.darkPantsGrey],
        ],
    };

    const toolFrames = {
        'using_axe_down': [
            ...spriteData.standing_down,
            // Right arm raised
            [0,7,colors.black],[1,7,colors.skin],[2,7,colors.skin],[3,7,colors.black],
            [0,8,colors.black],[1,8,colors.skin],[2,8,colors.black],
            [1,9,colors.black],[2,9,colors.black],
             // Axe
            [3,5,colors.toolHandle],[4,6,colors.toolHandle],[5,7,colors.toolHandle],
            [1,3,colors.toolHead],[2,4,colors.toolHead],[3,4,colors.toolHead],
            [1,4,colors.toolHead],[2,3,colors.toolHead],[3,3,colors.toolHead]
        ],
        'using_pickaxe_down': [
            ...spriteData.standing_down,
            [0,7,colors.black],[1,7,colors.skin],[2,7,colors.skin],[3,7,colors.black],
            [0,8,colors.black],[1,8,colors.skin],[2,8,colors.black],
            [1,9,colors.black],[2,9,colors.black],
            [3,5,colors.toolHandle],[4,6,colors.toolHandle],[5,7,colors.toolHandle],
            // Pickaxe Head
            [0,3,colors.toolHead],[1,3,colors.toolHead],[2,3,colors.toolHead],[3,3,colors.toolHead],[2,4,colors.toolHead],
        ],
         'using_sword_down': [
            ...spriteData.standing_down,
            [0,7,colors.black],[1,7,colors.skin],[2,7,colors.skin],[3,7,colors.black],
            [0,8,colors.black],[1,8,colors.skin],[2,8,colors.black],
            [1,9,colors.black],[2,9,colors.black],
            [4,5,colors.swordHilt],[5,6,colors.swordHilt],[6,7,colors.swordHilt],
            [5,4,colors.swordBlade],[6,3,colors.swordBlade],[7,2,colors.swordBlade],
        ],
        'using_axe_up': [
             ...spriteData.standing_up,
             [1,5,colors.toolHandle],[2,5,colors.toolHandle],[3,5,colors.toolHandle],
             [-1,3,colors.toolHead],[0,3,colors.toolHead],[1,3,colors.toolHead],
             [-1,4,colors.toolHead],[0,4,colors.toolHead],[0,2,colors.toolHead]
        ],
        'using_pickaxe_up': [
             ...spriteData.standing_up,
             [1,5,colors.toolHandle],[2,5,colors.toolHandle],[3,5,colors.toolHandle],
             [-2,3,colors.toolHead],[-1,3,colors.toolHead],[0,3,colors.toolHead],[1,3,colors.toolHead],[0,4,colors.toolHead],
        ],
         'using_sword_up': [
             ...spriteData.standing_up,
             [2,5,colors.swordHilt],[3,5,colors.swordHilt],[4,5,colors.swordHilt],
             [3,4,colors.swordBlade],[3,3,colors.swordBlade],[3,2,colors.swordBlade],
        ],
        'using_axe_left': [
            ...spriteData.standing_left,
            [10,6,colors.black],[11,6,colors.skin],[12,6,colors.black],
            [11,7,colors.skin],[10,8,colors.toolHandle],[11,8,colors.skin],[12,8,colors.black],
            [9,7,colors.toolHandle],[8,6,colors.toolHead],[9,6,colors.toolHead],[10,6,colors.toolHead],
            [8,5,colors.toolHead],[9,5,colors.toolHead],[9,4,colors.toolHead]
        ],
        'using_pickaxe_left': [
            ...spriteData.standing_left,
            [10,6,colors.black],[11,6,colors.skin],[12,6,colors.black],
            [11,7,colors.skin],[10,8,colors.toolHandle],[11,8,colors.skin],[12,8,colors.black],
            [9,7,colors.toolHandle],[7,5,colors.toolHead],[8,5,colors.toolHead],[9,5,colors.toolHead],[10,5,colors.toolHead],[9,6,colors.toolHead],
        ],
         'using_sword_left': [
            ...spriteData.standing_left,
            [10,6,colors.black],[11,6,colors.skin],[12,6,colors.black],
            [11,7,colors.skin],[10,8,colors.swordHilt],[11,8,colors.skin],[12,8,colors.black],
            [9,7,colors.swordHilt],[8,6,colors.swordBlade],[7,5,colors.swordBlade],[6,4,colors.swordBlade],
        ],
        // Diagonal movement frames - player facing diagonally
        'standing_up_left': [
            // Hat (angled up-left - showing left side of hat)
            [2,0,colors.hatGreen],[3,0,colors.hatGreen],[4,0,colors.hatGreen],[5,0,colors.hatGreen],[6,0,colors.hatGreen],
            [1,1,colors.hatGreen],[2,1,colors.darkHatGreen],[3,1,colors.darkHatGreen],[4,1,colors.darkHatGreen],[5,1,colors.darkHatGreen],[6,1,colors.darkHatGreen],[7,1,colors.hatGreen],
            [1,2,colors.hatGreen],[2,2,colors.hatGreen],[3,2,colors.hatGreen],[4,2,colors.hatGreen],[5,2,colors.hatGreen],[6,2,colors.hatGreen],[7,2,colors.hatGreen],
            [1,3,colors.black],[2,3,colors.skin],[3,3,colors.skin],[4,3,colors.skin],[5,3,colors.skin],[6,3,colors.skin],[7,3,colors.black],
            [1,4,colors.black],[2,4,colors.skin],[3,4,colors.black],[4,4,colors.skin],[5,4,colors.skin],[6,4,colors.skin],[7,4,colors.black],
            [2,5,colors.black],[3,5,colors.darkSkin],[4,5,colors.skin],[5,5,colors.darkSkin],[6,5,colors.darkSkin],[7,5,colors.black],
            // Body (showing left side prominently)
            [2,6,colors.black],[3,6,colors.black],[4,6,colors.black],[5,6,colors.black],[6,6,colors.black],
            [1,7,colors.black],[2,7,colors.shirtGrey],[3,7,colors.vestBrown],[4,7,colors.vestBrown],[5,7,colors.shirtGrey],[6,7,colors.black],
            [1,8,colors.black],[2,8,colors.skin],[3,8,colors.shirtGrey],[4,8,colors.shirtGrey],[5,8,colors.shirtGrey],[6,8,colors.skin],[7,8,colors.black],
            [1,9,colors.black],[2,9,colors.black],[3,9,colors.pantsGrey],[4,9,colors.pantsGrey],[5,9,colors.pantsGrey],[6,9,colors.black],[7,9,colors.black],
            [2,10,colors.pantsGrey],[3,10,colors.pantsGrey],[4,10,colors.pantsGrey],[5,10,colors.pantsGrey],[6,10,colors.pantsGrey],
            [2,11,colors.darkPantsGrey],[3,11,colors.darkPantsGrey],[4,11,colors.darkPantsGrey],[5,11,colors.darkPantsGrey],[6,11,colors.darkPantsGrey],
        ],
        'standing_up_right': [
            // Hat (angled up-right - showing right side of hat)
            [6,0,colors.hatGreen],[7,0,colors.hatGreen],[8,0,colors.hatGreen],[9,0,colors.hatGreen],[10,0,colors.hatGreen],
            [5,1,colors.hatGreen],[6,1,colors.darkHatGreen],[7,1,colors.darkHatGreen],[8,1,colors.darkHatGreen],[9,1,colors.darkHatGreen],[10,1,colors.darkHatGreen],[11,1,colors.hatGreen],
            [6,2,colors.hatGreen],[7,2,colors.hatGreen],[8,2,colors.hatGreen],[9,2,colors.hatGreen],[10,2,colors.hatGreen],[11,2,colors.hatGreen],[12,2,colors.hatGreen],
            [6,3,colors.black],[7,3,colors.skin],[8,3,colors.skin],[9,3,colors.skin],[10,3,colors.skin],[11,3,colors.skin],[12,3,colors.black],
            [6,4,colors.black],[7,4,colors.skin],[8,4,colors.black],[9,4,colors.skin],[10,4,colors.skin],[11,4,colors.skin],[12,4,colors.black],
            [6,5,colors.black],[7,5,colors.darkSkin],[8,5,colors.skin],[9,5,colors.darkSkin],[10,5,colors.darkSkin],[11,5,colors.black],
            // Body (showing right side prominently)
            [6,6,colors.black],[7,6,colors.black],[8,6,colors.black],[9,6,colors.black],[10,6,colors.black],
            [7,7,colors.black],[8,7,colors.shirtGrey],[9,7,colors.vestBrown],[10,7,colors.vestBrown],[11,7,colors.shirtGrey],[12,7,colors.black],
            [7,8,colors.black],[8,8,colors.skin],[9,8,colors.shirtGrey],[10,8,colors.shirtGrey],[11,8,colors.shirtGrey],[12,8,colors.skin],[13,8,colors.black],
            [7,9,colors.black],[8,9,colors.black],[9,9,colors.pantsGrey],[10,9,colors.pantsGrey],[11,9,colors.pantsGrey],[12,9,colors.black],[13,9,colors.black],
            [8,10,colors.pantsGrey],[9,10,colors.pantsGrey],[10,10,colors.pantsGrey],[11,10,colors.pantsGrey],[12,10,colors.pantsGrey],
            [8,11,colors.darkPantsGrey],[9,11,colors.darkPantsGrey],[10,11,colors.darkPantsGrey],[11,11,colors.darkPantsGrey],[12,11,colors.darkPantsGrey],
        ],
        'standing_down_left': [
            // Hat (angled down-left - showing left side of hat)
            [2,0,colors.hatGreen],[3,0,colors.hatGreen],[4,0,colors.hatGreen],[5,0,colors.hatGreen],[6,0,colors.hatGreen],
            [1,1,colors.hatGreen],[2,1,colors.darkHatGreen],[3,1,colors.darkHatGreen],[4,1,colors.darkHatGreen],[5,1,colors.darkHatGreen],[6,1,colors.darkHatGreen],[7,1,colors.hatGreen],
            [1,2,colors.hatGreen],[2,2,colors.hatGreen],[3,2,colors.hatGreen],[4,2,colors.hatGreen],[5,2,colors.hatGreen],[6,2,colors.hatGreen],[7,2,colors.hatGreen],
            [1,3,colors.black],[2,3,colors.black],[3,3,colors.black],[4,3,colors.black],[5,3,colors.black],[6,3,colors.black],[7,3,colors.black],
            [1,4,colors.black],[2,4,colors.skin],[3,4,colors.skin],[4,4,colors.skin],[5,4,colors.skin],[6,4,colors.skin],[7,4,colors.skin],[8,4,colors.black],
            [1,5,colors.black],[2,5,colors.black],[3,5,colors.black],[4,5,colors.black],[5,5,colors.black],[6,5,colors.black],[7,5,colors.black],[8,5,colors.black],[9,5,colors.black],
            // Backpack (showing left side prominently)
            [1,6,colors.black],[2,6,colors.backpackBrown],[3,6,colors.backpackBrown],[4,6,colors.backpackBrown],[5,6,colors.backpackBrown],[6,6,colors.backpackBrown],[7,6,colors.backpackBrown],[8,6,colors.backpackBrown],
            [1,7,colors.black],[2,7,colors.backpackBrown],[3,7,colors.darkBackpackBrown],[4,7,colors.darkBackpackBrown],[5,7,colors.darkBackpackBrown],[6,7,colors.darkBackpackBrown],[7,7,colors.darkBackpackBrown],[8,7,colors.darkBackpackBrown],
            [2,8,colors.black],[3,8,colors.backpackBrown],[4,8,colors.darkBackpackBrown],[5,8,colors.backpackBrown],[6,8,colors.backpackBrown],[7,8,colors.backpackBrown],[8,8,colors.darkBackpackBrown],
            [2,9,colors.black],[3,9,colors.black],[4,9,colors.pantsGrey],[5,9,colors.pantsGrey],[6,9,colors.black],[7,9,colors.black],[8,9,colors.pantsGrey],[9,9,colors.pantsGrey],
            [3,10,colors.pantsGrey],[4,10,colors.pantsGrey],[5,10,colors.pantsGrey],[8,10,colors.pantsGrey],[9,10,colors.pantsGrey],
            [3,11,colors.darkPantsGrey],[4,11,colors.darkPantsGrey],[5,11,colors.darkPantsGrey],[8,11,colors.darkPantsGrey],[9,11,colors.darkPantsGrey],
        ],
        'standing_down_right': [
            // Hat (angled down-right - showing right side of hat)
            [6,0,colors.hatGreen],[7,0,colors.hatGreen],[8,0,colors.hatGreen],[9,0,colors.hatGreen],[10,0,colors.hatGreen],
            [5,1,colors.hatGreen],[6,1,colors.darkHatGreen],[7,1,colors.darkHatGreen],[8,1,colors.darkHatGreen],[9,1,colors.darkHatGreen],[10,1,colors.darkHatGreen],[11,1,colors.hatGreen],
            [6,2,colors.hatGreen],[7,2,colors.hatGreen],[8,2,colors.hatGreen],[9,2,colors.hatGreen],[10,2,colors.hatGreen],[11,2,colors.hatGreen],[12,2,colors.hatGreen],
            [6,3,colors.black],[7,3,colors.black],[8,3,colors.black],[9,3,colors.black],[10,3,colors.black],[11,3,colors.black],[12,3,colors.black],
            [5,4,colors.black],[6,4,colors.skin],[7,4,colors.skin],[8,4,colors.skin],[9,4,colors.skin],[10,4,colors.skin],[11,4,colors.skin],[12,4,colors.black],
            [4,5,colors.black],[5,5,colors.black],[6,5,colors.black],[7,5,colors.black],[8,5,colors.black],[9,5,colors.black],[10,5,colors.black],[11,5,colors.black],[12,5,colors.black],
            // Backpack (showing right side prominently)
            [4,6,colors.black],[5,6,colors.backpackBrown],[6,6,colors.backpackBrown],[7,6,colors.backpackBrown],[8,6,colors.backpackBrown],[9,6,colors.backpackBrown],[10,6,colors.backpackBrown],[11,6,colors.backpackBrown],[12,6,colors.black],
            [4,7,colors.black],[5,7,colors.backpackBrown],[6,7,colors.darkBackpackBrown],[7,7,colors.darkBackpackBrown],[8,7,colors.darkBackpackBrown],[9,7,colors.darkBackpackBrown],[10,7,colors.darkBackpackBrown],[11,7,colors.darkBackpackBrown],[12,7,colors.black],
            [5,8,colors.black],[6,8,colors.backpackBrown],[7,8,colors.darkBackpackBrown],[8,8,colors.backpackBrown],[9,8,colors.backpackBrown],[10,8,colors.backpackBrown],[11,8,colors.darkBackpackBrown],[12,8,colors.black],
            [5,9,colors.black],[6,9,colors.black],[7,9,colors.pantsGrey],[8,9,colors.pantsGrey],[10,9,colors.black],[11,9,colors.pantsGrey],[12,9,colors.pantsGrey],[13,9,colors.black],
            [6,10,colors.pantsGrey],[7,10,colors.pantsGrey],[8,10,colors.pantsGrey],[11,10,colors.pantsGrey],[12,10,colors.pantsGrey],
            [6,11,colors.darkPantsGrey],[7,11,colors.darkPantsGrey],[8,11,colors.darkPantsGrey],[11,11,colors.darkPantsGrey],[12,11,colors.darkPantsGrey],
        ],
    };
    
    let pixels;
    let currentFrameData;

    if (frame in toolFrames) {
        currentFrameData = toolFrames[frame];
    } else if (frame in spriteData) {
        currentFrameData = spriteData[frame];
    } else {
        // Debug: log what frame was requested and what's available
        console.log('Player sprite frame not found:', frame);
        console.log('Available frames:', Object.keys(spriteData));
        currentFrameData = spriteData['standing_down']; // Fallback
    }
    
    // Create right-facing sprites by mirroring left-facing ones (but not for diagonal sprites)
    if (frame.includes('right') && !frame.includes('up_right') && !frame.includes('down_right')) {
        const leftFrameName = frame.replace('right', 'left');
        let sourceFrame;
        if (leftFrameName in toolFrames) {
            sourceFrame = toolFrames[leftFrameName];
        } else if (leftFrameName in spriteData) {
            sourceFrame = spriteData[leftFrameName];
        } else {
            sourceFrame = spriteData['standing_left'];
        }
        pixels = sourceFrame.map(([px, py, color]) => [SPRITE_WIDTH - 1 - px, py, color]);
    } else {
        pixels = currentFrameData;
    }

    pixels.forEach(([px, py, color]) => p(px, py, color));
    
    ctx.restore();
}

function drawAnimalSprite(x, y, frame) {
    const PIXEL_SIZE = 4;
    const SPRITE_WIDTH = 16;
    const SPRITE_HEIGHT = 16;
    const SPRITE_OFFSET_X = TILE_SIZE / 2 - (SPRITE_WIDTH * PIXEL_SIZE) / 2;
    const SPRITE_OFFSET_Y = 10;

    const colors = {
        grey: '#a1a1a1',
        darkGrey: '#6b6b6b',
        black: '#212121',
        white: '#ffffff',
        nose: '#303030'
    };

    ctx.save();
    ctx.translate(x + SPRITE_OFFSET_X, y + SPRITE_OFFSET_Y);

    const p = (px, py, color) => {
        ctx.fillStyle = color;
        ctx.fillRect(px * PIXEL_SIZE, py * PIXEL_SIZE, PIXEL_SIZE, PIXEL_SIZE);
    };

    const spriteData = {
        'standing_down': [
            [6, 3, colors.grey], [7, 3, colors.grey], [8, 3, colors.grey], [9, 3, colors.grey],
            [5, 4, colors.grey], [6, 4, colors.darkGrey], [7, 4, colors.darkGrey], [8, 4, colors.darkGrey], [9, 4, colors.darkGrey], [10, 4, colors.grey],
            [5, 5, colors.grey], [6, 5, colors.black], [7, 5, colors.nose], [8, 5, colors.nose], [9, 5, colors.black], [10, 5, colors.grey],
            [4, 6, colors.grey], [5, 6, colors.grey], [6, 6, colors.darkGrey], [7, 6, colors.darkGrey], [8, 6, colors.darkGrey], [9, 6, colors.darkGrey], [10, 6, colors.grey], [11, 6, colors.grey],
            [3, 7, colors.grey], [4, 7, colors.darkGrey], [5, 7, colors.darkGrey], [6, 7, colors.darkGrey], [7, 7, colors.darkGrey], [8, 7, colors.darkGrey], [9, 7, colors.darkGrey], [10, 7, colors.darkGrey], [11, 7, colors.grey], [12, 7, colors.grey],
            [3, 8, colors.grey], [4, 8, colors.darkGrey], [5, 8, colors.darkGrey], [6, 8, colors.grey], [7, 8, colors.grey], [8, 8, colors.grey], [9, 8, colors.grey], [10, 8, colors.darkGrey], [11, 8, colors.darkGrey], [12, 8, colors.grey],
            [4, 9, colors.grey], [5, 9, colors.grey], [9, 9, colors.grey], [10, 9, colors.grey],
            [4, 10, colors.darkGrey], [5, 10, colors.darkGrey], [9, 10, colors.darkGrey], [10, 10, colors.darkGrey],
            [7,9,colors.grey],[8,9,colors.grey],[7,10,colors.darkGrey]
        ],
        'walking_down_1': [
            [6, 3, colors.grey], [7, 3, colors.grey], [8, 3, colors.grey], [9, 3, colors.grey],
            [5, 4, colors.grey], [6, 4, colors.darkGrey], [7, 4, colors.darkGrey], [8, 4, colors.darkGrey], [9, 4, colors.darkGrey], [10, 4, colors.grey],
            [5, 5, colors.grey], [6, 5, colors.black], [7, 5, colors.nose], [8, 5, colors.nose], [9, 5, colors.black], [10, 5, colors.grey],
            [4, 6, colors.grey], [5, 6, colors.grey], [6, 6, colors.darkGrey], [7, 6, colors.darkGrey], [8, 6, colors.darkGrey], [9, 6, colors.darkGrey], [10, 6, colors.grey], [11, 6, colors.grey],
            [3, 7, colors.grey], [4, 7, colors.darkGrey], [5, 7, colors.darkGrey], [6, 7, colors.darkGrey], [7, 7, colors.darkGrey], [8, 7, colors.darkGrey], [9, 7, colors.darkGrey], [10, 7, colors.darkGrey], [11, 7, colors.grey], [12, 7, colors.grey],
            [3, 8, colors.grey], [4, 8, colors.darkGrey], [5, 8, colors.darkGrey], [6, 8, colors.grey], [7, 8, colors.grey], [8, 8, colors.grey], [9, 8, colors.grey], [10, 8, colors.darkGrey], [11, 8, colors.darkGrey], [12, 8, colors.grey],
            [3, 9, colors.grey], [4, 9, colors.grey], [9, 9, colors.grey], [10, 9, colors.grey],
            [3, 10, colors.darkGrey], [4, 10, colors.darkGrey], [9, 10, colors.darkGrey], [10, 10, colors.darkGrey],
            [7,9,colors.grey],[8,9,colors.grey],[7,10,colors.darkGrey]
        ],
        'walking_down_2': [
            [6, 3, colors.grey], [7, 3, colors.grey], [8, 3, colors.grey], [9, 3, colors.grey],
            [5, 4, colors.grey], [6, 4, colors.darkGrey], [7, 4, colors.darkGrey], [8, 4, colors.darkGrey], [9, 4, colors.darkGrey], [10, 4, colors.grey],
            [5, 5, colors.grey], [6, 5, colors.black], [7, 5, colors.nose], [8, 5, colors.nose], [9, 5, colors.black], [10, 5, colors.grey],
            [4, 6, colors.grey], [5, 6, colors.grey], [6, 6, colors.darkGrey], [7, 6, colors.darkGrey], [8, 6, colors.darkGrey], [9, 6, colors.darkGrey], [10, 6, colors.grey], [11, 6, colors.grey],
            [3, 7, colors.grey], [4, 7, colors.darkGrey], [5, 7, colors.darkGrey], [6, 7, colors.darkGrey], [7, 7, colors.darkGrey], [8, 7, colors.darkGrey], [9, 7, colors.darkGrey], [10, 7, colors.darkGrey], [11, 7, colors.grey], [12, 7, colors.grey],
            [3, 8, colors.grey], [4, 8, colors.darkGrey], [5, 8, colors.darkGrey], [6, 8, colors.grey], [7, 8, colors.grey], [8, 8, colors.grey], [9, 8, colors.grey], [10, 8, colors.darkGrey], [11, 8, colors.darkGrey], [12, 8, colors.grey],
            [4, 9, colors.grey], [5, 9, colors.grey], [10, 9, colors.grey], [11, 9, colors.grey],
            [4, 10, colors.darkGrey], [5, 10, colors.darkGrey], [10, 10, colors.darkGrey], [11, 10, colors.darkGrey],
            [7,9,colors.grey],[8,9,colors.grey],[7,10,colors.darkGrey]
        ],
         'standing_up': [
            [6, 3, colors.grey], [7, 3, colors.grey], [8, 3, colors.grey], [9, 3, colors.grey],
            [5, 4, colors.grey], [6, 4, colors.darkGrey], [7, 4, colors.darkGrey], [8, 4, colors.darkGrey], [9, 4, colors.darkGrey], [10, 4, colors.grey],
            [4, 5, colors.grey], [5, 5, colors.grey], [6, 5, colors.darkGrey], [7, 5, colors.darkGrey], [8, 5, colors.darkGrey], [9, 5, colors.darkGrey], [10, 5, colors.grey], [11, 5, colors.grey],
            [3, 6, colors.grey], [4, 6, colors.darkGrey], [5, 6, colors.darkGrey], [6, 6, colors.grey], [7, 6, colors.grey], [8, 6, colors.grey], [9, 6, colors.grey], [10, 6, colors.darkGrey], [11, 6, colors.darkGrey], [12, 6, colors.grey],
            [3, 7, colors.grey], [4, 7, colors.darkGrey], [5, 7, colors.darkGrey], [6, 7, colors.darkGrey], [7, 7, colors.darkGrey], [8, 7, colors.darkGrey], [9, 7, colors.darkGrey], [10, 7, colors.darkGrey], [11, 7, colors.darkGrey], [12, 7, colors.grey],
            [4, 8, colors.grey], [5, 8, colors.grey], [9, 8, colors.grey], [10, 8, colors.grey],
            [4, 9, colors.darkGrey], [5, 9, colors.darkGrey], [9, 9, colors.darkGrey], [10, 9, colors.darkGrey],
        ],
        'walking_up_1': [
            [6, 3, colors.grey], [7, 3, colors.grey], [8, 3, colors.grey], [9, 3, colors.grey],
            [5, 4, colors.grey], [6, 4, colors.darkGrey], [7, 4, colors.darkGrey], [8, 4, colors.darkGrey], [9, 4, colors.darkGrey], [10, 4, colors.grey],
            [4, 5, colors.grey], [5, 5, colors.grey], [6, 5, colors.darkGrey], [7, 5, colors.darkGrey], [8, 5, colors.darkGrey], [9, 5, colors.darkGrey], [10, 5, colors.grey], [11, 5, colors.grey],
            [3, 6, colors.grey], [4, 6, colors.darkGrey], [5, 6, colors.darkGrey], [6, 6, colors.grey], [7, 6, colors.grey], [8, 6, colors.grey], [9, 6, colors.grey], [10, 6, colors.darkGrey], [11, 6, colors.darkGrey], [12, 6, colors.grey],
            [3, 7, colors.grey], [4, 7, colors.darkGrey], [5, 7, colors.darkGrey], [6, 7, colors.darkGrey], [7, 7, colors.darkGrey], [8, 7, colors.darkGrey], [9, 7, colors.darkGrey], [10, 7, colors.darkGrey], [11, 7, colors.darkGrey], [12, 7, colors.grey],
            [3, 8, colors.grey], [4, 8, colors.grey], [9, 8, colors.grey], [10, 8, colors.grey],
            [3, 9, colors.darkGrey], [4, 9, colors.darkGrey], [9, 9, colors.darkGrey], [10, 9, colors.darkGrey],
        ],
        'walking_up_2': [
            [6, 3, colors.grey], [7, 3, colors.grey], [8, 3, colors.grey], [9, 3, colors.grey],
            [5, 4, colors.grey], [6, 4, colors.darkGrey], [7, 4, colors.darkGrey], [8, 4, colors.darkGrey], [9, 4, colors.darkGrey], [10, 4, colors.grey],
            [4, 5, colors.grey], [5, 5, colors.grey], [6, 5, colors.darkGrey], [7, 5, colors.darkGrey], [8, 5, colors.darkGrey], [9, 5, colors.darkGrey], [10, 5, colors.grey], [11, 5, colors.grey],
            [3, 6, colors.grey], [4, 6, colors.darkGrey], [5, 6, colors.darkGrey], [6, 6, colors.grey], [7, 6, colors.grey], [8, 6, colors.grey], [9, 6, colors.grey], [10, 6, colors.darkGrey], [11, 6, colors.darkGrey], [12, 6, colors.grey],
            [3, 7, colors.grey], [4, 7, colors.darkGrey], [5, 7, colors.darkGrey], [6, 7, colors.darkGrey], [7, 7, colors.darkGrey], [8, 7, colors.darkGrey], [9, 7, colors.darkGrey], [10, 7, colors.darkGrey], [11, 7, colors.darkGrey], [12, 7, colors.grey],
            [4, 8, colors.grey], [5, 8, colors.grey], [10, 8, colors.grey], [11, 8, colors.grey],
            [4, 9, colors.darkGrey], [5, 9, colors.darkGrey], [10, 9, colors.darkGrey], [11, 9, colors.darkGrey],
        ],
         'standing_left': [
            [3,4,colors.grey],[4,4,colors.grey],
            [2,5,colors.grey],[3,5,colors.darkGrey],[4,5,colors.darkGrey],
            [1,6,colors.nose],[2,6,colors.grey],[3,6,colors.black],
            [4,6,colors.darkGrey],[5,6,colors.grey],[6,6,colors.grey],
            [3,7,colors.darkGrey],[4,7,colors.grey],[5,7,colors.grey],[6,7,colors.grey],[7,7,colors.grey],
            [3,8,colors.darkGrey],[4,8,colors.grey],[5,8,colors.grey],[6,8,colors.grey],[7,8,colors.grey],
            [4,9,colors.grey],[6,9,colors.grey],[4,10,colors.darkGrey],[6,10,colors.darkGrey],
            [8,7,colors.grey],[9,7,colors.grey],[8,8,colors.darkGrey]
        ],
        'walking_left_1': [
            [3,4,colors.grey],[4,4,colors.grey],
            [2,5,colors.grey],[3,5,colors.darkGrey],[4,5,colors.darkGrey],
            [1,6,colors.nose],[2,6,colors.grey],[3,6,colors.black],
            [4,6,colors.darkGrey],[5,6,colors.grey],[6,6,colors.grey],
            [3,7,colors.darkGrey],[4,7,colors.grey],[5,7,colors.grey],[6,7,colors.grey],[7,7,colors.grey],
            [3,8,colors.darkGrey],[4,8,colors.grey],[5,8,colors.grey],[6,8,colors.grey],[7,8,colors.grey],
            [3,9,colors.grey],[6,9,colors.grey],[3,10,colors.darkGrey],[6,10,colors.darkGrey],
            [8,7,colors.grey],[9,7,colors.grey],[8,8,colors.darkGrey]
        ],
    };
    
    let pixels;
    if (frame in spriteData) {
        pixels = spriteData[frame];
    } else {
        pixels = spriteData['standing_down'];
    }

    if (frame.includes('right')) {
        const leftFrame = frame.replace('right', 'left');
        pixels = spriteData[leftFrame].map(([px, py, color]) => [SPRITE_WIDTH - 1 - px, py, color]);
    }

    pixels.forEach(([px, py, color]) => p(px, py, color));

    ctx.restore();
}

function drawWizardSprite(x, y, frame) {
    const PIXEL_SIZE = 4;
    const SPRITE_WIDTH = 16;
    const SPRITE_HEIGHT = 16;
    const SPRITE_OFFSET_X = TILE_SIZE / 2 - (SPRITE_WIDTH * PIXEL_SIZE) / 2;
    const SPRITE_OFFSET_Y = 10;

    const colors = {
        robeGrey: '#808080',
        darkRobeGrey: '#606060',
        hatGrey: '#a0a0a0',
        darkHatGrey: '#808080',
        beardGrey: '#c0c0c0',
        darkBeardGrey: '#a0a0a0',
        skin: '#fbd7a3',
        darkSkin: '#e4a768',
        staffBrown: '#8b4513',
        darkStaffBrown: '#654321',
        black: '#212121',
        white: '#ffffff',
    };

    ctx.save();
    ctx.translate(x + SPRITE_OFFSET_X, y + SPRITE_OFFSET_Y);

    const p = (px, py, color) => {
        ctx.fillStyle = color;
        ctx.fillRect(px * PIXEL_SIZE, py * PIXEL_SIZE, PIXEL_SIZE, PIXEL_SIZE);
    };

    const spriteData = {
        'standing_down': [
            // Pointy hat
            [6,0,colors.hatGrey],[7,0,colors.hatGrey],[8,0,colors.hatGrey],[9,0,colors.hatGrey],
            [5,1,colors.hatGrey],[6,1,colors.darkHatGrey],[7,1,colors.darkHatGrey],[8,1,colors.darkHatGrey],[9,1,colors.darkHatGrey],[10,1,colors.hatGrey],
            [4,2,colors.hatGrey],[5,2,colors.hatGrey],[6,2,colors.hatGrey],[7,2,colors.hatGrey],[8,2,colors.hatGrey],[9,2,colors.hatGrey],[10,2,colors.hatGrey],[11,2,colors.hatGrey],
            [3,3,colors.hatGrey],[4,3,colors.hatGrey],[5,3,colors.hatGrey],[6,3,colors.hatGrey],[7,3,colors.hatGrey],[8,3,colors.hatGrey],[9,3,colors.hatGrey],[10,3,colors.hatGrey],[11,3,colors.hatGrey],[12,3,colors.hatGrey],
            [3,4,colors.black],[4,4,colors.skin],[5,4,colors.skin],[6,4,colors.skin],[7,4,colors.skin],[8,4,colors.skin],[9,4,colors.skin],[10,4,colors.skin],[11,4,colors.skin],[12,4,colors.black],
            [3,5,colors.black],[4,5,colors.skin],[5,5,colors.black],[6,5,colors.skin],[7,5,colors.skin],[8,5,colors.skin],[9,5,colors.black],[10,5,colors.skin],[11,5,colors.skin],[12,5,colors.black],
            [4,6,colors.darkSkin],[5,6,colors.skin],[6,6,colors.darkSkin],[7,6,colors.darkSkin],[8,6,colors.darkSkin],[9,6,colors.darkSkin],[10,6,colors.skin],[11,6,colors.darkSkin],
            // Grey robe
            [3,7,colors.black],[4,7,colors.black],[5,7,colors.black],[6,7,colors.black],[7,7,colors.black],[8,7,colors.black],[9,7,colors.black],[10,7,colors.black],[11,7,colors.black],[12,7,colors.black],
            [2,8,colors.black],[3,8,colors.robeGrey],[4,8,colors.robeGrey],[5,8,colors.robeGrey],[6,8,colors.robeGrey],[7,8,colors.robeGrey],[8,8,colors.robeGrey],[9,8,colors.robeGrey],[10,8,colors.robeGrey],[11,8,colors.robeGrey],[12,8,colors.robeGrey],[13,8,colors.black],
            [2,9,colors.black],[3,9,colors.robeGrey],[4,9,colors.robeGrey],[5,9,colors.robeGrey],[6,9,colors.robeGrey],[7,9,colors.robeGrey],[8,9,colors.robeGrey],[9,9,colors.robeGrey],[10,9,colors.robeGrey],[11,9,colors.robeGrey],[12,9,colors.robeGrey],[13,9,colors.black],
            [3,10,colors.robeGrey],[4,10,colors.robeGrey],[5,10,colors.robeGrey],[6,10,colors.robeGrey],[7,10,colors.robeGrey],[8,10,colors.robeGrey],[9,10,colors.robeGrey],[10,10,colors.robeGrey],[11,10,colors.robeGrey],
            [3,11,colors.darkRobeGrey],[4,11,colors.darkRobeGrey],[5,11,colors.darkRobeGrey],[6,11,colors.darkRobeGrey],[7,11,colors.darkRobeGrey],[8,11,colors.darkRobeGrey],[9,11,colors.darkRobeGrey],[10,11,colors.darkRobeGrey],[11,11,colors.darkRobeGrey],
            // Long grey beard
            [2,6,colors.beardGrey],[3,6,colors.beardGrey],[12,6,colors.beardGrey],[13,6,colors.beardGrey],
            [1,7,colors.beardGrey],[2,7,colors.darkBeardGrey],[3,7,colors.darkBeardGrey],[12,7,colors.darkBeardGrey],[13,7,colors.darkBeardGrey],[14,7,colors.beardGrey],
            [1,8,colors.beardGrey],[2,8,colors.darkBeardGrey],[13,8,colors.darkBeardGrey],[14,8,colors.beardGrey],
            [1,9,colors.beardGrey],[2,9,colors.darkBeardGrey],[13,9,colors.darkBeardGrey],[14,9,colors.beardGrey],
            [1,10,colors.beardGrey],[2,10,colors.darkBeardGrey],[13,10,colors.darkBeardGrey],[14,10,colors.beardGrey],
            [1,11,colors.beardGrey],[2,11,colors.darkBeardGrey],[13,11,colors.darkBeardGrey],[14,11,colors.beardGrey],
            // Wood staff
            [0,8,colors.staffBrown],[1,8,colors.darkStaffBrown],
            [0,9,colors.staffBrown],[1,9,colors.darkStaffBrown],
            [0,10,colors.staffBrown],[1,10,colors.darkStaffBrown],
            [0,11,colors.staffBrown],[1,11,colors.darkStaffBrown],
        ],
        'standing_up': [
            // Pointy hat
            [6,0,colors.hatGrey],[7,0,colors.hatGrey],[8,0,colors.hatGrey],[9,0,colors.hatGrey],
            [5,1,colors.hatGrey],[6,1,colors.darkHatGrey],[7,1,colors.darkHatGrey],[8,1,colors.darkHatGrey],[9,1,colors.darkHatGrey],[10,1,colors.hatGrey],
            [4,2,colors.hatGrey],[5,2,colors.hatGrey],[6,2,colors.hatGrey],[7,2,colors.hatGrey],[8,2,colors.hatGrey],[9,2,colors.hatGrey],[10,2,colors.hatGrey],[11,2,colors.hatGrey],
            [3,3,colors.hatGrey],[4,3,colors.hatGrey],[5,3,colors.hatGrey],[6,3,colors.hatGrey],[7,3,colors.hatGrey],[8,3,colors.hatGrey],[9,3,colors.hatGrey],[10,3,colors.hatGrey],[11,3,colors.hatGrey],[12,3,colors.hatGrey],
            [3,4,colors.black],[4,4,colors.skin],[5,4,colors.skin],[6,4,colors.skin],[7,4,colors.skin],[8,4,colors.skin],[9,4,colors.skin],[10,4,colors.skin],[11,4,colors.skin],[12,4,colors.black],
            [3,5,colors.black],[4,5,colors.skin],[5,5,colors.black],[6,5,colors.skin],[7,5,colors.skin],[8,5,colors.skin],[9,5,colors.black],[10,5,colors.skin],[11,5,colors.skin],[12,5,colors.black],
            [4,6,colors.darkSkin],[5,6,colors.skin],[6,6,colors.darkSkin],[7,6,colors.darkSkin],[8,6,colors.darkSkin],[9,6,colors.darkSkin],[10,6,colors.skin],[11,6,colors.darkSkin],
            // Grey robe
            [3,7,colors.black],[4,7,colors.black],[5,7,colors.black],[6,7,colors.black],[7,7,colors.black],[8,7,colors.black],[9,7,colors.black],[10,7,colors.black],[11,7,colors.black],[12,7,colors.black],
            [2,8,colors.black],[3,8,colors.robeGrey],[4,8,colors.robeGrey],[5,8,colors.robeGrey],[6,8,colors.robeGrey],[7,8,colors.robeGrey],[8,8,colors.robeGrey],[9,8,colors.robeGrey],[10,8,colors.robeGrey],[11,8,colors.robeGrey],[12,8,colors.robeGrey],[13,8,colors.black],
            [2,9,colors.black],[3,9,colors.robeGrey],[4,9,colors.robeGrey],[5,9,colors.robeGrey],[6,9,colors.robeGrey],[7,9,colors.robeGrey],[8,9,colors.robeGrey],[9,9,colors.robeGrey],[10,9,colors.robeGrey],[11,9,colors.robeGrey],[12,9,colors.robeGrey],[13,9,colors.black],
            [3,10,colors.robeGrey],[4,10,colors.robeGrey],[5,10,colors.robeGrey],[6,10,colors.robeGrey],[7,10,colors.robeGrey],[8,10,colors.robeGrey],[9,10,colors.robeGrey],[10,10,colors.robeGrey],[11,10,colors.robeGrey],
            [3,11,colors.darkRobeGrey],[4,11,colors.darkRobeGrey],[5,11,colors.darkRobeGrey],[6,11,colors.darkRobeGrey],[7,11,colors.darkRobeGrey],[8,11,colors.darkRobeGrey],[9,11,colors.darkRobeGrey],[10,11,colors.darkRobeGrey],[11,11,colors.darkRobeGrey],
            // Long grey beard
            [2,6,colors.beardGrey],[3,6,colors.beardGrey],[12,6,colors.beardGrey],[13,6,colors.beardGrey],
            [1,7,colors.beardGrey],[2,7,colors.darkBeardGrey],[3,7,colors.darkBeardGrey],[12,7,colors.darkBeardGrey],[13,7,colors.darkBeardGrey],[14,7,colors.beardGrey],
            [1,8,colors.beardGrey],[2,8,colors.darkBeardGrey],[13,8,colors.darkBeardGrey],[14,8,colors.beardGrey],
            [1,9,colors.beardGrey],[2,9,colors.darkBeardGrey],[13,9,colors.darkBeardGrey],[14,9,colors.beardGrey],
            [1,10,colors.beardGrey],[2,10,colors.darkBeardGrey],[13,10,colors.darkBeardGrey],[14,10,colors.beardGrey],
            [1,11,colors.beardGrey],[2,11,colors.darkBeardGrey],[13,11,colors.darkBeardGrey],[14,11,colors.beardGrey],
            // Wood staff
            [0,8,colors.staffBrown],[1,8,colors.darkStaffBrown],
            [0,9,colors.staffBrown],[1,9,colors.darkStaffBrown],
            [0,10,colors.staffBrown],[1,10,colors.darkStaffBrown],
            [0,11,colors.staffBrown],[1,11,colors.darkStaffBrown],
        ],
        'standing_left': [
            // Pointy hat
            [4,0,colors.hatGrey],[5,0,colors.hatGrey],[6,0,colors.hatGrey],[7,0,colors.hatGrey],[8,0,colors.hatGrey],
            [3,1,colors.hatGrey],[4,1,colors.darkHatGrey],[5,1,colors.darkHatGrey],[6,1,colors.darkHatGrey],[7,1,colors.darkHatGrey],[8,1,colors.darkHatGrey],[9,1,colors.hatGrey],
            [2,2,colors.hatGrey],[3,2,colors.hatGrey],[4,2,colors.hatGrey],[5,2,colors.hatGrey],[6,2,colors.hatGrey],[7,2,colors.hatGrey],[8,2,colors.hatGrey],[9,2,colors.hatGrey],
            [2,3,colors.hatGrey],[3,3,colors.hatGrey],[4,3,colors.hatGrey],[5,3,colors.hatGrey],[6,3,colors.hatGrey],[7,3,colors.hatGrey],[8,3,colors.hatGrey],[9,3,colors.hatGrey],
            [2,4,colors.black],[3,4,colors.skin],[4,4,colors.skin],[5,4,colors.skin],[6,4,colors.skin],[7,4,colors.skin],[8,4,colors.black],
            [2,5,colors.black],[3,5,colors.skin],[4,5,colors.black],[5,5,colors.skin],[6,5,colors.skin],[7,5,colors.skin],[8,5,colors.black],[9,5,colors.black],
            [2,6,colors.black],[3,6,colors.darkSkin],[4,6,colors.skin],[5,6,colors.darkSkin],[6,6,colors.darkSkin],[7,6,colors.darkSkin],[8,6,colors.black],
            [3,7,colors.black],[4,7,colors.black],[5,7,colors.black],[6,7,colors.black],[7,7,colors.black],[8,7,colors.black],
            [2,8,colors.black],[3,8,colors.robeGrey],[4,8,colors.robeGrey],[5,8,colors.robeGrey],[6,8,colors.robeGrey],[7,8,colors.robeGrey],[8,8,colors.black],
            [2,9,colors.black],[3,9,colors.robeGrey],[4,9,colors.robeGrey],[5,9,colors.robeGrey],[6,9,colors.robeGrey],[7,9,colors.robeGrey],[8,9,colors.black],
            [3,10,colors.robeGrey],[4,10,colors.robeGrey],[5,10,colors.robeGrey],[6,10,colors.robeGrey],[7,10,colors.robeGrey],
            [3,11,colors.darkRobeGrey],[4,11,colors.darkRobeGrey],[5,11,colors.darkRobeGrey],[6,11,colors.darkRobeGrey],[7,11,colors.darkRobeGrey],
            // Long grey beard
            [1,6,colors.beardGrey],[2,6,colors.beardGrey],[9,6,colors.beardGrey],
            [0,7,colors.beardGrey],[1,7,colors.darkBeardGrey],[2,7,colors.darkBeardGrey],[9,7,colors.darkBeardGrey],[10,7,colors.beardGrey],
            [0,8,colors.beardGrey],[1,8,colors.darkBeardGrey],[9,8,colors.darkBeardGrey],[10,8,colors.beardGrey],
            [0,9,colors.beardGrey],[1,9,colors.darkBeardGrey],[9,9,colors.darkBeardGrey],[10,9,colors.beardGrey],
            [0,10,colors.beardGrey],[1,10,colors.darkBeardGrey],[9,10,colors.darkBeardGrey],[10,10,colors.beardGrey],
            [0,11,colors.beardGrey],[1,11,colors.darkBeardGrey],[9,11,colors.darkBeardGrey],[10,11,colors.beardGrey],
            // Wood staff
            [11,8,colors.staffBrown],[12,8,colors.darkStaffBrown],
            [11,9,colors.staffBrown],[12,9,colors.darkStaffBrown],
            [11,10,colors.staffBrown],[12,10,colors.darkStaffBrown],
            [11,11,colors.staffBrown],[12,11,colors.darkStaffBrown],
        ],
    };
    
    let pixels;
    if (frame in spriteData) {
        pixels = spriteData[frame];
    } else {
        pixels = spriteData['standing_down'];
    }

    if (frame.includes('right')) {
        const leftFrame = frame.replace('right', 'left');
        pixels = spriteData[leftFrame].map(([px, py, color]) => [SPRITE_WIDTH - 1 - px, py, color]);
    }

    pixels.forEach(([px, py, color]) => p(px, py, color));

    ctx.restore();
}

function drawRabbitSprite(x, y, frame) {
    const PIXEL_SIZE = 3;
    const SPRITE_WIDTH = 12;
    const SPRITE_HEIGHT = 12;
    const SPRITE_OFFSET_X = TILE_SIZE / 2 - (SPRITE_WIDTH * PIXEL_SIZE) / 2;
    const SPRITE_OFFSET_Y = 15;

    const colors = {
        fur: '#d4a574',
        darkFur: '#b8860b',
        lightFur: '#f4e4bc',
        pink: '#ffb6c1',
        black: '#212121',
        white: '#ffffff',
    };

    ctx.save();
    ctx.translate(x + SPRITE_OFFSET_X, y + SPRITE_OFFSET_Y);

    const p = (px, py, color) => {
        ctx.fillStyle = color;
        ctx.fillRect(px * PIXEL_SIZE, py * PIXEL_SIZE, PIXEL_SIZE, PIXEL_SIZE);
    };

    const spriteData = {
        'standing_down': [
            // Ears
            [4,0,colors.fur],[5,0,colors.fur],[6,0,colors.fur],[7,0,colors.fur],
            [3,1,colors.fur],[4,1,colors.darkFur],[5,1,colors.darkFur],[6,1,colors.darkFur],[7,1,colors.darkFur],[8,1,colors.fur],
            [2,2,colors.fur],[3,2,colors.fur],[4,2,colors.fur],[5,2,colors.fur],[6,2,colors.fur],[7,2,colors.fur],[8,2,colors.fur],[9,2,colors.fur],
            // Face
            [3,3,colors.fur],[4,3,colors.lightFur],[5,3,colors.lightFur],[6,3,colors.lightFur],[7,3,colors.lightFur],[8,3,colors.fur],
            [3,4,colors.fur],[4,4,colors.lightFur],[5,4,colors.pink],[6,4,colors.pink],[7,4,colors.lightFur],[8,4,colors.fur],
            [3,5,colors.fur],[4,5,colors.lightFur],[5,5,colors.black],[6,5,colors.black],[7,5,colors.lightFur],[8,5,colors.fur],
            // Body
            [2,6,colors.fur],[3,6,colors.fur],[4,6,colors.fur],[5,6,colors.fur],[6,6,colors.fur],[7,6,colors.fur],[8,6,colors.fur],[9,6,colors.fur],
            [2,7,colors.fur],[3,7,colors.darkFur],[4,7,colors.darkFur],[5,7,colors.darkFur],[6,7,colors.darkFur],[7,7,colors.darkFur],[8,7,colors.darkFur],[9,7,colors.fur],
            [2,8,colors.fur],[3,8,colors.fur],[4,8,colors.fur],[5,8,colors.fur],[6,8,colors.fur],[7,8,colors.fur],[8,8,colors.fur],[9,8,colors.fur],
            // Legs
            [3,9,colors.darkFur],[4,9,colors.darkFur],[7,9,colors.darkFur],[8,9,colors.darkFur],
            [3,10,colors.darkFur],[4,10,colors.darkFur],[7,10,colors.darkFur],[8,10,colors.darkFur],
            [3,11,colors.darkFur],[4,11,colors.darkFur],[7,11,colors.darkFur],[8,11,colors.darkFur],
        ],
        'standing_up': [
            // Ears
            [4,0,colors.fur],[5,0,colors.fur],[6,0,colors.fur],[7,0,colors.fur],
            [3,1,colors.fur],[4,1,colors.darkFur],[5,1,colors.darkFur],[6,1,colors.darkFur],[7,1,colors.darkFur],[8,1,colors.fur],
            [2,2,colors.fur],[3,2,colors.fur],[4,2,colors.fur],[5,2,colors.fur],[6,2,colors.fur],[7,2,colors.fur],[8,2,colors.fur],[9,2,colors.fur],
            // Face
            [3,3,colors.fur],[4,3,colors.lightFur],[5,3,colors.lightFur],[6,3,colors.lightFur],[7,3,colors.lightFur],[8,3,colors.fur],
            [3,4,colors.fur],[4,4,colors.lightFur],[5,4,colors.pink],[6,4,colors.pink],[7,4,colors.lightFur],[8,4,colors.fur],
            [3,5,colors.fur],[4,5,colors.lightFur],[5,5,colors.black],[6,5,colors.black],[7,5,colors.lightFur],[8,5,colors.fur],
            // Body
            [2,6,colors.fur],[3,6,colors.fur],[4,6,colors.fur],[5,6,colors.fur],[6,6,colors.fur],[7,6,colors.fur],[8,6,colors.fur],[9,6,colors.fur],
            [2,7,colors.fur],[3,7,colors.darkFur],[4,7,colors.darkFur],[5,7,colors.darkFur],[6,7,colors.darkFur],[7,7,colors.darkFur],[8,7,colors.darkFur],[9,7,colors.fur],
            [2,8,colors.fur],[3,8,colors.fur],[4,8,colors.fur],[5,8,colors.fur],[6,8,colors.fur],[7,8,colors.fur],[8,8,colors.fur],[9,8,colors.fur],
            // Legs
            [3,9,colors.darkFur],[4,9,colors.darkFur],[7,9,colors.darkFur],[8,9,colors.darkFur],
            [3,10,colors.darkFur],[4,10,colors.darkFur],[7,10,colors.darkFur],[8,10,colors.darkFur],
            [3,11,colors.darkFur],[4,11,colors.darkFur],[7,11,colors.darkFur],[8,11,colors.darkFur],
        ],
        'standing_left': [
            // Ears
            [3,0,colors.fur],[4,0,colors.fur],[5,0,colors.fur],[6,0,colors.fur],
            [2,1,colors.fur],[3,1,colors.darkFur],[4,1,colors.darkFur],[5,1,colors.darkFur],[6,1,colors.darkFur],[7,1,colors.fur],
            [1,2,colors.fur],[2,2,colors.fur],[3,2,colors.fur],[4,2,colors.fur],[5,2,colors.fur],[6,2,colors.fur],[7,2,colors.fur],[8,2,colors.fur],
            // Face
            [2,3,colors.fur],[3,3,colors.lightFur],[4,3,colors.lightFur],[5,3,colors.lightFur],[6,3,colors.lightFur],[7,3,colors.fur],
            [2,4,colors.fur],[3,4,colors.lightFur],[4,4,colors.pink],[5,4,colors.pink],[6,4,colors.lightFur],[7,4,colors.fur],
            [2,5,colors.fur],[3,5,colors.lightFur],[4,5,colors.black],[5,5,colors.black],[6,5,colors.lightFur],[7,5,colors.fur],
            // Body
            [1,6,colors.fur],[2,6,colors.fur],[3,6,colors.fur],[4,6,colors.fur],[5,6,colors.fur],[6,6,colors.fur],[7,6,colors.fur],[8,6,colors.fur],
            [1,7,colors.fur],[2,7,colors.darkFur],[3,7,colors.darkFur],[4,7,colors.darkFur],[5,7,colors.darkFur],[6,7,colors.darkFur],[7,7,colors.darkFur],[8,7,colors.fur],
            [1,8,colors.fur],[2,8,colors.fur],[3,8,colors.fur],[4,8,colors.fur],[5,8,colors.fur],[6,8,colors.fur],[7,8,colors.fur],[8,8,colors.fur],
            // Legs
            [2,9,colors.darkFur],[3,9,colors.darkFur],[6,9,colors.darkFur],[7,9,colors.darkFur],
            [2,10,colors.darkFur],[3,10,colors.darkFur],[6,10,colors.darkFur],[7,10,colors.darkFur],
            [2,11,colors.darkFur],[3,11,colors.darkFur],[6,11,colors.darkFur],[7,11,colors.darkFur],
        ],
    };
    
    let pixels;
    if (frame in spriteData) {
        pixels = spriteData[frame];
    } else {
        pixels = spriteData['standing_down'];
    }

    if (frame.includes('right')) {
        const leftFrame = frame.replace('right', 'left');
        pixels = spriteData[leftFrame].map(([px, py, color]) => [SPRITE_WIDTH - 1 - px, py, color]);
    }

    pixels.forEach(([px, py, color]) => p(px, py, color));

    ctx.restore();
}

function drawDeerSprite(x, y, frame) {
    const PIXEL_SIZE = 4;
    const SPRITE_WIDTH = 16;
    const SPRITE_HEIGHT = 16;
    const SPRITE_OFFSET_X = TILE_SIZE / 2 - (SPRITE_WIDTH * PIXEL_SIZE) / 2;
    const SPRITE_OFFSET_Y = 10;

    const colors = {
        fur: '#8b4513',
        darkFur: '#654321',
        lightFur: '#a0522d',
        antlers: '#8b7355',
        darkAntlers: '#654321',
        black: '#212121',
        white: '#ffffff',
        pink: '#ffb6c1',
    };

    ctx.save();
    ctx.translate(x + SPRITE_OFFSET_X, y + SPRITE_OFFSET_Y);

    const p = (px, py, color) => {
        ctx.fillStyle = color;
        ctx.fillRect(px * PIXEL_SIZE, py * PIXEL_SIZE, PIXEL_SIZE, PIXEL_SIZE);
    };

    const spriteData = {
        'standing_down': [
            // Antlers
            [4,0,colors.antlers],[5,0,colors.antlers],[6,0,colors.antlers],[7,0,colors.antlers],[8,0,colors.antlers],[9,0,colors.antlers],
            [3,1,colors.antlers],[4,1,colors.darkAntlers],[5,1,colors.darkAntlers],[6,1,colors.antlers],[7,1,colors.antlers],[8,1,colors.darkAntlers],[9,1,colors.darkAntlers],[10,1,colors.antlers],
            [2,2,colors.antlers],[3,2,colors.antlers],[4,2,colors.antlers],[5,2,colors.antlers],[6,2,colors.antlers],[7,2,colors.antlers],[8,2,colors.antlers],[9,2,colors.antlers],[10,2,colors.antlers],[11,2,colors.antlers],
            // Head
            [3,3,colors.fur],[4,3,colors.lightFur],[5,3,colors.lightFur],[6,3,colors.lightFur],[7,3,colors.lightFur],[8,3,colors.lightFur],[9,3,colors.lightFur],[10,3,colors.fur],
            [3,4,colors.fur],[4,4,colors.lightFur],[5,4,colors.pink],[6,4,colors.pink],[7,4,colors.pink],[8,4,colors.pink],[9,4,colors.lightFur],[10,4,colors.fur],
            [3,5,colors.fur],[4,5,colors.lightFur],[5,5,colors.black],[6,5,colors.black],[7,5,colors.black],[8,5,colors.black],[9,5,colors.lightFur],[10,5,colors.fur],
            // Neck
            [4,6,colors.fur],[5,6,colors.fur],[6,6,colors.fur],[7,6,colors.fur],[8,6,colors.fur],
            [4,7,colors.darkFur],[5,7,colors.darkFur],[6,7,colors.darkFur],[7,7,colors.darkFur],[8,7,colors.darkFur],
            // Body
            [2,8,colors.fur],[3,8,colors.fur],[4,8,colors.fur],[5,8,colors.fur],[6,8,colors.fur],[7,8,colors.fur],[8,8,colors.fur],[9,8,colors.fur],[10,8,colors.fur],[11,8,colors.fur],
            [2,9,colors.fur],[3,9,colors.darkFur],[4,9,colors.darkFur],[5,9,colors.darkFur],[6,9,colors.darkFur],[7,9,colors.darkFur],[8,9,colors.darkFur],[9,9,colors.darkFur],[10,9,colors.darkFur],[11,9,colors.fur],
            [2,10,colors.fur],[3,10,colors.fur],[4,10,colors.fur],[5,10,colors.fur],[6,10,colors.fur],[7,10,colors.fur],[8,10,colors.fur],[9,10,colors.fur],[10,10,colors.fur],[11,10,colors.fur],
            // Legs
            [2,11,colors.darkFur],[3,11,colors.darkFur],[4,11,colors.darkFur],[5,11,colors.darkFur],[6,11,colors.darkFur],[7,11,colors.darkFur],[8,11,colors.darkFur],[9,11,colors.darkFur],[10,11,colors.darkFur],[11,11,colors.darkFur],
            [2,12,colors.darkFur],[3,12,colors.darkFur],[4,12,colors.darkFur],[5,12,colors.darkFur],[6,12,colors.darkFur],[7,12,colors.darkFur],[8,12,colors.darkFur],[9,12,colors.darkFur],[10,12,colors.darkFur],[11,12,colors.darkFur],
            [2,13,colors.darkFur],[3,13,colors.darkFur],[4,13,colors.darkFur],[5,13,colors.darkFur],[6,13,colors.darkFur],[7,13,colors.darkFur],[8,13,colors.darkFur],[9,13,colors.darkFur],[10,13,colors.darkFur],[11,13,colors.darkFur],
        ],
        'standing_up': [
            // Antlers
            [4,0,colors.antlers],[5,0,colors.antlers],[6,0,colors.antlers],[7,0,colors.antlers],[8,0,colors.antlers],[9,0,colors.antlers],
            [3,1,colors.antlers],[4,1,colors.darkAntlers],[5,1,colors.darkAntlers],[6,1,colors.antlers],[7,1,colors.antlers],[8,1,colors.darkAntlers],[9,1,colors.darkAntlers],[10,1,colors.antlers],
            [2,2,colors.antlers],[3,2,colors.antlers],[4,2,colors.antlers],[5,2,colors.antlers],[6,2,colors.antlers],[7,2,colors.antlers],[8,2,colors.antlers],[9,2,colors.antlers],[10,2,colors.antlers],[11,2,colors.antlers],
            // Head
            [3,3,colors.fur],[4,3,colors.lightFur],[5,3,colors.lightFur],[6,3,colors.lightFur],[7,3,colors.lightFur],[8,3,colors.lightFur],[9,3,colors.lightFur],[10,3,colors.fur],
            [3,4,colors.fur],[4,4,colors.lightFur],[5,4,colors.pink],[6,4,colors.pink],[7,4,colors.pink],[8,4,colors.pink],[9,4,colors.lightFur],[10,4,colors.fur],
            [3,5,colors.fur],[4,5,colors.lightFur],[5,5,colors.black],[6,5,colors.black],[7,5,colors.black],[8,5,colors.black],[9,5,colors.lightFur],[10,5,colors.fur],
            // Neck
            [4,6,colors.fur],[5,6,colors.fur],[6,6,colors.fur],[7,6,colors.fur],[8,6,colors.fur],
            [4,7,colors.darkFur],[5,7,colors.darkFur],[6,7,colors.darkFur],[7,7,colors.darkFur],[8,7,colors.darkFur],
            // Body
            [2,8,colors.fur],[3,8,colors.fur],[4,8,colors.fur],[5,8,colors.fur],[6,8,colors.fur],[7,8,colors.fur],[8,8,colors.fur],[9,8,colors.fur],[10,8,colors.fur],[11,8,colors.fur],
            [2,9,colors.fur],[3,9,colors.darkFur],[4,9,colors.darkFur],[5,9,colors.darkFur],[6,9,colors.darkFur],[7,9,colors.darkFur],[8,9,colors.darkFur],[9,9,colors.darkFur],[10,9,colors.darkFur],[11,9,colors.fur],
            [2,10,colors.fur],[3,10,colors.fur],[4,10,colors.fur],[5,10,colors.fur],[6,10,colors.fur],[7,10,colors.fur],[8,10,colors.fur],[9,10,colors.fur],[10,10,colors.fur],[11,10,colors.fur],
            // Legs
            [2,11,colors.darkFur],[3,11,colors.darkFur],[4,11,colors.darkFur],[5,11,colors.darkFur],[6,11,colors.darkFur],[7,11,colors.darkFur],[8,11,colors.darkFur],[9,11,colors.darkFur],[10,11,colors.darkFur],[11,11,colors.darkFur],
            [2,12,colors.darkFur],[3,12,colors.darkFur],[4,12,colors.darkFur],[5,12,colors.darkFur],[6,12,colors.darkFur],[7,12,colors.darkFur],[8,12,colors.darkFur],[9,12,colors.darkFur],[10,12,colors.darkFur],[11,12,colors.darkFur],
            [2,13,colors.darkFur],[3,13,colors.darkFur],[4,13,colors.darkFur],[5,13,colors.darkFur],[6,13,colors.darkFur],[7,13,colors.darkFur],[8,13,colors.darkFur],[9,13,colors.darkFur],[10,13,colors.darkFur],[11,13,colors.darkFur],
        ],
        'standing_left': [
            // Antlers
            [3,0,colors.antlers],[4,0,colors.antlers],[5,0,colors.antlers],[6,0,colors.antlers],[7,0,colors.antlers],[8,0,colors.antlers],
            [2,1,colors.antlers],[3,1,colors.darkAntlers],[4,1,colors.darkAntlers],[5,1,colors.antlers],[6,1,colors.antlers],[7,1,colors.darkAntlers],[8,1,colors.darkAntlers],[9,1,colors.antlers],
            [1,2,colors.antlers],[2,2,colors.antlers],[3,2,colors.antlers],[4,2,colors.antlers],[5,2,colors.antlers],[6,2,colors.antlers],[7,2,colors.antlers],[8,2,colors.antlers],[9,2,colors.antlers],[10,2,colors.antlers],
            // Head
            [2,3,colors.fur],[3,3,colors.lightFur],[4,3,colors.lightFur],[5,3,colors.lightFur],[6,3,colors.lightFur],[7,3,colors.lightFur],[8,3,colors.lightFur],[9,3,colors.fur],
            [2,4,colors.fur],[3,4,colors.lightFur],[4,4,colors.pink],[5,4,colors.pink],[6,4,colors.pink],[7,4,colors.pink],[8,4,colors.lightFur],[9,4,colors.fur],
            [2,5,colors.fur],[3,5,colors.lightFur],[4,5,colors.black],[5,5,colors.black],[6,5,colors.black],[7,5,colors.black],[8,5,colors.lightFur],[9,5,colors.fur],
            // Neck
            [3,6,colors.fur],[4,6,colors.fur],[5,6,colors.fur],[6,6,colors.fur],[7,6,colors.fur],
            [3,7,colors.darkFur],[4,7,colors.darkFur],[5,7,colors.darkFur],[6,7,colors.darkFur],[7,7,colors.darkFur],
            // Body
            [1,8,colors.fur],[2,8,colors.fur],[3,8,colors.fur],[4,8,colors.fur],[5,8,colors.fur],[6,8,colors.fur],[7,8,colors.fur],[8,8,colors.fur],[9,8,colors.fur],[10,8,colors.fur],
            [1,9,colors.fur],[2,9,colors.darkFur],[3,9,colors.darkFur],[4,9,colors.darkFur],[5,9,colors.darkFur],[6,9,colors.darkFur],[7,9,colors.darkFur],[8,9,colors.darkFur],[9,9,colors.darkFur],[10,9,colors.fur],
            [1,10,colors.fur],[2,10,colors.fur],[3,10,colors.fur],[4,10,colors.fur],[5,10,colors.fur],[6,10,colors.fur],[7,10,colors.fur],[8,10,colors.fur],[9,10,colors.fur],[10,10,colors.fur],
            // Legs
            [1,11,colors.darkFur],[2,11,colors.darkFur],[3,11,colors.darkFur],[4,11,colors.darkFur],[5,11,colors.darkFur],[6,11,colors.darkFur],[7,11,colors.darkFur],[8,11,colors.darkFur],[9,11,colors.darkFur],[10,11,colors.darkFur],
            [1,12,colors.darkFur],[2,12,colors.darkFur],[3,12,colors.darkFur],[4,12,colors.darkFur],[5,12,colors.darkFur],[6,12,colors.darkFur],[7,12,colors.darkFur],[8,12,colors.darkFur],[9,12,colors.darkFur],[10,12,colors.darkFur],
            [1,13,colors.darkFur],[2,13,colors.darkFur],[3,13,colors.darkFur],[4,13,colors.darkFur],[5,13,colors.darkFur],[6,13,colors.darkFur],[7,13,colors.darkFur],[8,13,colors.darkFur],[9,13,colors.darkFur],[10,13,colors.darkFur],
        ],
    };
    
    let pixels;
    if (frame in spriteData) {
        pixels = spriteData[frame];
    } else {
        pixels = spriteData['standing_down'];
    }

    if (frame.includes('right')) {
        const leftFrame = frame.replace('right', 'left');
        pixels = spriteData[leftFrame].map(([px, py, color]) => [SPRITE_WIDTH - 1 - px, py, color]);
    }

    pixels.forEach(([px, py, color]) => p(px, py, color));

    ctx.restore();
}

function drawSquirrelSprite(x, y, frame) {
    const PIXEL_SIZE = 3;
    const SPRITE_WIDTH = 12;
    const SPRITE_HEIGHT = 12;
    const SPRITE_OFFSET_X = TILE_SIZE / 2 - (SPRITE_WIDTH * PIXEL_SIZE) / 2;
    const SPRITE_OFFSET_Y = 15;

    const colors = {
        fur: '#a1a1a1',
        darkFur: '#6b6b6b',
        lightFur: '#d3d3d3',
        tail: '#8b8b8b',
        darkTail: '#5a5a5a',
        black: '#212121',
        white: '#ffffff',
        pink: '#ffb6c1',
    };

    ctx.save();
    ctx.translate(x + SPRITE_OFFSET_X, y + SPRITE_OFFSET_Y);

    const p = (px, py, color) => {
        ctx.fillStyle = color;
        ctx.fillRect(px * PIXEL_SIZE, py * PIXEL_SIZE, PIXEL_SIZE, PIXEL_SIZE);
    };

    const spriteData = {
        'standing_down': [
            // Ears
            [4,0,colors.fur],[5,0,colors.fur],[6,0,colors.fur],[7,0,colors.fur],
            [3,1,colors.fur],[4,1,colors.darkFur],[5,1,colors.darkFur],[6,1,colors.darkFur],[7,1,colors.darkFur],[8,1,colors.fur],
            [2,2,colors.fur],[3,2,colors.fur],[4,2,colors.fur],[5,2,colors.fur],[6,2,colors.fur],[7,2,colors.fur],[8,2,colors.fur],[9,2,colors.fur],
            // Face
            [3,3,colors.fur],[4,3,colors.lightFur],[5,3,colors.lightFur],[6,3,colors.lightFur],[7,3,colors.lightFur],[8,3,colors.fur],
            [3,4,colors.fur],[4,4,colors.lightFur],[5,4,colors.pink],[6,4,colors.pink],[7,4,colors.lightFur],[8,4,colors.fur],
            [3,5,colors.fur],[4,5,colors.lightFur],[5,5,colors.black],[6,5,colors.black],[7,5,colors.lightFur],[8,5,colors.fur],
            // Body
            [2,6,colors.fur],[3,6,colors.fur],[4,6,colors.fur],[5,6,colors.fur],[6,6,colors.fur],[7,6,colors.fur],[8,6,colors.fur],[9,6,colors.fur],
            [2,7,colors.fur],[3,7,colors.darkFur],[4,7,colors.darkFur],[5,7,colors.darkFur],[6,7,colors.darkFur],[7,7,colors.darkFur],[8,7,colors.darkFur],[9,7,colors.fur],
            [2,8,colors.fur],[3,8,colors.fur],[4,8,colors.fur],[5,8,colors.fur],[6,8,colors.fur],[7,8,colors.fur],[8,8,colors.fur],[9,8,colors.fur],
            // Tail
            [0,6,colors.tail],[1,6,colors.darkTail],[2,6,colors.darkTail],
            [0,7,colors.tail],[1,7,colors.darkTail],[2,7,colors.darkTail],
            [0,8,colors.tail],[1,8,colors.darkTail],[2,8,colors.darkTail],
            // Legs
            [3,9,colors.darkFur],[4,9,colors.darkFur],[7,9,colors.darkFur],[8,9,colors.darkFur],
            [3,10,colors.darkFur],[4,10,colors.darkFur],[7,10,colors.darkFur],[8,10,colors.darkFur],
            [3,11,colors.darkFur],[4,11,colors.darkFur],[7,11,colors.darkFur],[8,11,colors.darkFur],
        ],
        'standing_up': [
            // Ears
            [4,0,colors.fur],[5,0,colors.fur],[6,0,colors.fur],[7,0,colors.fur],
            [3,1,colors.fur],[4,1,colors.darkFur],[5,1,colors.darkFur],[6,1,colors.darkFur],[7,1,colors.darkFur],[8,1,colors.fur],
            [2,2,colors.fur],[3,2,colors.fur],[4,2,colors.fur],[5,2,colors.fur],[6,2,colors.fur],[7,2,colors.fur],[8,2,colors.fur],[9,2,colors.fur],
            // Face
            [3,3,colors.fur],[4,3,colors.lightFur],[5,3,colors.lightFur],[6,3,colors.lightFur],[7,3,colors.lightFur],[8,3,colors.fur],
            [3,4,colors.fur],[4,4,colors.lightFur],[5,4,colors.pink],[6,4,colors.pink],[7,4,colors.lightFur],[8,4,colors.fur],
            [3,5,colors.fur],[4,5,colors.lightFur],[5,5,colors.black],[6,5,colors.black],[7,5,colors.lightFur],[8,5,colors.fur],
            // Body
            [2,6,colors.fur],[3,6,colors.fur],[4,6,colors.fur],[5,6,colors.fur],[6,6,colors.fur],[7,6,colors.fur],[8,6,colors.fur],[9,6,colors.fur],
            [2,7,colors.fur],[3,7,colors.darkFur],[4,7,colors.darkFur],[5,7,colors.darkFur],[6,7,colors.darkFur],[7,7,colors.darkFur],[8,7,colors.darkFur],[9,7,colors.fur],
            [2,8,colors.fur],[3,8,colors.fur],[4,8,colors.fur],[5,8,colors.fur],[6,8,colors.fur],[7,8,colors.fur],[8,8,colors.fur],[9,8,colors.fur],
            // Tail
            [0,6,colors.tail],[1,6,colors.darkTail],[2,6,colors.darkTail],
            [0,7,colors.tail],[1,7,colors.darkTail],[2,7,colors.darkTail],
            [0,8,colors.tail],[1,8,colors.darkTail],[2,8,colors.darkTail],
            // Legs
            [3,9,colors.darkFur],[4,9,colors.darkFur],[7,9,colors.darkFur],[8,9,colors.darkFur],
            [3,10,colors.darkFur],[4,10,colors.darkFur],[7,10,colors.darkFur],[8,10,colors.darkFur],
            [3,11,colors.darkFur],[4,11,colors.darkFur],[7,11,colors.darkFur],[8,11,colors.darkFur],
        ],
        'standing_left': [
            // Ears
            [3,0,colors.fur],[4,0,colors.fur],[5,0,colors.fur],[6,0,colors.fur],
            [2,1,colors.fur],[3,1,colors.darkFur],[4,1,colors.darkFur],[5,1,colors.darkFur],[6,1,colors.darkFur],[7,1,colors.fur],
            [1,2,colors.fur],[2,2,colors.fur],[3,2,colors.fur],[4,2,colors.fur],[5,2,colors.fur],[6,2,colors.fur],[7,2,colors.fur],[8,2,colors.fur],
            // Face
            [2,3,colors.fur],[3,3,colors.lightFur],[4,3,colors.lightFur],[5,3,colors.lightFur],[6,3,colors.lightFur],[7,3,colors.fur],
            [2,4,colors.fur],[3,4,colors.lightFur],[4,4,colors.pink],[5,4,colors.pink],[6,4,colors.lightFur],[7,4,colors.fur],
            [2,5,colors.fur],[3,5,colors.lightFur],[4,5,colors.black],[5,5,colors.black],[6,5,colors.lightFur],[7,5,colors.fur],
            // Body
            [1,6,colors.fur],[2,6,colors.fur],[3,6,colors.fur],[4,6,colors.fur],[5,6,colors.fur],[6,6,colors.fur],[7,6,colors.fur],[8,6,colors.fur],
            [1,7,colors.fur],[2,7,colors.darkFur],[3,7,colors.darkFur],[4,7,colors.darkFur],[5,7,colors.darkFur],[6,7,colors.darkFur],[7,7,colors.darkFur],[8,7,colors.fur],
            [1,8,colors.fur],[2,8,colors.fur],[3,8,colors.fur],[4,8,colors.fur],[5,8,colors.fur],[6,8,colors.fur],[7,8,colors.fur],[8,8,colors.fur],
            // Tail
            [9,6,colors.tail],[10,6,colors.darkTail],[11,6,colors.darkTail],
            [9,7,colors.tail],[10,7,colors.darkTail],[11,7,colors.darkTail],
            [9,8,colors.tail],[10,8,colors.darkTail],[11,8,colors.darkTail],
            // Legs
            [2,9,colors.darkFur],[3,9,colors.darkFur],[6,9,colors.darkFur],[7,9,colors.darkFur],
            [2,10,colors.darkFur],[3,10,colors.darkFur],[6,10,colors.darkFur],[7,10,colors.darkFur],
            [2,11,colors.darkFur],[3,11,colors.darkFur],[6,11,colors.darkFur],[7,11,colors.darkFur],
        ],
    };
    
    let pixels;
    if (frame in spriteData) {
        pixels = spriteData[frame];
    } else {
        pixels = spriteData['standing_down'];
    }

    if (frame.includes('right')) {
        const leftFrame = frame.replace('right', 'left');
        pixels = spriteData[leftFrame].map(([px, py, color]) => [SPRITE_WIDTH - 1 - px, py, color]);
    }

    pixels.forEach(([px, py, color]) => p(px, py, color));

    ctx.restore();
}

function drawBearSprite(x, y, frame) {
    const PIXEL_SIZE = 4;
    const SPRITE_WIDTH = 16;
    const SPRITE_HEIGHT = 16;
    const SPRITE_OFFSET_X = TILE_SIZE / 2 - (SPRITE_WIDTH * PIXEL_SIZE) / 2;
    const SPRITE_OFFSET_Y = 8;

    const colors = {
        brown: '#8b4513',
        darkBrown: '#654321',
        lightBrown: '#a0522d',
        black: '#212121',
        white: '#ffffff',
        nose: '#2a2a2a'
    };

    ctx.save();
    ctx.translate(x + SPRITE_OFFSET_X, y + SPRITE_OFFSET_Y);

    const p = (px, py, color) => {
        ctx.fillStyle = color;
        ctx.fillRect(px * PIXEL_SIZE, py * PIXEL_SIZE, PIXEL_SIZE, PIXEL_SIZE);
    };

    const spriteData = {
        'standing_down': [
            // Head
            [5, 2, colors.brown], [6, 2, colors.brown], [7, 2, colors.brown], [8, 2, colors.brown], [9, 2, colors.brown], [10, 2, colors.brown],
            [4, 3, colors.brown], [5, 3, colors.darkBrown], [6, 3, colors.darkBrown], [7, 3, colors.darkBrown], [8, 3, colors.darkBrown], [9, 3, colors.darkBrown], [10, 3, colors.darkBrown], [11, 3, colors.brown],
            [4, 4, colors.brown], [5, 4, colors.darkBrown], [6, 4, colors.black], [7, 4, colors.nose], [8, 4, colors.nose], [9, 4, colors.black], [10, 4, colors.darkBrown], [11, 4, colors.brown],
            [4, 5, colors.brown], [5, 5, colors.darkBrown], [6, 5, colors.black], [7, 5, colors.black], [8, 5, colors.black], [9, 5, colors.black], [10, 5, colors.darkBrown], [11, 5, colors.brown],
            [3, 6, colors.brown], [4, 6, colors.darkBrown], [5, 6, colors.darkBrown], [6, 6, colors.darkBrown], [7, 6, colors.darkBrown], [8, 6, colors.darkBrown], [9, 6, colors.darkBrown], [10, 6, colors.darkBrown], [11, 6, colors.darkBrown], [12, 6, colors.brown],
            // Body
            [2, 7, colors.brown], [3, 7, colors.darkBrown], [4, 7, colors.darkBrown], [5, 7, colors.darkBrown], [6, 7, colors.darkBrown], [7, 7, colors.darkBrown], [8, 7, colors.darkBrown], [9, 7, colors.darkBrown], [10, 7, colors.darkBrown], [11, 7, colors.darkBrown], [12, 7, colors.darkBrown], [13, 7, colors.brown],
            [2, 8, colors.brown], [3, 8, colors.darkBrown], [4, 8, colors.darkBrown], [5, 8, colors.darkBrown], [6, 8, colors.darkBrown], [7, 8, colors.darkBrown], [8, 8, colors.darkBrown], [9, 8, colors.darkBrown], [10, 8, colors.darkBrown], [11, 8, colors.darkBrown], [12, 8, colors.darkBrown], [13, 8, colors.brown],
            [2, 9, colors.brown], [3, 9, colors.darkBrown], [4, 9, colors.darkBrown], [5, 9, colors.darkBrown], [6, 9, colors.darkBrown], [7, 9, colors.darkBrown], [8, 9, colors.darkBrown], [9, 9, colors.darkBrown], [10, 9, colors.darkBrown], [11, 9, colors.darkBrown], [12, 9, colors.darkBrown], [13, 9, colors.brown],
            [3, 10, colors.brown], [4, 10, colors.darkBrown], [5, 10, colors.darkBrown], [6, 10, colors.darkBrown], [7, 10, colors.darkBrown], [8, 10, colors.darkBrown], [9, 10, colors.darkBrown], [10, 10, colors.darkBrown], [11, 10, colors.darkBrown], [12, 10, colors.brown],
            // Legs
            [4, 11, colors.darkBrown], [5, 11, colors.darkBrown], [6, 11, colors.darkBrown], [7, 11, colors.darkBrown], [8, 11, colors.darkBrown], [9, 11, colors.darkBrown], [10, 11, colors.darkBrown], [11, 11, colors.darkBrown],
            [4, 12, colors.darkBrown], [5, 12, colors.darkBrown], [6, 12, colors.darkBrown], [7, 12, colors.darkBrown], [8, 12, colors.darkBrown], [9, 12, colors.darkBrown], [10, 12, colors.darkBrown], [11, 12, colors.darkBrown],
            [4, 13, colors.darkBrown], [5, 13, colors.darkBrown], [6, 13, colors.darkBrown], [7, 13, colors.darkBrown], [8, 13, colors.darkBrown], [9, 13, colors.darkBrown], [10, 13, colors.darkBrown], [11, 13, colors.darkBrown],
        ],
    };
    
    let pixels;
    if (frame in spriteData) {
        pixels = spriteData[frame];
    } else {
        pixels = spriteData['standing_down'];
    }

    if (frame.includes('right')) {
        const leftFrame = frame.replace('right', 'left');
        pixels = spriteData[leftFrame].map(([px, py, color]) => [SPRITE_WIDTH - 1 - px, py, color]);
    }

    pixels.forEach(([px, py, color]) => p(px, py, color));

    ctx.restore();
}

function drawSpeechBubble(x, y, message) {
    const bubbleWidth = Math.max(140, message.length * 9);
    const bubbleHeight = 50;
    const bubbleX = x + TILE_SIZE / 2 - bubbleWidth / 2;
    const bubbleY = y - bubbleHeight - 20;
    
    // Draw speech bubble background
    ctx.save();
    ctx.fillStyle = 'rgba(255, 255, 255, 0.95)';
    ctx.strokeStyle = '#333';
    ctx.lineWidth = 2;
    
    // Main bubble
    ctx.beginPath();
    ctx.roundRect(bubbleX, bubbleY, bubbleWidth, bubbleHeight, 16);
    ctx.fill();
    ctx.stroke();
    
    // Speech bubble tail pointing down to wizard
    ctx.beginPath();
    ctx.moveTo(bubbleX + bubbleWidth / 2 - 8, bubbleY + bubbleHeight);
    ctx.lineTo(bubbleX + bubbleWidth / 2, bubbleY + bubbleHeight + 8);
    ctx.lineTo(bubbleX + bubbleWidth / 2 + 8, bubbleY + bubbleHeight);
    ctx.closePath();
    ctx.fill();
    ctx.stroke();
    
    // Draw text
    ctx.fillStyle = '#333';
    ctx.font = '12px "Press Start 2P", monospace';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    
    // Split long messages into multiple lines
    const words = message.split(' ');
    const lines = [];
    let currentLine = '';
    
    words.forEach(word => {
        if ((currentLine + word).length * 9 > bubbleWidth - 20) {
            if (currentLine) lines.push(currentLine.trim());
            currentLine = word;
        } else {
            currentLine += (currentLine ? ' ' : '') + word;
        }
    });
    if (currentLine) lines.push(currentLine.trim());
    
    // Draw each line
    lines.forEach((line, index) => {
        const lineY = bubbleY + bubbleHeight / 2 + (index - (lines.length - 1) / 2) * 18;
        ctx.fillText(line, bubbleX + bubbleWidth / 2, lineY);
    });
    
    ctx.restore();
}

function toggleMiniMapFullscreen() {
    gameState.miniMapFullscreen = !gameState.miniMapFullscreen;
    updateMiniMapOverlay();
    
    // Ensure game canvas maintains focus for keyboard events after a brief delay
    setTimeout(() => {
        if (canvas) {
            canvas.focus();
        }
    }, 50);
}

function updateMiniMapOverlay() {
    const overlay = document.getElementById('miniMapOverlay');
    const legend = document.getElementById('miniMapLegend');
    const instructions = document.getElementById('miniMapInstructions');
    const indicator = document.getElementById('miniMapIndicator');
    
    if (gameState.miniMapFullscreen) {
        // Fullscreen mode
        overlay.className = 'absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-gray-900 bg-opacity-95 p-4 rounded border border-gray-600 transition-all duration-300 z-50';
        overlay.style.pointerEvents = 'none'; // Don't capture mouse events
        overlay.tabIndex = -1; // Don't capture focus
        legend.className = 'text-sm text-center mt-3 text-gray-300';
        instructions.textContent = 'Press M to minimize';
        indicator.style.display = 'none'; // Hide indicator in fullscreen
    } else {
        // Peeking mode - just showing from the side
        overlay.className = 'absolute top-4 -right-96 bg-gray-900 bg-opacity-90 p-2 rounded-l border border-gray-600 border-r-0 transition-all duration-300';
        overlay.style.pointerEvents = 'auto'; // Allow mouse events for minimap clicking
        overlay.tabIndex = -1; // Don't capture focus
        legend.className = 'text-xs text-center mt-2 text-gray-400';
        instructions.textContent = 'Press M for fullscreen';
        indicator.style.display = 'block'; // Show indicator when peeking
    }
}

function drawMiniMap() {
    const miniMapSize = gameState.miniMapFullscreen ? 400 : 120;
    const scale = miniMapSize / MAP_SIZE;
    
    // Set canvas size
    miniMap.width = miniMapSize;
    miniMap.height = miniMapSize;
    
    // Clear mini map
    miniMapCtx.fillStyle = '#2d3748';
    miniMapCtx.fillRect(0, 0, miniMapSize, miniMapSize);
    
    // Draw terrain (simplified)
    for (let y = 0; y < MAP_SIZE; y++) {
        for (let x = 0; x < MAP_SIZE; x++) {
            const tile = gameState.world[y][x];
            const mapX = x * scale;
            const mapY = y * scale;
            
            let color;
            switch(tile) {
                case TILES.GRASS: color = '#5a8b41'; break;
                case TILES.TREE: color = '#3a5941'; break;
                case TILES.ROCK: color = '#8d8d8d'; break;
                case TILES.WATER: color = '#4a90e2'; break;
                case TILES.MOUNTAIN: color = '#6b7280'; break;
                default: color = '#5a8b41';
            }
            
            miniMapCtx.fillStyle = color;
            miniMapCtx.fillRect(mapX, mapY, Math.ceil(scale), Math.ceil(scale));
        }
    }
    
    // Draw monoliths
    for (let y = 0; y < MAP_SIZE; y++) {
        for (let x = 0; x < MAP_SIZE; x++) {
            const tile = gameState.world[y][x];
            if (tile === TILES.MONOLITH || tile === TILES.MONOLITH_ACTIVATED) {
                const mapX = x * scale;
                const mapY = y * scale;
                miniMapCtx.fillStyle = tile === TILES.MONOLITH_ACTIVATED ? '#f6e05e' : '#fbbf24';
                miniMapCtx.fillRect(mapX, mapY, Math.ceil(scale), Math.ceil(scale));
            }
        }
    }
    
    // Draw wizard
    if (gameState.wizard.x > 0 && gameState.wizard.y > 0) {
        const mapX = gameState.wizard.x * scale;
        const mapY = gameState.wizard.y * scale;
        miniMapCtx.fillStyle = '#3b82f6';
        miniMapCtx.fillRect(mapX, mapY, Math.ceil(scale), Math.ceil(scale));
    }
    
    // Draw animals (wolves)
    gameState.animals.forEach(animal => {
        const mapX = animal.x * scale;
        const mapY = animal.y * scale;
        miniMapCtx.fillStyle = '#ef4444';
        miniMapCtx.fillRect(mapX, mapY, Math.ceil(scale), Math.ceil(scale));
    });
    
    // Draw player
    const playerMapX = gameState.player.x * scale;
    const playerMapY = gameState.player.y * scale;
    miniMapCtx.fillStyle = '#8b5cf6';
    miniMapCtx.fillRect(playerMapX, playerMapY, Math.ceil(scale), Math.ceil(scale));
    
    // Draw viewport rectangle
    const viewportX = gameState.camera.x / TILE_SIZE * scale;
    const viewportY = gameState.camera.y / TILE_SIZE * scale;
    const viewportWidth = (canvas.width / TILE_SIZE) * scale;
    const viewportHeight = (canvas.height / TILE_SIZE) * scale;
    
    miniMapCtx.strokeStyle = '#ffffff';
    miniMapCtx.lineWidth = 2;
    miniMapCtx.strokeRect(viewportX, viewportY, viewportWidth, viewportHeight);
}

function draw() {
    if (gameState.isGameOver || gameState.paused) return;
    
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    ctx.save();
    ctx.translate(-gameState.camera.x, -gameState.camera.y);

    const startX = Math.floor(gameState.camera.x / TILE_SIZE);
    const endX = startX + viewportTileCountX + 2;
    const startY = Math.floor(gameState.camera.y / TILE_SIZE);
    const endY = startY + viewportTileCountY + 2;

    for (let y = Math.max(0, startY); y < Math.min(MAP_SIZE, endY); y++) {
        for (let x = Math.max(0, startX); x < Math.min(MAP_SIZE, endX); x++) {
            const tile = gameState.world[y][x];
            // Base Grass Tile
            ctx.fillStyle = TILE_COLORS[TILES.GRASS];
            ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            // Grass Details
            ctx.fillStyle = 'rgba(0,0,0,0.07)';
            ctx.fillRect(x * TILE_SIZE + 10, y * TILE_SIZE + 15, 4, 12);
            ctx.fillRect(x * TILE_SIZE + 40, y * TILE_SIZE + 45, 4, 12);

            const key = `${x},${y}`;
            let shakeX = 0;
            let shakeY = 0;

            const activeAnim = gameState.activeAnimations.find(a => a.x === x && a.y === y);
            if (activeAnim) {
                const intensity = (activeAnim.maxProgress - activeAnim.progress) / activeAnim.maxProgress;
                shakeX = (Math.random() - 0.5) * 8 * intensity;
                shakeY = (Math.random() - 0.5) * 8 * intensity;
            }


            switch(tile) {
                case TILES.TREE:
                    // Trunk with highlight
                    ctx.fillStyle = '#6b4f3a'; ctx.fillRect(x * TILE_SIZE + TILE_SIZE/2 - 8 + shakeX, y * TILE_SIZE + TILE_SIZE/2 + shakeY, 16, TILE_SIZE/2 + 4);
                    ctx.fillStyle = '#8a6f5a'; ctx.fillRect(x * TILE_SIZE + TILE_SIZE/2 - 8 + shakeX, y * TILE_SIZE + TILE_SIZE/2 + shakeY, 5, TILE_SIZE/2 + 4);
                    // Canopy with shadow
                    ctx.fillStyle = '#3a5941'; ctx.beginPath(); ctx.arc((x + 0.5) * TILE_SIZE + shakeX, (y + 0.4) * TILE_SIZE + shakeY, TILE_SIZE * 0.5, 0, Math.PI * 2); ctx.fill();
                    ctx.fillStyle = '#2d4828'; ctx.beginPath(); ctx.arc((x + 0.6) * TILE_SIZE + shakeX, (y + 0.5) * TILE_SIZE + shakeY, TILE_SIZE * 0.25, 0, Math.PI * 2); ctx.fill();

                    // Damage cracks
                    const tree = gameState.worldObjects[key];
                    if (tree) {
                        const healthPercent = tree.health / 10;
                        ctx.fillStyle = 'rgba(0,0,0,0.4)';
                        if (healthPercent < 0.7) {
                           ctx.fillRect(x * TILE_SIZE + 28 + shakeX, y * TILE_SIZE + 40 + shakeY, 2, 12);
                        }
                        if (healthPercent < 0.4) {
                           ctx.fillRect(x * TILE_SIZE + 22 + shakeX, y * TILE_SIZE + 50 + shakeY, 15, 2);
                        }
                    }
                    break;
                case TILES.ROCK:
                    // More complex rock shape
                    ctx.save();
                    ctx.translate(shakeX, shakeY);
                    ctx.fillStyle = '#8d8d8d'; ctx.beginPath(); ctx.moveTo((x+0.2)*TILE_SIZE, (y+0.8)*TILE_SIZE); ctx.lineTo((x+0.8)*TILE_SIZE, (y+0.8)*TILE_SIZE); ctx.lineTo((x+0.7)*TILE_SIZE, (y+0.3)*TILE_SIZE); ctx.lineTo((x+0.5)*TILE_SIZE, (y+0.2)*TILE_SIZE); ctx.closePath(); ctx.fill();
                    ctx.fillStyle = '#7a7a7a'; ctx.beginPath(); ctx.moveTo((x+0.2)*TILE_SIZE, (y+0.8)*TILE_SIZE); ctx.lineTo((x+0.4)*TILE_SIZE, (y+0.85)*TILE_SIZE); ctx.lineTo((x+0.5)*TILE_SIZE, (y+0.2)*TILE_SIZE); ctx.closePath(); ctx.fill();
                    ctx.restore();
                    
                     // Damage cracks
                    const rock = gameState.worldObjects[key];
                    if (rock) {
                        const healthPercent = rock.health / 15;
                        ctx.strokeStyle = 'rgba(0,0,0,0.4)';
                        ctx.lineWidth = 2;
                        if (healthPercent < 0.8) {
                           ctx.beginPath(); ctx.moveTo((x+0.5)*TILE_SIZE+shakeX, (y+0.2)*TILE_SIZE+shakeY); ctx.lineTo((x+0.4)*TILE_SIZE+shakeX, (y+0.6)*TILE_SIZE+shakeY); ctx.stroke();
                        }
                        if (healthPercent < 0.5) {
                           ctx.beginPath(); ctx.moveTo((x+0.7)*TILE_SIZE+shakeX, (y+0.3)*TILE_SIZE+shakeY); ctx.lineTo((x+0.8)*TILE_SIZE+shakeX, (y+0.7)*TILE_SIZE+shakeY); ctx.stroke();
                        }
                    }
                    break;
                case TILES.BERRY_BUSH:
                     ctx.fillStyle = '#2d4828'; ctx.beginPath(); ctx.arc((x + 0.5) * TILE_SIZE, (y + 0.6) * TILE_SIZE, TILE_SIZE * 0.4, 0, Math.PI * 2); ctx.fill();
                     ctx.fillStyle = '#c56183';
                     ctx.fillRect(x * TILE_SIZE + 20, y * TILE_SIZE + 32, 8, 8); ctx.fillRect(x * TILE_SIZE + 38, y * TILE_SIZE + 28, 8, 8); ctx.fillRect(x * TILE_SIZE + 25, y * TILE_SIZE + 45, 8, 8);
                    break;
                case TILES.CAMPFIRE:
                    const flicker = Math.random();
                    // Logs
                    ctx.fillStyle = '#6b4f3a'; 
                    ctx.beginPath(); ctx.moveTo((x+0.2)*TILE_SIZE, (y+0.8)*TILE_SIZE); ctx.lineTo((x+0.8)*TILE_SIZE, (y+0.8)*TILE_SIZE); ctx.lineTo((x+0.5)*TILE_SIZE, (y+0.7)*TILE_SIZE); ctx.closePath(); ctx.fill();
                    // Fire
                    ctx.fillStyle = flicker > 0.66 ? '#ff6a00' : '#ffa500'; ctx.beginPath(); ctx.moveTo((x+0.5)*TILE_SIZE, (y+0.3)*TILE_SIZE); ctx.lineTo((x+0.3)*TILE_SIZE, (y+0.75)*TILE_SIZE); ctx.lineTo((x+0.7)*TILE_SIZE, (y+0.75)*TILE_SIZE); ctx.closePath(); ctx.fill();
                    ctx.fillStyle = flicker < 0.33 ? '#ffff00' : '#ffd700'; ctx.beginPath(); ctx.moveTo((x+0.5)*TILE_SIZE, (y+0.4)*TILE_SIZE); ctx.lineTo((x+0.4)*TILE_SIZE, (y+0.7)*TILE_SIZE); ctx.lineTo((x+0.6)*TILE_SIZE, (y+0.7)*TILE_SIZE); ctx.closePath(); ctx.fill();
                    break;
                case TILES.TENT:
                    ctx.fillStyle = '#a0522d'; ctx.beginPath(); ctx.moveTo((x+0.1)*TILE_SIZE, (y+0.9)*TILE_SIZE); ctx.lineTo((x+0.5)*TILE_SIZE, (y+0.2)*TILE_SIZE); ctx.lineTo((x+0.9)*TILE_SIZE, (y+0.9)*TILE_SIZE); ctx.closePath(); ctx.fill();
                    // Tent flap
                    ctx.fillStyle = '#793d22'; ctx.beginPath(); ctx.moveTo((x+0.5)*TILE_SIZE, (y+0.25)*TILE_SIZE); ctx.lineTo((x+0.7)*TILE_SIZE, (y+0.9)*TILE_SIZE); ctx.lineTo((x+0.5)*TILE_SIZE, (y+0.9)*TILE_SIZE); ctx.closePath(); ctx.fill();
                    break;
                case TILES.STUMP: 
                    ctx.fillStyle = '#6b4f3a'; ctx.fillRect(x*TILE_SIZE+20, y*TILE_SIZE+30, 24, 20); 
                    ctx.fillStyle = '#ab8f7a'; ctx.beginPath(); ctx.ellipse(x*TILE_SIZE+32, y*TILE_SIZE+30, 14, 6, 0, 0, Math.PI*2); ctx.fill();
                    break;
                case TILES.MINED_ROCK: ctx.fillStyle = '#6a6a6a'; ctx.fillRect(x * TILE_SIZE+16, y * TILE_SIZE+32, 32, 16); break;
                case TILES.EMPTY_BUSH: ctx.fillStyle = '#2d4828'; ctx.beginPath(); ctx.arc((x + 0.5) * TILE_SIZE, (y + 0.6) * TILE_SIZE, TILE_SIZE * 0.4, 0, Math.PI * 2); ctx.fill(); break;
                 case TILES.MOONPETAL_FLOWER:
                    ctx.fillStyle = '#6a4a9c'; ctx.fillRect(x * TILE_SIZE + 30, y * TILE_SIZE + 30, 4, 20); // Stem
                    ctx.fillStyle = '#a188d9'; 
                    ctx.beginPath(); ctx.arc(x*TILE_SIZE+32, y*TILE_SIZE+28, 12, 0, Math.PI * 2); ctx.fill();
                    ctx.fillStyle = '#d4c2fc';
                    ctx.beginPath(); ctx.arc(x*TILE_SIZE+32, y*TILE_SIZE+28, 6, 0, Math.PI * 2); ctx.fill();
                    break;
                case TILES.MONOLITH:
                case TILES.MONOLITH_ACTIVATED:
                    ctx.fillStyle = tile === TILES.MONOLITH ? '#4a5568' : '#68604a';
                    ctx.fillRect(x*TILE_SIZE + 12, y*TILE_SIZE+8, 40, 48);
                    ctx.fillStyle = tile === TILES.MONOLITH ? '#2d3748' : '#4a442d';
                    ctx.fillRect(x*TILE_SIZE + 18, y*TILE_SIZE+14, 28, 36);
                    if (tile === TILES.MONOLITH_ACTIVATED) {
                        ctx.fillStyle = '#f6e05e';
                        ctx.beginPath(); ctx.arc(x * TILE_SIZE + 32, y * TILE_SIZE + 32, 8, 0, Math.PI * 2); ctx.fill();
                    }
                    break;
                case TILES.MOUNTAIN:
                    ctx.fillStyle = '#6b7280';
                    ctx.beginPath();
                    ctx.moveTo(x * TILE_SIZE, y * TILE_SIZE + TILE_SIZE);
                    ctx.lineTo(x * TILE_SIZE + TILE_SIZE * 0.5, y * TILE_SIZE + TILE_SIZE * 0.2);
                    ctx.lineTo(x * TILE_SIZE + TILE_SIZE, y * TILE_SIZE + TILE_SIZE);
                    ctx.closePath();
                    ctx.fill();
                    
                    ctx.fillStyle = '#4a5568';
                    ctx.beginPath();
                    ctx.moveTo(x * TILE_SIZE + TILE_SIZE * 0.2, y * TILE_SIZE + TILE_SIZE);
                    ctx.lineTo(x * TILE_SIZE + TILE_SIZE * 0.7, y * TILE_SIZE + TILE_SIZE * 0.4);
                    ctx.lineTo(x * TILE_SIZE + TILE_SIZE * 0.8, y * TILE_SIZE + TILE_SIZE);
                    ctx.closePath();
                    ctx.fill();
                    break;
                case TILES.WIZARD:
                    // Wizard tile is just a placeholder - the actual wizard sprite is drawn separately
                    break;
            }
        }
    }
    
    // Particle Effects
    gameState.activeAnimations.forEach(anim => {
        const progressRatio = anim.progress / anim.maxProgress;
        ctx.globalAlpha = 1 - progressRatio;
        for (let i = 0; i < 3; i++) {
            const particleX = (anim.x + 0.5) * TILE_SIZE + (Math.random() - 0.5) * 40 * (1-progressRatio);
            const particleY = (anim.y + 0.5) * TILE_SIZE + (Math.random() - 0.5) * 40 * (1-progressRatio);
            const size = (1 - progressRatio) * 8;
            if(anim.type === 'chop') {
                ctx.fillStyle = '#ab8f7a';
                ctx.fillRect(particleX, particleY, size, size);
            } else if (anim.type === 'mine') {
                ctx.fillStyle = '#a0a0a0';
                 ctx.fillRect(particleX, particleY, size, size);
            }
        }
    });
    ctx.globalAlpha = 1.0;


    // Player Drawing
    const {x, y, direction, isMoving} = gameState.player;
    const { walkCycle, toolSwing } = gameState.playerAnimation;
    const px = x * TILE_SIZE;
    const py = y * TILE_SIZE;

    let frame;
    if (toolSwing > 0) {
        const target = getTileInFront();
        const animalInFront = gameState.animals.find(a => a.x === target.x && a.y === target.y);

        if (animalInFront) {
            frame = `using_sword_${direction}`;
        } else if (target.x >= 0 && target.x < MAP_SIZE && target.y >= 0 && target.y < MAP_SIZE) {
            const targetTile = gameState.world[target.y][target.x];
            if (targetTile === TILES.ROCK && gameState.tools.pickaxe) {
                frame = `using_pickaxe_${direction}`;
            } else if (targetTile === TILES.TREE) {
                frame = `using_axe_${direction}`;
            } else {
                 frame = `standing_${direction}`;
            }
        } else {
            frame = `standing_${direction}`;
        }
    } else if (isMoving) {
        const frameNum = Math.floor(walkCycle / Math.PI) + 1;
        if ((direction === 'left' || direction === 'right')) {
            frame = `walking_${direction}_1`;
        } else {
             frame = `walking_${direction}_${frameNum}`;
        }
    } else {
        frame = `standing_${direction}`;
    }
    
    drawPlayerSprite(px, py, frame);

    gameState.animals.forEach(animal => {
        const { x, y, direction, isMoving, walkCycle, type } = animal;
        const ax = x * TILE_SIZE;
        const ay = y * TILE_SIZE;

        let frame;
        if (isMoving) {
            const frameNum = Math.floor(walkCycle / Math.PI) + 1;
            if ((direction === 'left' || direction === 'right')) {
                frame = `walking_${direction}_1`;
            } else {
                frame = `walking_${direction}_${frameNum}`;
            }
        } else {
            frame = `standing_${direction}`;
        }
        
        // Use different sprite functions based on animal type
        if (type === 'squirrel') {
            drawSquirrelSprite(ax, ay, frame);
        } else if (type === 'rabbit') {
            drawRabbitSprite(ax, ay, frame);
        } else if (type === 'bear') {
            drawBearSprite(ax, ay, frame);
        } else {
            drawAnimalSprite(ax, ay, frame);
        }
        
        // Draw pack indicators for wolves
        if (type === 'wolf' && animal.packId) {
            ctx.fillStyle = animal.isPackLeader ? '#ff6b6b' : '#ffa500';
            ctx.fillRect(ax + TILE_SIZE - 4, ay, 4, 4);
        }
        
        if(animal.lastHitTimer > 0) {
            const healthPercentage = animal.hp / animal.maxHp;
            ctx.fillStyle = '#4a4a4a';
            ctx.fillRect(ax + 8, ay, 48, 6);
            ctx.fillStyle = '#e06c75';
            ctx.fillRect(ax + 8, ay, 48 * healthPercentage, 6);
        }
    });

    // Draw Wizard NPC
    if (gameState.wizard.x > 0 && gameState.wizard.y > 0) {
        const wx = gameState.wizard.x * TILE_SIZE;
        const wy = gameState.wizard.y * TILE_SIZE;
        drawWizardSprite(wx, wy, `standing_${gameState.wizard.direction}`);
        
        // Draw speech bubble if visible
        if (gameState.wizard.speechBubble.visible) {
            drawSpeechBubble(wx, wy, gameState.wizard.speechBubble.message);
        }
    }

    if (gameState.isNight) {
        ctx.fillStyle = 'rgba(10, 10, 40, 0.5)'; ctx.fillRect(gameState.camera.x, gameState.camera.y, canvas.width, canvas.height);
    }
    
    const target = getTileInFront();
    ctx.strokeStyle = 'rgba(255, 255, 255, 0.7)';
    ctx.lineWidth = 2;
    ctx.strokeRect(target.x * TILE_SIZE + 2, target.y * TILE_SIZE + 2, TILE_SIZE - 4, TILE_SIZE - 4);

    ctx.restore();
    
    // Update mini map
    drawMiniMap();
}

function updateUI() {
    // Calculate max values with modifiers
    const maxHealth = 100 + gameState.playerModifiers.healthBonus;
    const maxEnergy = 100 + gameState.playerModifiers.energyBonus;
    
    // Update bars with modified max values
    healthBar.style.width = `${(gameState.player.health / maxHealth) * 100}%`;
    hungerBar.style.width = `${gameState.player.hunger}%`;
    energyBar.style.width = `${(gameState.player.energy / maxEnergy) * 100}%`;
    
    // Update level and XP display
    levelDisplay.textContent = gameState.level;
    xpDisplay.textContent = gameState.xp;
    
    // Update XP bar
    const xpNeeded = gameState.level * 25;
    const xpProgress = (gameState.xp / xpNeeded) * 100;
    xpBar.style.width = `${Math.min(100, xpProgress)}%`;
    
    const hour = String(gameState.time.hour).padStart(2, '0');
    const minute = String(gameState.time.minute).padStart(2, '0');
    timeDisplay.textContent = `Day ${gameState.time.day} - ${hour}:${minute}`;
    let tools = [];
    if (gameState.tools.axe) tools.push('Axe');
    if (gameState.tools.pickaxe) tools.push('Pickaxe');
    if (gameState.tools.sword) tools.push('Sword');
    toolStatusUI.textContent = tools.length > 0 ? tools.join(', ') : 'None';
    
    document.getElementById('craftAxe').disabled = gameState.inventory.wood < 15 || gameState.tools.axe;
    document.getElementById('craftPickaxe').disabled = gameState.inventory.wood < 20 || gameState.tools.pickaxe;
    document.getElementById('craftSword').disabled = gameState.inventory.wood < 25 || gameState.tools.sword;
    document.getElementById('craftCarvedStone').disabled = gameState.inventory.stone < 50;
    document.getElementById('craftCampfire').disabled = gameState.inventory.wood < 15 || gameState.inventory.stone < 5;
    document.getElementById('craftTent').disabled = gameState.inventory.wood < 20 || gameState.inventory.stone < 10;
    
    document.getElementById('eatBerry').disabled = gameState.inventory.berries <= 0;
    document.getElementById('eatCookedMeat').disabled = gameState.inventory.cookedMeat <= 0;

    const playerIsNearFire = isNearCampfire(gameState.player.x, gameState.player.y);
    document.getElementById('cookMeat').disabled = gameState.inventory.rawMeat <= 0 || !playerIsNearFire;
}


// --- Game Loop ---
let lastTime = 0;
const gameTick = 100;

function gameLoop(timestamp) {
    try {
        if (gameState.isGameOver) return;
        
        // Ensure canvas maintains focus for keyboard events
        if (document.activeElement !== canvas) {
            canvas.focus();
        }
        
        if (!gameState.paused) {
            if (gameState.player.moveCooldown > 0) {
                gameState.player.moveCooldown--;
            }
            handleInput();

            if (timestamp - lastTime > gameTick) {
                lastTime = timestamp;
                manageSpawning();
                formWolfPacks(); // Form wolf packs
                updateTime();
                updateStats();
                updateAnimals();
            }
            
            updateAnimations();
            updateCamera();
            updateUI();
            updateGameplayMessages();
            checkWizardCallout();
        }
        
        draw();
        requestAnimationFrame(gameLoop);
    } catch (error) {
        console.error("Error in gameLoop:", error);
        // Try to continue the game loop with a small delay
        setTimeout(() => {
            try {
                requestAnimationFrame(gameLoop);
            } catch (retryError) {
                console.error("Failed to restart game loop:", retryError);
            }
        }, 100);
    }
}

// --- Event Listeners and Init ---
function setupEventListeners() {
    const tabCraft = document.getElementById('tabCraft');
    const tabBasic = document.getElementById('tabBasic');
    const craftingContent = document.getElementById('craftingContent');
    const basicActionsContent = document.getElementById('basicActionsContent');

    tabCraft.addEventListener('click', () => {
        tabCraft.classList.add('active');
        tabBasic.classList.remove('active');
        craftingContent.classList.remove('hidden-tab');
        basicActionsContent.classList.add('hidden-tab');
    });

    tabBasic.addEventListener('click', () => {
        tabBasic.classList.add('active');
        tabCraft.classList.remove('active');
        basicActionsContent.classList.remove('hidden-tab');
        craftingContent.classList.add('hidden-tab');
    });
    
    startButton.addEventListener('click', () => {
        introScreen.classList.add('hidden');
        gameState.paused = false;
        logMessage("The humming of the monoliths calls to you...", "#a188d9");
    });
    
    window.addEventListener('keydown', (e) => {
        keysPressed[e.key] = true;
        if(e.key === ' '){
             e.preventDefault(); 
             interact();
        }
        if(e.key === 'm' || e.key === 'M'){
             e.preventDefault();
             toggleMiniMapFullscreen();
        }
    });
     window.addEventListener('keyup', (e) => {
        keysPressed[e.key] = false;
    });

    // Level-up card event listeners
    document.getElementById('card1').addEventListener('click', () => {
        if (gameState.levelUpCards.visible) {
            selectLevelUpCard(0);
        }
    });
    
    document.getElementById('card2').addEventListener('click', () => {
        if (gameState.levelUpCards.visible) {
            selectLevelUpCard(1);
        }
    });
    
    document.getElementById('card3').addEventListener('click', () => {
        if (gameState.levelUpCards.visible) {
            selectLevelUpCard(2);
        }
    });

    document.getElementById('craftAxe').addEventListener('click', () => {
        if (gameState.inventory.wood >= 15 && !gameState.tools.axe) {
            gameState.inventory.wood -= 15;
            gameState.tools.axe = true;
            logMessage('You crafted a simple wooden axe!', '#98c379');
        }
    });

    document.getElementById('craftPickaxe').addEventListener('click', () => {
        if (gameState.inventory.wood >= 20 && !gameState.tools.pickaxe) {
            gameState.inventory.wood -= 20;
            gameState.tools.pickaxe = true;
            logMessage('You crafted a crude wooden pickaxe!', '#98c379');
        }
    });

    document.getElementById('craftSword').addEventListener('click', () => {
        if (gameState.inventory.wood >= 25 && !gameState.tools.sword) {
            gameState.inventory.wood -= 25;
            gameState.tools.sword = true;
            logMessage('You crafted a wooden sword!', '#98c379');
        }
    });

     document.getElementById('craftCarvedStone').addEventListener('click', () => {
        if (gameState.inventory.stone >= 50) {
            gameState.inventory.stone -= 50;
            gameState.inventory.carvedStone++;
            logMessage('You carefully carved a stone effigy.', '#c7c7c7');
        }
    });

    document.getElementById('craftCampfire').addEventListener('click', () => {
        if (gameState.inventory.wood >= 15 && gameState.inventory.stone >= 5) {
            const target = getTileInFront();
            if (target.y < 0 || target.y >= MAP_SIZE || target.x < 0 || target.x >= MAP_SIZE) {
                 logMessage('Cannot build at the world\'s edge.', '#e06c75');
                 return;
            }
            if (gameState.world[target.y][target.x] === TILES.GRASS) {
                gameState.inventory.wood -= 15;
                gameState.inventory.stone -= 5;
                gameState.world[target.y][target.x] = TILES.CAMPFIRE;
                gameState.placedObjects[`${target.x},${target.y}`] = { x: target.x, y: target.y, type: TILES.CAMPFIRE };
                logMessage('You built a warm campfire.', '#e5c07b');
            } else {
                logMessage('You can only build on clear grass.', '#e06c75');
            }
        }
    });

    document.getElementById('craftTent').addEventListener('click', () => {
        if (gameState.inventory.wood >= 20 && gameState.inventory.stone >= 10) {
            const target = getTileInFront();
             if (target.y < 0 || target.y >= MAP_SIZE || target.x < 0 || target.x >= MAP_SIZE) {
                 logMessage('Cannot build at the world\'s edge.', '#e06c75');
                 return;
            }
            if (gameState.world[target.y][target.x] === TILES.GRASS) {
                gameState.inventory.wood -= 20;
                gameState.inventory.stone -= 10;
                gameState.world[target.y][target.x] = TILES.TENT;
                gameState.placedObjects[`${target.x},${target.y}`] = { x: target.x, y: target.y, type: TILES.TENT };
                logMessage('You built a tent. Sleep in it at night.', '#a0522d');
            } else {
                logMessage('You can only build on clear grass.', '#e06c75');
            }
        }
    });

    document.getElementById('eatBerry').addEventListener('click', () => {
        if (gameState.inventory.berries > 0) {
            gameState.inventory.berries--;
            gameState.player.hunger = Math.min(100, gameState.player.hunger + 10);
            logMessage("You ate a berry. (+10 Hunger)", "#c56183");
        }
    });
    
    document.getElementById('eatCookedMeat').addEventListener('click', () => {
        if (gameState.inventory.cookedMeat > 0) {
            gameState.inventory.cookedMeat--;
            gameState.player.hunger = Math.min(100, gameState.player.hunger + 40);
            gameState.player.health = Math.min(100, gameState.player.health + 10);
            logMessage("You ate cooked meat. (+40 Hunger, +10 Health)", "#e5c07b");
        }
    });

    document.getElementById('cookMeat').addEventListener('click', () => {
         if (gameState.inventory.rawMeat > 0 && isNearCampfire(gameState.player.x, gameState.player.y)) {
             gameState.inventory.rawMeat--;
             gameState.inventory.cookedMeat++;
             logMessage("You cooked some meat over the fire.", "#e5c07b");
         }
    });
    
    window.addEventListener('resize', resizeCanvas);
    
    // Ensure canvas regains focus when clicked
    canvas.addEventListener('click', () => {
        canvas.focus();
    });
    
    // Ensure canvas maintains focus when window regains focus
    window.addEventListener('focus', () => {
        canvas.focus();
    });
    
    // Mini map click functionality
    miniMap.addEventListener('click', (e) => {
        const rect = miniMap.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        const miniMapSize = gameState.miniMapFullscreen ? 400 : 120;
        const scale = miniMapSize / MAP_SIZE;
        
        const worldX = Math.floor(x / scale);
        const worldY = Math.floor(y / scale);
        
        if (worldX >= 0 && worldX < MAP_SIZE && worldY >= 0 && worldY < MAP_SIZE) {
            // Move camera to clicked location
            gameState.camera.x = worldX * TILE_SIZE - canvas.width / 2 + TILE_SIZE / 2;
            gameState.camera.y = worldY * TILE_SIZE - canvas.height / 2 + TILE_SIZE / 2;
            
            // Clamp camera to world bounds
            const maxX = MAP_SIZE * TILE_SIZE - canvas.width;
            const maxY = MAP_SIZE * TILE_SIZE - canvas.height;
            gameState.camera.x = Math.max(0, Math.min(gameState.camera.x, maxX));
            gameState.camera.y = Math.max(0, Math.min(gameState.camera.y, maxY));
        }
    });
    
    // Chat History functionality
    const chatHistoryButton = document.getElementById('chatHistoryButton');
    const chatHistoryModal = document.getElementById('chatHistoryModal');
    const closeChatHistory = document.getElementById('closeChatHistory');
    const chatHistoryContent = document.getElementById('chatHistoryContent');
    
    chatHistoryButton.addEventListener('click', () => {
        // Populate chat history content
        chatHistoryContent.innerHTML = '';
        gameState.gameplayMessages.forEach(msg => {
            const div = document.createElement('div');
            div.textContent = `> ${msg.message}`;
            div.style.color = msg.color;
            div.style.marginBottom = '4px';
            chatHistoryContent.appendChild(div);
        });
        
        // Show modal
        chatHistoryModal.classList.remove('hidden');
    });
    
    closeChatHistory.addEventListener('click', () => {
        chatHistoryModal.classList.add('hidden');
    });
    
    // Close modal when clicking outside
    chatHistoryModal.addEventListener('click', (e) => {
        if (e.target === chatHistoryModal) {
            chatHistoryModal.classList.add('hidden');
        }
    });
    
    // Backpack functionality
    const backpackButton = document.getElementById('backpackButton');
    const backpackModal = document.getElementById('backpackModal');
    const closeBackpack = document.getElementById('closeBackpack');
    
    backpackButton.addEventListener('click', () => {
        updateBackpack(); // Update the backpack content
        backpackModal.classList.remove('hidden');
    });
    
    closeBackpack.addEventListener('click', () => {
        backpackModal.classList.add('hidden');
    });
    
    // Close backpack modal when clicking outside
    backpackModal.addEventListener('click', (e) => {
        if (e.target === backpackModal) {
            backpackModal.classList.add('hidden');
        }
    });
}

function resizeCanvas() { 
    const parent = canvas.parentElement; 
    const newWidth = parent.clientWidth;
    const newHeight = parent.clientHeight;
    
    canvas.width = newWidth;
    canvas.height = newHeight;

    viewportTileCountX = Math.ceil(newWidth / TILE_SIZE);
    viewportTileCountY = Math.ceil(newHeight / TILE_SIZE);
}

// Initialize game when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    try {
        // Generate world and spawn initial animals
        generateWorld();
        spawnInitialAnimals(); // Spawn initial animals at game start
        
        // Setup game systems
        resizeCanvas();
        setupEventListeners();
        updateMiniMapOverlay(); // Initialize minimap overlay styling
        
        // Start the game loop first
        requestAnimationFrame(gameLoop);
        
        // Ensure canvas has focus for keyboard events after everything is set up
        setTimeout(() => {
            canvas.focus();
        }, 100);
    } catch (error) {
        console.error("Error during game initialization:", error);
        alert("Game failed to initialize. Please refresh the page.");
    }
});

</script>
</body>
</html>



